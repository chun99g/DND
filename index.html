<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>RPG Engine V39.6 (Grid & Snap)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #bb86fc; --success: #03dac6; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        .app-container { display: flex; height: 100%; }
        .sidebar { width: 450px; background: #181818; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

        /* 3D èˆå° */
        #dice-stage { width: 100%; height: 500px; background: #2a2a2a; position: relative; overflow: hidden; border-bottom: 1px solid #333; cursor: pointer; }
        
        #instruction-overlay { 
            position: absolute; bottom: 10px; width: 100%; text-align: center; 
            color: rgba(255,255,255,0.4); font-size: 12px; pointer-events: none; 
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* é ‚éƒ¨ ROLL æŒ‰éˆ• */
        #roll-section {
            padding: 15px; background: #222; border-bottom: 1px solid #444; text-align: center;
        }
        #roll-btn {
            width: 100%; padding: 15px; background: var(--accent); color: #000;
            border: none; border-radius: 8px; font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 10px rgba(187, 134, 252, 0.3);
            transition: 0.2s;
        }
        #roll-btn:active { transform: scale(0.98); background: #a370db; }
        #roll-btn:disabled { background: #555; color: #888; cursor: not-allowed; }

        .panel-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px; }
        
        /* éª°å­é¸æ“‡å€ */
        .dice-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .d-btn { 
            height: 45px; border: none; border-radius: 6px; color: white; font-weight: bold; 
            cursor: pointer; font-size: 14px; background: #333; 
            box-shadow: 0 2px 0 rgba(0,0,0,0.4); transition: all 0.1s; 
        }
        .d-btn:active { transform: translateY(2px); box-shadow: none; }
        .d-btn:hover { background: #444; }
        
        /* å½©è‰²è£é£¾ */
        .btn-d4 { border-left: 4px solid #0F9D58; } .btn-d6 { border-left: 4px solid #4285F4; } 
        .btn-d8 { border-left: 4px solid #9E00FF; } .btn-d10 { border-left: 4px solid #0097A7; } 
        .btn-d12 { border-left: 4px solid #DB4437; } .btn-d20 { border-left: 4px solid #F4B400; }

        /* UI å¡ç‰‡ */
        .card { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .card-header { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 10px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        /* ç‹€æ…‹æ¢ */
        .bar-wrap { background: #333; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 4px; }
        .bar-fill { height: 100%; transition: width 0.5s ease; }
        .stat-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        
        /* èŠå¤©èˆ‡è¼¸å…¥ */
        .header-bar { padding: 10px 20px; background: #181818; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #aaa; }
        .chat-log { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; font-size: 15px; line-height: 1.6; padding-bottom: 100px; }
        .msg { margin-bottom: 20px; max-width: 90%; padding: 12px 16px; border-radius: 8px; animation: fadeIn 0.3s; }
        .msg.gm { background: #252525; border-left: 4px solid var(--accent); color: #ddd; }
        .msg.user { background: #3d2c5e; color: #fff; margin-left: auto; text-align: right; }
        
        .options-container { padding: 10px 15px; background: #181818; display: flex; flex-wrap: wrap; gap: 8px; border-top: 1px solid #333; }
        .opt-btn { background: #2a2a2a; color: #bbb; border: 1px solid #444; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .opt-btn:hover { background: #333; color: var(--accent); border-color: var(--accent); }

        .input-area { padding: 15px; background: #181818; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; background: #252525; border: 1px solid #444; color: white; border-radius: 24px; outline: none; padding-left: 20px; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; color: #000; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* Modal & å±¬æ€§ç·¨è¼¯å™¨ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #252525; width: 450px; padding: 30px; border-radius: 12px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-btn { width: 100%; padding: 12px; background: var(--accent); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .attr-main { text-align: center; background: #2a2a2a; padding: 5px; border-radius: 4px; }
        .attr-val { font-size: 18px; font-weight: bold; color: var(--accent); }
        .attr-mod { font-size: 12px; color: var(--success); font-weight: bold; }
        .attr-lbl { font-size: 12px; color: #aaa; }

        .attr-edit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .attr-edit-box { background: #2a2a2a; padding: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .attr-ctrl { display: flex; align-items: center; gap: 5px; }
        .attr-btn { width: 20px; height: 20px; border-radius: 50%; border: none; background: #444; color: #fff; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;}
        .range-input { width: 60px; background: #111; border: 1px solid #444; color: #fff; text-align: center; padding: 4px; border-radius: 4px; }

        .hidden { display: none !important; }
        
        /* Debug Log */
        #debug-log { position: absolute; top: 10px; left: 10px; color: #81c995; background: rgba(0,0,0,0.8); padding: 5px; font-size: 11px; pointer-events: none; border-radius: 4px; opacity: 0; transition: opacity 0.5s; }
        #debug-log.show { opacity: 1; }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal">
        <div class="modal-box">
            <h2 style="color:var(--accent); margin-top:0;">ğŸš€ RPG Engine V39.6</h2>
            <p style="color:#aaa; font-size:12px;">é›»å­éª°ç›¤ï¼šè‡ªå‹•æ•´éšŠ & å¹³é¢é–å®š</p>
            <p>è«‹è¼¸å…¥ä¸–ç•Œè§€ï¼š</p>
            <textarea id="world-prompt" rows="3" style="width:100%; background:#111; color:#fff; border:1px solid #444; padding:10px; border-radius:4px;" placeholder="ä¾‹å¦‚ï¼šé¾èˆ‡åœ°ä¸‹åŸ D&D 5eï¼Œè²»å€«å¤§é™¸..."></textarea>
            <button class="modal-btn" onclick="startCharacterCreation()">ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆè§’è‰²</button>
            <div style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
                <p style="font-size:12px; color:#aaa;">è®€å–å­˜æª”ï¼š</p>
                <input type="text" id="load-code" placeholder="å­˜æª”ç¢¼..." style="width:100%; padding:8px; background:#111; border:1px solid #444; color:#fff; margin-bottom:5px;">
                <button class="modal-btn" style="background:#444; color:#fff; margin-top:0;" onclick="loadFromCode()">è®€å–</button>
            </div>
        </div>
    </div>

    <div id="char-modal" class="modal hidden">
        <div class="modal-box">
            <h2 style="color:var(--success); margin-top:0;">ğŸ² å±¬æ€§ç”Ÿæˆ (D&D 5e)</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span style="color:#aaa; font-size:13px;">å±¬æ€§ç¸½å’Œç¯„åœï¼š</span>
                <div><input type="number" id="stat-min" class="range-input" value="72"> - <input type="number" id="stat-max" class="range-input" value="80"></div>
            </div>
            <div id="char-stats-editor" class="attr-edit-grid" style="margin: 20px 0;"></div>
            <div style="background:#111; padding:10px; border-radius:4px; font-size:13px; color:#aaa; margin-bottom:15px; text-align:center;">
                <div id="derived-stats">è¨ˆç®—ä¸­...</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="modal-btn" style="background:#444; color:#fff;" onclick="randomizeStats()">ğŸ² åˆ†é…é‡æ“²</button>
                <button class="modal-btn" onclick="confirmStart()">âœ… é–‹å§‹å†’éšª</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <div id="roll-section">
                <button id="roll-btn" onclick="rollAll()">ğŸ² æ“²éª° (ROLL ALL)</button>
            </div>

            <div id="dice-stage">
                <div id="debug-log">Loading...</div>
                <div id="instruction-overlay">é»æ“Šéª°å­ä»¥ç§»é™¤ (CLICK DICE TO REMOVE)</div>
            </div>
            
            <div class="panel-content">
                <div class="card">
                    <div class="card-header">æ–°å¢éª°å­ (ADD DICE)</div>
                    <div class="dice-btn-grid">
                        <button class="d-btn btn-d4" onclick="addDice(4)">+ D4</button>
                        <button class="d-btn btn-d6" onclick="addDice(6)">+ D6</button>
                        <button class="d-btn btn-d8" onclick="addDice(8)">+ D8</button>
                        <button class="d-btn btn-d10" onclick="addDice(10)">+ D10</button>
                        <button class="d-btn btn-d12" onclick="addDice(12)">+ D12</button>
                        <button class="d-btn btn-d20" onclick="addDice(20)">+ D20</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ç‹€æ…‹</div>
                    <div class="stat-row"><span>HP</span> <span id="hp-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="hp-bar" class="bar-fill" style="width:100%; background:#cf6679;"></div></div>
                    <div class="stat-row"><span id="mp-label">MP</span> <span id="mp-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="mp-bar" class="bar-fill" style="width:100%; background:#03dac6;"></div></div>
                    <div class="stat-row"><span>SAN</span> <span id="san-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="san-bar" class="bar-fill" style="width:100%; background:#bb86fc;"></div></div>
                </div>
                
                <div class="card">
                    <div class="card-header">å±¬æ€§</div>
                    <div class="attr-grid">
                        <div class="attr-main"><div class="attr-lbl">STR</div><div id="disp-str"></div></div>
                        <div class="attr-main"><div class="attr-lbl">DEX</div><div id="disp-dex"></div></div>
                        <div class="attr-main"><div class="attr-lbl">CON</div><div id="disp-con"></div></div>
                        <div class="attr-main"><div class="attr-lbl">INT</div><div id="disp-int"></div></div>
                        <div class="attr-main"><div class="attr-lbl">WIS</div><div id="disp-wis"></div></div>
                        <div class="attr-main"><div class="attr-lbl">CHA</div><div id="disp-cha"></div></div>
                    </div>
                </div>
                <div class="card" style="flex:1"><div class="card-header">ç‰©å“</div><div id="inv-list" style="font-size:13px; color:#aaa;">ç„¡</div></div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="header-bar">
                <div class="header-info">
                    <span id="location-display"><i class="fas fa-map-marker-alt"></i> è™›ç©º</span>
                    <span id="time-display">åˆå§‹</span>
                </div>
                <div><button class="menu-btn" onclick="saveToCode()">ğŸ’¾</button><button class="menu-btn" onclick="resetGame()" style="color:#f55; margin-left:5px;">ğŸ—‘ï¸</button></div>
            </div>
            <div id="chat-log" class="chat-log"><div class="msg gm">ç³»çµ±å°±ç·’ã€‚è«‹æ–°å¢éª°å­ä¸¦æŒ‰ä¸‹æ“²éª°ã€‚</div></div>
            <div id="options-area" class="options-container"></div>
            <div class="input-area"><input type="text" id="user-input" placeholder="è¼¸å…¥è¡Œå‹•..." autocomplete="off"><button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button></div>
        </main>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        window.USER_API_KEY = ""; 
        
        const GLB_FILES = {
            4:  "./d4_low.glb",
            6:  "./d6_low.glb",
            8:  "./d8_low.glb",
            10: "./d10_low.glb",
            12: "./d12_low.glb",
            20: "./d20_low.glb"
        };

        // --- 3D æ ¸å¿ƒè®Šæ•¸ ---
        let scene, camera, renderer;
        let loadedModels = {}; 
        let diceList = []; // å­˜æ”¾å ´æ™¯ä¸­çš„éª°å­ç‰©ä»¶
        let raycaster, mouse;
        let isRolling = false;

        // æ ¼å­è¨­å®š
        const GRID_GAP_X = 5;
        const GRID_GAP_Z = 5;
        const MAX_PER_ROW = 2;

        function init3D() {
            const container = document.getElementById('dice-stage');
            const debugLog = document.getElementById('debug-log');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            
            // ç‡ˆå…‰ç³»çµ±ï¼šå…¨æ–¹ä½æ‰“äº®ï¼Œé¿å…æ­»è§’
            const amb = new THREE.AmbientLight(0xffffff, 1.2);
            scene.add(amb);
            const topLight = new THREE.DirectionalLight(0xffffff, 2.0);
            topLight.position.set(0, 20, 0);
            scene.add(topLight);
            const sideLight = new THREE.DirectionalLight(0xffeebb, 0.8);
            sideLight.position.set(10, 5, 10);
            scene.add(sideLight);

            // æ”å½±æ©Ÿï¼šæ­£ä¸Šæ–¹ä¿¯è¦– (Top-Down)
            camera = new THREE.PerspectiveCamera(35, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(0, 30, 0); 
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            container.addEventListener('pointerdown', onDiceClick);

            // è¼‰å…¥æ¨¡å‹
            const loader = new GLTFLoader();
            debugLog.innerText = "è¼‰å…¥æ¨¡å‹åº«...";
            debugLog.classList.add('show');

            let loadCount = 0;
            const total = Object.keys(GLB_FILES).length;

            for (let sides in GLB_FILES) {
                loader.load(GLB_FILES[sides], (gltf) => {
                    const model = gltf.scene;
                    
                    // Auto-Fit & Scale
                    const box = new THREE.Box3().setFromObject(model);
                    const size = box.getSize(new THREE.Vector3());
                    const center = box.getCenter(new THREE.Vector3());
                    model.position.sub(center); // æ­¸é›¶

                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scaleFactor = 4.0 / maxDim; // çµ±ä¸€æ”¾å¤§
                    model.scale.set(scaleFactor, scaleFactor, scaleFactor);

                    // æè³ªå„ªåŒ–ï¼šè®“æ–‡å­—æ›´æ¸…æ¥š
                    model.traverse((child) => {
                        if (child.isMesh) {
                            if(child.material) {
                                child.material.roughness = 0.5;
                                child.material.metalness = 0.0; // æ¸›å°‘é‡‘å±¬åå…‰
                                child.material.side = THREE.DoubleSide;
                                // å¼·åˆ¶æ›´æ–°å¹¾ä½•é«”ï¼Œä¾›å¾ŒçºŒè¨ˆç®—é¢æ³•ç·šä½¿ç”¨
                                if (child.geometry && !child.geometry.attributes.normal) {
                                    child.geometry.computeVertexNormals();
                                }
                            }
                        }
                    });

                    loadedModels[sides] = model;
                    loadCount++;
                    if(loadCount === total) {
                        debugLog.innerText = "READY";
                        setTimeout(() => debugLog.classList.remove('show'), 1000);
                    }
                });
            }

            animate();
        }

        // --- é»æ“Šåˆªé™¤é‚è¼¯ ---
        function onDiceClick(event) {
            if (isRolling) return; // æ»¾å‹•ä¸­ä¸å¯é»æ“Š

            const container = document.getElementById('dice-stage');
            const rect = container.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / container.clientWidth) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / container.clientHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            
            // æ‰¾å‡ºæ‰€æœ‰éª°å­ Group (å› ç‚º loadedModels æ˜¯ Group)
            // æˆ‘å€‘éœ€è¦ traverse æ‰¾åˆ° Group å±¤ç´š
            const interactableObjects = [];
            diceList.forEach(d => {
                d.mesh.traverse(child => {
                    if(child.isMesh) {
                        child.userData.parentGroup = d.mesh; // æ¨™è¨˜çˆ¶å±¤
                        interactableObjects.push(child);
                    }
                });
            });

            const intersects = raycaster.intersectObjects(interactableObjects);

            if (intersects.length > 0) {
                const hitMesh = intersects[0].object;
                const targetGroup = hitMesh.userData.parentGroup;
                
                if (targetGroup) {
                    removeDice(targetGroup);
                }
            }
        }

        // --- æ–°å¢éª°å­ ---
        window.addDice = function(sides) {
            if (!loadedModels[sides]) return;
            if (isRolling) return;

            const template = loadedModels[sides];
            const newDice = template.clone();
            
            // åˆå§‹åŒ–æ—‹è½‰ (éš¨æ©Ÿé¢æœä¸Š)
            newDice.rotation.set(Math.random()*Math.PI*2, Math.random()*Math.PI*2, Math.random()*Math.PI*2);
            
            // ç¢ºä¿æœ‰å¹¾ä½•è³‡æ–™ä¾›å¾ŒçºŒè²¼åœ°è¨ˆç®—
            newDice.userData.sides = sides;
            
            scene.add(newDice);
            diceList.push({ mesh: newDice, sides: sides });
            
            // ç«‹å³åŸ·è¡Œä¸€æ¬¡è²¼åœ°å°é½Šï¼Œé¿å…å‰›ç”Ÿå‡ºä¾†æ˜¯æ­ªçš„
            snapToNearestFace(newDice);
            
            repositionDice();
        };

        function removeDice(diceGroup) {
            scene.remove(diceGroup);
            diceList = diceList.filter(d => d.mesh !== diceGroup);
            repositionDice();
        }

        // --- è‡ªå‹•æ’éšŠ (Grid Layout) ---
        function repositionDice() {
            diceList.forEach((dice, index) => {
                const row = Math.floor(index / MAX_PER_ROW);
                const col = index % MAX_PER_ROW;

                // è¨ˆç®—ä½ç½® (ç½®ä¸­ä½ç§»)
                // å…©æ¬„æ¨¡å¼ä¸‹ï¼šå·¦é‚Š col=0, å³é‚Š col=1
                // æˆ‘å€‘å¸Œæœ›æ•´é«”ç½®ä¸­ã€‚
                // ç¸½å¯¬åº¦ç´„ = (MAX_PER_ROW - 1) * GAP
                // èµ·é» x = -ç¸½å¯¬åº¦ / 2
                
                const totalW = (MAX_PER_ROW - 1) * GRID_GAP_X;
                const startX = -totalW / 2;
                
                const tx = startX + col * GRID_GAP_X;
                const tz = -5 + row * GRID_GAP_Z; // å¾ z=-5 é–‹å§‹å¾€ä¸‹æ’

                dice.mesh.position.set(tx, 0, tz);
            });
        }

        // --- æ“²éª°åŠŸèƒ½ (ROLL ALL) ---
        window.rollAll = function() {
            if (diceList.length === 0 || isRolling) return;

            isRolling = true;
            document.getElementById('roll-btn').disabled = true;

            // 1. ç˜‹ç‹‚æ—‹è½‰å‹•ç•« (1ç§’)
            const duration = 1000;
            const startTime = Date.now();

            function rollLoop() {
                const now = Date.now();
                const elapsed = now - startTime;
                
                if (elapsed < duration) {
                    diceList.forEach(d => {
                        d.mesh.rotation.x += 0.3;
                        d.mesh.rotation.y += 0.4;
                        d.mesh.rotation.z += 0.2;
                    });
                    requestAnimationFrame(rollLoop);
                } else {
                    // 2. åœæ­¢ä¸¦è²¼åœ° (Snap to Floor)
                    diceList.forEach(d => {
                        snapToNearestFace(d.mesh);
                    });
                    
                    isRolling = false;
                    document.getElementById('roll-btn').disabled = false;
                }
            }
            rollLoop();
        };

        // --- â˜…â˜…â˜… æ ¸å¿ƒæ¼”ç®—æ³•ï¼šè²¼åœ°å°é½Š (Face Snapping) â˜…â˜…â˜… ---
        // é€™å€‹å‡½å¼æœƒå°‹æ‰¾éª°å­ã€Œæœä¸‹ã€çš„é¢ï¼Œä¸¦æ—‹è½‰æ•´å€‹éª°å­ï¼Œè®“é‚£å€‹é¢ã€Œçµ•å°æ°´å¹³ã€ã€‚
        function snapToNearestFace(object) {
            // 1. å–å¾—æ‰€æœ‰ Mesh (æœ‰äº› glb æ˜¯ç”±å¤šå€‹ mesh çµ„æˆ)
            let meshes = [];
            object.traverse(c => { if(c.isMesh) meshes.push(c); });
            if(meshes.length === 0) return;

            // é€™è£¡ç°¡åŒ–è™•ç†ï¼šå–ç¬¬ä¸€å€‹ä¸»è¦ Mesh ä¾†åšè¨ˆç®—
            const mesh = meshes[0];
            const geometry = mesh.geometry;
            
            // ç¢ºä¿æœ‰æ³•ç·šè³‡æ–™
            if (!geometry.attributes.normal) geometry.computeVertexNormals();

            const positionAttribute = geometry.attributes.position;
            const normalAttribute = geometry.attributes.normal;
            const indexAttribute = geometry.index; // ç¶²æ ¼ç´¢å¼•

            // ä¸–ç•Œåº§æ¨™ä¸‹çš„ã€Œæ­£ä¸‹æ–¹ã€å‘é‡
            const down = new THREE.Vector3(0, -1, 0);
            
            let bestFaceNormal = new THREE.Vector3();
            let maxDot = -Infinity;

            // 2. éæ­·æ‰€æœ‰é¢ (Face)ï¼Œæ‰¾å‡ºæ³•ç·šæœ€æ¥è¿‘ (0,-1,0) çš„é‚£å€‹é¢
            // é€™é‚Šç”¨éš¨æ©Ÿæ¡æ¨£æˆ–éæ­·æ‰€æœ‰é¢ã€‚ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘éæ­·æ‰€æœ‰é¢ã€‚
            
            // çŸ©é™£è½‰æ›ï¼šæŠŠå±€éƒ¨æ³•ç·šè½‰ç‚ºä¸–ç•Œæ³•ç·š
            const normalMatrix = new THREE.Matrix3().getNormalMatrix(mesh.matrixWorld);

            if (indexAttribute) {
                // æœ‰ç´¢å¼•çš„å¹¾ä½•é«”
                for (let i = 0; i < indexAttribute.count; i += 3) {
                    const a = indexAttribute.getX(i);
                    const b = indexAttribute.getX(i+1);
                    const c = indexAttribute.getX(i+2);
                    
                    // å–å¾—é¢çš„æ³•ç·š (ç°¡å–®å–å…¶ä¸­ä¸€å€‹é ‚é»çš„æ³•ç·šï¼Œæˆ–æ˜¯è¨ˆç®—ä¸‰è§’é¢æ³•ç·š)
                    // è¨ˆç®—ä¸‰è§’é¢æ³•ç·šæ¯”è¼ƒæº–ç¢º
                    const vA = new THREE.Vector3().fromBufferAttribute(positionAttribute, a);
                    const vB = new THREE.Vector3().fromBufferAttribute(positionAttribute, b);
                    const vC = new THREE.Vector3().fromBufferAttribute(positionAttribute, c);
                    
                    // Face Normal calculation
                    const cb = new THREE.Vector3().subVectors(vC, vB);
                    const ab = new THREE.Vector3().subVectors(vA, vB);
                    const faceNormal = new THREE.Vector3().crossVectors(cb, ab).normalize();
                    
                    // è½‰åˆ°ä¸–ç•Œåº§æ¨™
                    faceNormal.applyMatrix3(normalMatrix).normalize();

                    const dot = faceNormal.dot(down);
                    if (dot > maxDot) {
                        maxDot = dot;
                        bestFaceNormal.copy(faceNormal);
                    }
                }
            } else {
                // ç„¡ç´¢å¼• (Non-indexed)ï¼Œæ¯3å€‹é»ä¸€çµ„
                const count = positionAttribute.count;
                for (let i = 0; i < count; i += 3) {
                    const vA = new THREE.Vector3().fromBufferAttribute(positionAttribute, i);
                    const vB = new THREE.Vector3().fromBufferAttribute(positionAttribute, i+1);
                    const vC = new THREE.Vector3().fromBufferAttribute(positionAttribute, i+2);
                    
                    const cb = new THREE.Vector3().subVectors(vC, vB);
                    const ab = new THREE.Vector3().subVectors(vA, vB);
                    const faceNormal = new THREE.Vector3().crossVectors(cb, ab).normalize();
                    
                    faceNormal.applyMatrix3(normalMatrix).normalize();

                    const dot = faceNormal.dot(down);
                    if (dot > maxDot) {
                        maxDot = dot;
                        bestFaceNormal.copy(faceNormal);
                    }
                }
            }

            // 3. è¨ˆç®—æ—‹è½‰ä¿®æ­£
            // æˆ‘å€‘éœ€è¦æŠŠ object æ—‹è½‰ï¼Œä½¿å¾— bestFaceNormal è®Šæˆ (0, -1, 0)
            // ä½¿ç”¨ Quaternion ä¾†æ—‹è½‰
            
            // æ³¨æ„ï¼šbestFaceNormal æ˜¯ç›®å‰çš„ä¸–ç•Œæ³•ç·šã€‚
            // æˆ‘å€‘æƒ³è¦è½‰å‹• objectï¼Œè®“é€™å€‹æ³•ç·šå°é½Š downã€‚
            const quaternion = new THREE.Quaternion().setFromUnitVectors(bestFaceNormal, down);
            
            // æ‡‰ç”¨æ—‹è½‰ (åœ¨ä¸–ç•Œåº§æ¨™ä¸­)
            object.applyQuaternion(quaternion);
            
            // 4. å°é½Šä¹‹å¾Œï¼ŒD4 é€™ç¨®è§’éŒé«”å¯èƒ½æœƒçœ‹èµ·ä¾†æ˜¯ã€Œå€’è‘—ã€çš„ (å°–ç«¯æœä¸‹) é‚„æ˜¯ã€Œæ­£çš„ã€ï¼Ÿ
            // æ¼”ç®—æ³•æ˜¯æŠŠã€Œé¢ã€è²¼åœ°ï¼Œæ‰€ä»¥ D4 æœƒæ˜¯å¹³é¢æœä¸‹ï¼Œå°–ç«¯æœä¸Šï¼Œé€™ç¬¦åˆç‰©ç†ã€‚
            // D20ã€D12 ç­‰ä¹Ÿæ˜¯é¢æœä¸‹ï¼Œå°é¢çš„æ•¸å­—æœä¸Šã€‚
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        init3D();
    </script>

    <script>
        // --- æ—¢æœ‰ RPG é‚è¼¯ (ä¿æŒä¸è®Š) ---
        let confirmedModel = ""; 
        let conversationHistory = []; 
        let state = { hp: 10, maxHp: 10, mp: 10, maxMp: 10, mpLabel: "MP", san: 100, maxSan: 100, stats: { str:10, dex:10, con:10, int:10, wis:10, cha:10 }, inventory: [], npcs: [], time: "åˆå§‹", weather: "æœªçŸ¥", location: "èµ·å§‹é»", worldPrompt: "" };

        window.onload = function() {
            const cachedKey = localStorage.getItem('my_gemini_key_v1');
            if (cachedKey) window.USER_API_KEY = cachedKey;

            const saved = localStorage.getItem('rpg_autosave_v39_1');
            if (saved && confirm("åµæ¸¬åˆ°å­˜æª”ï¼Œè¦ç¹¼çºŒå—ï¼Ÿ")) loadGameData(JSON.parse(saved));
        };

        function startCharacterCreation() {
            state.worldPrompt = document.getElementById('world-prompt').value.trim() || "D&D 5e";
            if(!window.USER_API_KEY) {
                const inputKey = prompt("è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key:", "");
                if(inputKey) {
                    window.USER_API_KEY = inputKey;
                    localStorage.setItem('my_gemini_key_v1', inputKey);
                } else {
                    alert("éœ€è¦ API Key æ‰èƒ½é‹ä½œå–”ï¼");
                    return;
                }
            }
            randomizeStats();
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('char-modal').classList.remove('hidden');
        }

        function randomizeStats() {
            let min = parseInt(document.getElementById('stat-min').value)||72, max = parseInt(document.getElementById('stat-max').value)||80;
            if (min>max) [min,max]=[max,min];
            const target = Math.floor(Math.random()*(max-min+1))+min;
            const keys=['str','dex','con','int','wis','cha'];
            keys.forEach(k=>state.stats[k]=3);
            let pts = target - 18;
            while(pts>0){ const k=keys[Math.floor(Math.random()*6)]; if(state.stats[k]<18){state.stats[k]++; pts--;} }
            renderStatEditor(target);
        }

        function adjustStat(k, d) { state.stats[k]+=d; renderStatEditor(); }
        function getMod(v) { return Math.floor((v-10)/2); }
        function getModStr(v) { const m=getMod(v); return m>=0?`+${m}`:`${m}`; }

        function renderStatEditor(sum) {
            if(!sum) sum=Object.values(state.stats).reduce((a,b)=>a+b,0);
            let h=''; const map={str:'åŠ›é‡',dex:'æ•æ·',con:'é«”è³ª',int:'æ™ºåŠ›',wis:'æ„ŸçŸ¥',cha:'é­…åŠ›'};
            for(let k in state.stats){
                h+=`<div class="attr-edit-box"><div class="attr-lbl">${map[k]}</div><div class="attr-ctrl"><button class="attr-btn" onclick="adjustStat('${k}',-1)">-</button><div class="attr-val">${state.stats[k]}</div><button class="attr-btn" onclick="adjustStat('${k}',1)">+</button></div><div style="font-size:12px;color:var(--success);">${getModStr(state.stats[k])}</div></div>`;
            }
            document.getElementById('char-stats-editor').innerHTML=h;
            state.maxHp=10+getMod(state.stats.con); state.hp=state.maxHp;
            state.maxMp=Math.max(0,getMod(state.stats.int)+1); state.mp=state.maxMp;
            document.getElementById('derived-stats').innerHTML=`ç¸½å’Œ: ${sum} | HP: ${state.maxHp}`;
        }

        async function confirmStart() {
            document.getElementById('char-modal').classList.add('hidden');
            updateUI();
            addMsg("sys","ä¸–ç•Œæ§‹å»ºä¸­...");
            await detectModelAndStart();
        }

        async function detectModelAndStart() {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${window.USER_API_KEY}`);
                const data = await res.json();
                const m = (data.models||[]).find(x=>x.name.includes("gemini-1.5-flash")||x.name.includes("gemini-pro"));
                if(!m) throw new Error("API Key ç„¡æ•ˆæˆ–é¡åº¦ä¸è¶³");
                confirmedModel = m.name.replace("models/","");
                
                const sysPrompt = `ä½ æ˜¯ä¸€ä½ D&D 5e DMã€‚
                ã€è¦å‰‡ã€‘
                1. ç¦æ­¢å®¢å¥—é–‹å ´ï¼Œç›´æ¥æå¯«å ´æ™¯ (In Media Res)ã€‚
                2. æª¢å®šå¿…é ˆè¨»æ˜éª°å­é¡å‹ (è«‹æ“² D20)ã€‚
                3. å¿…é ˆé™„ä¸Šèª¿æ•´å€¼æç¤ºã€‚
                4. çµå°¾æä¾› A/B/C é¸é …ã€‚
                ã€å±¬æ€§ã€‘${JSON.stringify(state.stats)}
                ã€JSONã€‘å›æ‡‰çµå°¾é™„å¸¶: \`\`\`json {"hp_change":0, "mp_change":0, "san_change":0, "mp_label":"æ³•è¡“ä½", "time":"...", "weather":"...", "location":"...", "add_item":"", "remove_item":"", "add_npc":"", "story_options":["A...","B..."]} \`\`\``;
                
                conversationHistory = [{role:"user", parts:[{text:sysPrompt}]}, {role:"model", parts:[{text:"..."}]}];
                await callAI(`ä¸–ç•Œè§€ï¼š${state.worldPrompt}ã€‚è«‹ç›´æ¥é–‹å§‹ã€‚`);
            } catch(e) { alert("å•Ÿå‹•å¤±æ•—: " + e.message); }
        }

        async function callAI(txt) {
            const log = document.getElementById('chat-log');
            log.innerHTML += `<div id="load-anim" class="msg gm">...</div>`; log.scrollTop=log.scrollHeight;
            conversationHistory.push({role:"user", parts:[{text:txt}]});
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${confirmedModel}:generateContent?key=${window.USER_API_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:conversationHistory})
                });
                const data = await res.json();
                document.getElementById('load-anim').remove();
                const aiTxt = data.candidates[0].content.parts[0].text;
                conversationHistory.push({role:"model", parts:[{text:aiTxt}]});
                processAIResponse(aiTxt);
            } catch(e) { document.getElementById('load-anim')?.remove(); addMsg("sys","Error: è«‹æª¢æŸ¥ç¶²è·¯æˆ– Key"); }
        }

        function processAIResponse(txt) {
            const json = txt.match(/```json\s*([\s\S]*?)\s*```/);
            if(json) {
                try {
                    const u = JSON.parse(json[1]);
                    if(u.hp_change) state.hp=Math.max(0,Math.min(state.maxHp,state.hp+u.hp_change));
                    if(u.time) state.time=u.time; if(u.location) state.location=u.location;
                    if(u.story_options) renderOptions(u.story_options);
                    localStorage.setItem('rpg_autosave_v39_1', JSON.stringify({state, history:conversationHistory}));
                    txt = txt.replace(json[0],"");
                } catch(e){}
            }
            addMsg("gm", marked.parse(txt));
            updateUI();
        }

        function renderOptions(opts) {
            const c = document.getElementById('options-area'); c.innerHTML="";
            opts.forEach(o => {
                const b = document.createElement('button'); b.className='opt-btn'; b.innerText=o;
                b.onclick = () => { 
                    const i = document.getElementById('user-input'); 
                    if (i.value.length > 0 && !i.value.endsWith(' ')) i.value += " " + o; 
                    else i.value += o;
                    i.focus(); 
                };
                c.appendChild(b);
            });
        }

        function updateUI() {
            document.getElementById('hp-txt').innerText = `${state.hp}/${state.maxHp}`;
            document.getElementById('hp-bar').style.width = `${(state.hp/state.maxHp)*100}%`;
            document.getElementById('location-display').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${state.location}`;
            document.getElementById('time-display').innerText = state.time;

            const map = {str:'disp-str', dex:'disp-dex', con:'disp-con', int:'disp-int', wis:'disp-wis', cha:'disp-cha'};
            for(let k in map) document.getElementById(map[k]).innerHTML = `<div class="attr-val">${state.stats[k]}</div><div class="attr-mod">(${getModStr(state.stats[k])})</div>`;
        }

        function addMsg(r, h) { const l=document.getElementById('chat-log'); l.innerHTML+=`<div class="msg ${r}">${h}</div>`; l.scrollTop=l.scrollHeight; }
        window.sendMsg = () => { const i=document.getElementById('user-input'); if(!i.value.trim())return; addMsg("user",i.value); callAI(i.value); i.value=""; document.getElementById('options-area').innerHTML=""; };
        window.saveToCode = () => prompt("ä»£ç¢¼:", btoa(encodeURIComponent(JSON.stringify({state, history:conversationHistory}))));
        window.loadFromCode = () => { try{ loadGameData(JSON.parse(decodeURIComponent(atob(document.getElementById('load-code').value)))); }catch(e){alert("ç„¡æ•ˆ");} };
        window.loadGameData = (d) => { state=d.state; conversationHistory=d.history; document.getElementById('setup-modal').classList.add('hidden'); updateUI(); if(!confirmedModel) detectModelAndStart().catch(()=>{}); };
        window.resetGame = () => { if(confirm("é‡ç½®?")) { localStorage.removeItem('rpg_autosave_v39_1'); location.reload(); } };
    </script>
</body>
</html>
