<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>RPG Engine Final (Google Style 2D)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        :root { 
            --bg: #202124; --panel: #303134; --text: #e8eaed; 
            --accent: #8ab4f8; --border: #3c4043;
            /* éª°å­é¡è‰² (Google é…è‰²) */
            --d4-color: #34a853; --d6-color: #2ab7ca; --d8-color: #a142f4;
            --d10-color: #f43f5e; --d12-color: #ea4335; --d20-color: #fb8c00;
        }
        body { margin: 0; font-family: 'Roboto', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        /* --- å´é‚Šæ¬„ (å·¦) --- */
        .sidebar { 
            width: 400px; background: #292a2d; border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; flex-shrink: 0; 
        }

        .panel-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 15px; }

        /* é€šç”¨å¡ç‰‡ */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .card-header { 
            padding: 10px 15px; background: rgba(0,0,0,0.2); font-size: 13px; color: #9aa0a6; 
            font-weight: bold; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* --- Google é¢¨æ ¼éª°å­å€ --- */
        #dice-container {
            background: #e8eaed; /* Google æ·ºè‰²èƒŒæ™¯ */
            padding: 20px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* é¡¯ç¤ºéª°å­çš„å€åŸŸ */
        #active-dice-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            width: 100%;
        }

        /* éª°å­æœ¬é«” (ç´” CSS ç¹ªè£½å½¢ç‹€) */
        .die {
            width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: bold; color: white;
            cursor: pointer; user-select: none;
            transition: transform 0.2s;
            position: relative;
        }
        .die:hover { transform: scale(1.1); }
        .die.rolling { animation: shake 0.5s infinite; }

        /* å½¢ç‹€å®šç¾© */
        .die-d4 { 
            background: var(--d4-color); 
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%); 
            padding-top: 10px; height: 50px; /* ä¸‰è§’å½¢ä¿®æ­£ */
        }
        .die-d6 { background: var(--d6-color); border-radius: 4px; }
        .die-d8 { 
            background: var(--d8-color); 
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); 
        }
        .die-d10 { 
            background: var(--d10-color); 
            clip-path: polygon(50% 0%, 100% 38%, 50% 100%, 0% 38%); 
        }
        .die-d12 { 
            background: var(--d12-color); 
            clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); 
        }
        .die-d20 { 
            background: var(--d20-color); 
            clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%); 
        }

        /* ç¸½è¨ˆé¡¯ç¤º */
        #dice-total {
            position: absolute; bottom: 10px; right: 20px;
            font-size: 28px; color: #202124; font-weight: bold;
        }

        /* éª°å­æ§åˆ¶åˆ— */
        .dice-controls {
            display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;
            padding: 10px; background: white; border-top: 1px solid #ccc;
        }
        .add-die-btn {
            width: 35px; height: 35px; border: none; color: white;
            font-size: 12px; font-weight: bold; cursor: pointer;
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
        }
        .btn-green { background: var(--d4-color); clip-path: polygon(50% 0%, 0% 100%, 100% 100%); height: 30px; }
        .btn-blue { background: var(--d6-color); }
        .btn-purple { background: var(--d8-color); clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .btn-pink { background: var(--d10-color); clip-path: polygon(50% 0%, 100% 38%, 50% 100%, 0% 38%); }
        .btn-red { background: var(--d12-color); clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); }
        .btn-orange { background: var(--d20-color); clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%); }

        #roll-btn {
            background: #1a73e8; color: white; border: none;
            padding: 8px 20px; border-radius: 4px; font-weight: bold;
            cursor: pointer; margin-left: 10px;
        }
        #roll-btn:hover { background: #1557b0; }

        /* --- äººç‰©é—œä¿‚èˆ‡å±¬æ€§ --- */
        .npc-item {
            padding: 8px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between;
        }
        .npc-name { color: var(--accent); font-weight: bold; }
        .npc-rel { color: #9aa0a6; font-size: 12px; }

        /* --- å±¬æ€§èª¿æ•´å™¨ (æ‰‹å‹•é…é») --- */
        .attr-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 5px 0; border-bottom: 1px solid #3c4043;
        }
        .attr-val-box { display: flex; align-items: center; gap: 10px; }
        .circle-btn {
            width: 20px; height: 20px; border-radius: 50%; border: 1px solid #5f6368;
            background: #303134; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }

        /* --- ä¸»å…§å®¹ (å³) --- */
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); }
        
        .header-bar { 
            padding: 10px 20px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 14px; color: #9aa0a6; background: #292a2d;
        }
        .header-btn { background: none; border: none; color: #9aa0a6; cursor: pointer; margin-left: 10px; }
        .header-btn:hover { color: white; }

        #chat-log { flex: 1; padding: 20px; overflow-y: auto; font-size: 15px; line-height: 1.6; }
        .msg { margin-bottom: 15px; max-width: 85%; padding: 12px 16px; border-radius: 8px; }
        .msg.gm { background: #3c4043; border-left: 4px solid var(--accent); }
        .msg.user { background: #185abc; color: white; margin-left: auto; }

        .input-area { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: #292a2d; }
        input[type="text"] { 
            flex: 1; padding: 12px; background: #3c4043; border: 1px solid #5f6368; 
            color: white; border-radius: 24px; outline: none; 
        }
        .send-btn { 
            width: 45px; height: 45px; border-radius: 50%; background: var(--accent); 
            border: none; cursor: pointer; color: #000; font-size: 18px; 
        }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #303134; width: 500px; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-btn { width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .hidden { display: none !important; }

        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            50% { transform: rotate(-10deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0deg); }
        }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal">
        <div class="modal-box">
            <h2 style="color:var(--accent); margin-top:0;">ğŸ² RPG å•Ÿå‹•å™¨</h2>
            
            <label style="display:block; margin-bottom:5px; color:#aaa;">Gemini API Key</label>
            <input type="password" id="api-key-input" style="width:100%; padding:10px; margin-bottom:15px; background:#202124; border:1px solid #555; color:white;">

            <label style="display:block; margin-bottom:5px; color:#aaa;">ä¸–ç•Œè§€è¨­å®š</label>
            <textarea id="world-prompt" rows="3" style="width:100%; padding:10px; background:#202124; border:1px solid #555; color:white;" placeholder="ä¾‹å¦‚ï¼šå…‹è˜‡é­¯ç¥è©±ã€ä¿®ä»™ä¸–ç•Œ..."></textarea>
            
            <div style="margin-top:20px; border-top:1px solid #555; padding-top:15px;">
                <label style="color:#aaa;">è®€å–å­˜æª”ç¢¼ (Base64)</label>
                <input type="text" id="load-code" placeholder="è²¼ä¸Šå­˜æª”ç¢¼..." style="width:100%; padding:10px; background:#202124; border:1px solid #555; color:white; margin-bottom:10px;">
                <button class="modal-btn" style="background:#555; color:white;" onclick="loadGame()">ğŸ“‚ è®€å–èˆŠæª”</button>
            </div>

            <button class="modal-btn" onclick="goToStats()">â¡ï¸ ä¸‹ä¸€æ­¥ï¼šå±¬æ€§é…é»</button>
        </div>
    </div>

    <div id="stats-modal" class="modal hidden">
        <div class="modal-box">
            <h2 style="color:var(--success);">ğŸ“Š å±¬æ€§åˆ†é…</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button class="modal-btn" style="width:48%; background:#555; color:white;" onclick="randomStats()">ğŸ² éš¨æ©Ÿç”Ÿæˆ (72-80)</button>
                <div style="color:#aaa; display:flex; align-items:center;">å‰©é¤˜é»æ•¸: <span id="points-left" style="color:white; font-weight:bold; margin-left:5px;">0</span></div>
            </div>
            
            <div id="stats-editor">
                </div>

            <button class="modal-btn" onclick="startGame()">âœ… é–‹å§‹å†’éšª</button>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            
            <div class="card" style="border-radius:0; border-left:none; border-right:none; border-top:none;">
                <div id="dice-container">
                    <div id="active-dice-area">
                        <div style="color:#888; font-size:12px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥éª°å­</div>
                    </div>
                    <div id="dice-total">ç¸½è¨ˆ: 0</div>
                </div>
                <div class="dice-controls">
                    <button class="add-die-btn btn-green" onclick="addDie(4)">4</button>
                    <button class="add-die-btn btn-blue" onclick="addDie(6)">6</button>
                    <button class="add-die-btn btn-purple" onclick="addDie(8)">8</button>
                    <button class="add-die-btn btn-pink" onclick="addDie(10)">10</button>
                    <button class="add-die-btn btn-red" onclick="addDie(12)">12</button>
                    <button class="add-die-btn btn-orange" onclick="addDie(20)">20</button>
                    <button id="roll-btn" onclick="rollDice()">æ“²å‡ºéª°å­</button>
                </div>
            </div>

            <div class="panel-content">
                <div class="card">
                    <div class="card-header">åŸºç¤å±¬æ€§</div>
                    <div style="padding:15px;" id="disp-stats">
                        </div>
                </div>

                <div class="card">
                    <div class="card-header">äººç‰©é—œä¿‚ (Relationships)</div>
                    <div id="npc-list" style="padding:10px;">
                        <div style="color:#666; font-style:italic;">å°šç„¡è¨˜éŒ„</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ç‰©å“æ¬„</div>
                    <div id="inventory-list" style="padding:10px; color:#aaa;">ç„¡</div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="header-bar">
                <div>
                    <span id="loc-disp"><i class="fas fa-map-marker-alt"></i> è™›ç©º</span> | 
                    <span id="time-disp">åˆå§‹</span>
                </div>
                <div>
                    <button class="header-btn" title="å­˜æª”" onclick="saveGame()"><i class="fas fa-save"></i></button>
                    <button class="header-btn" title="é‡ç½®" onclick="resetGame()" style="color:#f28b82;"><i class="fas fa-trash"></i></button>
                </div>
            </div>

            <div id="chat-log">
                <div class="msg gm">æ­¡è¿ä½¿ç”¨ RPG Engine (Google Style)ã€‚<br>è«‹å…ˆå®Œæˆè¨­å®šã€‚</div>
            </div>

            <div class="input-area">
                <input type="text" id="user-input" placeholder="æ¥ä¸‹ä¾†è¦åšä»€éº¼ï¼Ÿ" onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script>
        // --- è®Šæ•¸ ---
        let apiKey = "";
        let conversationHistory = [];
        let diceBag = [];
        let state = {
            stats: { STR:10, DEX:10, CON:10, INT:10, WIS:10, CHA:10 },
            npcs: [],
            inventory: [],
            location: "æœªçŸ¥",
            time: "æœªçŸ¥"
        };

        // --- 1. ç³»çµ±åˆå§‹åŒ– & å­˜è®€æª” ---
        window.onload = function() {
            const savedKey = localStorage.getItem('gemini_key');
            if(savedKey) document.getElementById('api-key-input').value = savedKey;
        };

        function goToStats() {
            const k = document.getElementById('api-key-input').value.trim();
            if(!k) return alert("è«‹è¼¸å…¥ API Key");
            apiKey = k;
            localStorage.setItem('gemini_key', k);
            
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('stats-modal').classList.remove('hidden');
            renderStatsEditor();
        }

        function saveGame() {
            const data = JSON.stringify({ state, history: conversationHistory });
            const code = btoa(encodeURIComponent(data));
            prompt("è«‹è¤‡è£½å­˜æª”ç¢¼ï¼š", code);
        }

        function loadGame() {
            try {
                const code = document.getElementById('load-code').value.trim();
                const json = decodeURIComponent(atob(code));
                const data = JSON.parse(json);
                state = data.state;
                conversationHistory = data.history;
                
                // æ¢å¾© UI
                updateHUD();
                renderChatHistory();
                document.getElementById('setup-modal').classList.add('hidden');
                
                // å¦‚æœæ²’æœ‰ Keyï¼Œé‚„æ˜¯è¦å•ä¸€ä¸‹
                if(!localStorage.getItem('gemini_key')) {
                    const k = prompt("è®€æª”æˆåŠŸï¼Œä½†éœ€è¦ API Key æ‰èƒ½ç¹¼çºŒï¼š");
                    if(k) { apiKey = k; localStorage.setItem('gemini_key', k); }
                } else {
                    apiKey = localStorage.getItem('gemini_key');
                }
            } catch(e) {
                alert("å­˜æª”ç¢¼ç„¡æ•ˆæˆ–æå£");
            }
        }

        function resetGame() {
            if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰é€²åº¦å—ï¼Ÿ")) location.reload();
        }

        // --- 2. å±¬æ€§é…é»é‚è¼¯ (æ‰‹å‹• + éš¨æ©Ÿ) ---
        function renderStatsEditor() {
            const container = document.getElementById('stats-editor');
            container.innerHTML = "";
            for(let key in state.stats) {
                container.innerHTML += `
                    <div class="attr-row" style="color:white;">
                        <span>${key}</span>
                        <div class="attr-val-box">
                            <div class="circle-btn" onclick="modStat('${key}', -1)">-</div>
                            <span id="edit-${key}">${state.stats[key]}</span>
                            <div class="circle-btn" onclick="modStat('${key}', 1)">+</div>
                        </div>
                    </div>
                `;
            }
        }

        function modStat(key, val) {
            state.stats[key] += val;
            document.getElementById(`edit-${key}`).innerText = state.stats[key];
        }

        function randomStats() {
            let total = 0;
            // D&D 3d6 è¦å‰‡æˆ–ç°¡å–®éš¨æ©Ÿ
            for(let key in state.stats) {
                state.stats[key] = Math.floor(Math.random() * 8) + 8; // 8~15
                total += state.stats[key];
            }
            renderStatsEditor();
            document.getElementById('points-left').innerText = `ç¸½å’Œ: ${total}`;
        }

        async function startGame() {
            document.getElementById('stats-modal').classList.add('hidden');
            updateHUD();
            
            const world = document.getElementById('world-prompt').value || "D&D 5e";
            const sysPrompt = `ä½ æ˜¯ä¸€å€‹ TRPG åœ°ä¸‹åŸä¸» (DM)ã€‚ä¸–ç•Œè§€ï¼š${world}ã€‚
            ã€è¦å‰‡ã€‘
            1. æ¯æ¬¡å›å¾©è«‹æ¨å‹•åŠ‡æƒ…ï¼Œä¸¦åœ¨çµå°¾çµ¦å‡ºè¡Œå‹•é¸é …ã€‚
            2. ç©å®¶æ“²éª°å¾Œï¼Œè«‹æ ¹æ“šé»æ•¸åˆ¤å®šçµæœã€‚
            3. å›æ‡‰çµå°¾å¿…é ˆåŒ…å« JSON æ ¼å¼ä¾†æ›´æ–° UI (ä¸è¦é¡¯ç¤ºçµ¦ç©å®¶çœ‹)ï¼š
            \`\`\`json
            {
                "location": "åœ°é»",
                "time": "æ™‚é–“",
                "npcs": [{"name":"åå­—", "rel":"é—œä¿‚"}],
                "inventory": ["ç‰©å“1", "ç‰©å“2"]
            }
            \`\`\`
            `;
            
            conversationHistory = [{ role: "user", parts: [{ text: sysPrompt }] }];
            addMsg("gm", "æ­£åœ¨æ§‹å»ºä¸–ç•Œ...", true);
            await callGemini("è«‹é–‹å§‹éŠæˆ²ï¼Œæè¿°é–‹å ´ã€‚");
        }

        // --- 3. Google Style éª°å­é‚è¼¯ ---
        function addDie(sides) {
            diceBag.push({ sides: sides, val: sides }); // é è¨­é¡¯ç¤ºæœ€å¤§å€¼
            renderDice();
        }

        function renderDice() {
            const area = document.getElementById('active-dice-area');
            area.innerHTML = "";
            if(diceBag.length === 0) area.innerHTML = `<div style="color:#888; font-size:12px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥éª°å­</div>`;
            
            let total = 0;
            diceBag.forEach((d, idx) => {
                const div = document.createElement('div');
                div.className = `die die-d${d.sides}`;
                div.innerText = d.val;
                div.onclick = () => removeDie(idx);
                area.appendChild(div);
                total += d.val;
            });
            document.getElementById('dice-total').innerText = `ç¸½è¨ˆ: ${total}`;
        }

        function removeDie(index) {
            diceBag.splice(index, 1);
            renderDice();
        }

        function rollDice() {
            if(diceBag.length === 0) return;
            
            // å‹•ç•«
            const diceEls = document.querySelectorAll('.die');
            diceEls.forEach(el => el.classList.add('rolling'));
            
            setTimeout(() => {
                let total = 0;
                let resultStr = "";
                diceBag.forEach(d => {
                    d.val = Math.floor(Math.random() * d.sides) + 1;
                    total += d.val;
                    resultStr += `(D${d.sides}=${d.val}) `;
                });
                
                renderDice(); // æ›´æ–°æ•¸å­—
                diceEls.forEach(el => el.classList.remove('rolling'));
                
                // è‡ªå‹•å¡«å…¥å°è©±æ¡†
                document.getElementById('user-input').value = `æˆ‘æ“²å‡ºäº†ï¼š${resultStr} ç¸½è¨ˆ ${total}`;
            }, 500);
        }

        // --- 4. Gemini API èˆ‡ èŠå¤© ---
        async function sendMsg() {
            const input = document.getElementById('user-input');
            const txt = input.value.trim();
            if(!txt) return;
            
            addMsg("user", txt);
            input.value = "";
            addMsg("gm", "...", true); // loading
            
            await callGemini(txt);
        }

        async function callGemini(text) {
            conversationHistory.push({ role: "user", parts: [{ text: text }] });
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: conversationHistory })
                });
                
                const data = await res.json();
                const aiText = data.candidates[0].content.parts[0].text;
                
                // ç§»é™¤ loading
                const loaders = document.querySelectorAll('.loading');
                loaders.forEach(el => el.remove());

                processResponse(aiText);
                conversationHistory.push({ role: "model", parts: [{ text: aiText }] });

            } catch(e) {
                console.error(e);
                addMsg("gm", "é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯ã€‚");
            }
        }

        function processResponse(text) {
            // æå– JSON
            const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
            let displayText = text;
            
            if(jsonMatch) {
                try {
                    const data = JSON.parse(jsonMatch[1]);
                    if(data.location) state.location = data.location;
                    if(data.time) state.time = data.time;
                    if(data.npcs) state.npcs = data.npcs;
                    if(data.inventory) state.inventory = data.inventory;
                    
                    updateHUD();
                    displayText = text.replace(jsonMatch[0], ""); // éš±è— JSON
                } catch(e) { console.error("JSON Parse Error"); }
            }
            
            addMsg("gm", marked.parse(displayText));
        }

        function addMsg(role, html, isLoading=false) {
            const box = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = `msg ${role} ${isLoading ? 'loading' : ''}`;
            div.innerHTML = html;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function renderChatHistory() {
            const box = document.getElementById('chat-log');
            box.innerHTML = "";
            conversationHistory.forEach(msg => {
                // è·³éç³»çµ±æŒ‡ä»¤
                if(msg.role === 'user' && msg.parts[0].text.includes('JSON')) return; 
                
                // ç°¡å–®æ¸²æŸ“ï¼Œä¸é‡æ–°è§£æ JSON
                const role = msg.role === 'model' ? 'gm' : 'user';
                let txt = msg.parts[0].text.replace(/```json[\s\S]*```/, "");
                addMsg(role, marked.parse(txt));
            });
        }

        // --- 5. UI æ›´æ–° ---
        function updateHUD() {
            document.getElementById('loc-disp').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${state.location}`;
            document.getElementById('time-disp').innerText = state.time;
            
            // å±¬æ€§
            let statHtml = "";
            for(let k in state.stats) {
                const mod = Math.floor((state.stats[k]-10)/2);
                const sign = mod >= 0 ? "+" : "";
                statHtml += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="color:#aaa;">${k}</span>
                    <span style="color:var(--accent); font-weight:bold;">${state.stats[k]} <span style="font-size:11px; color:#fff;">(${sign}${mod})</span></span>
                </div>`;
            }
            document.getElementById('disp-stats').innerHTML = statHtml;

            // NPC
            const npcBox = document.getElementById('npc-list');
            if(state.npcs.length === 0) {
                npcBox.innerHTML = `<div style="color:#666; font-style:italic;">å°šç„¡è¨˜éŒ„</div>`;
            } else {
                npcBox.innerHTML = state.npcs.map(n => `
                    <div class="npc-item">
                        <span class="npc-name">${n.name}</span>
                        <span class="npc-rel">${n.rel}</span>
                    </div>
                `).join('');
            }

            // ç‰©å“
            const invBox = document.getElementById('inventory-list');
            invBox.innerText = state.inventory.length ? state.inventory.join(", ") : "ç„¡";
        }
    </script>
</body>
</html>
