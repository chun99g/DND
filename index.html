<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 萬用跑團引擎 (Gemini Core)</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- 全局設定：沉浸式暗色調 --- */
        body {
            margin: 0;
            background-color: #0f0f0f;
            color: #e0e0e0;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- 1. 啟動面板 (設定 API 和 世界觀) --- */
        #setup-panel {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .setup-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #333;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h2 { margin-top: 0; color: #4CAF50; text-align: center; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; }
        
        input[type="password"], textarea {
            width: 100%;
            padding: 12px;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .start-btn {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: #4CAF50;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: 0.3s;
        }
        .start-btn:hover { background: #66bb6a; }

        /* --- 2. 聊天區域 --- */
        #chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 30px 30px;
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 1.05rem;
            position: relative;
        }

        .message.user {
            align-self: flex-end;
            background-color: #263238;
            border-right: 4px solid #4CAF50;
        }

        .message.ai {
            align-self: flex-start;
            background-color: #1e1e1e;
            border-left: 4px solid #ff9800; /* 橘色代表 DM */
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Markdown 樣式修正 */
        .message p { margin: 0 0 10px 0; }
        .message p:last-child { margin: 0; }
        .message strong { color: #ffeb3b; }

        /* --- 3. 底部輸入區 --- */
        #input-area {
            padding: 15px;
            background: #111;
            border-top: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .controls-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #user-input {
            flex: 1;
            padding: 12px;
            font-size: 1rem;
            background: #222;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
        }

        #send-btn {
            padding: 10px 20px;
            background: #4CAF50;
            color: black;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* --- 骰子按鈕群 --- */
        #dice-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .dice-btn {
            background: #333;
            color: #bbb;
            border: 1px solid #555;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .dice-btn:hover { background: #555; color: white; border-color: #888; }

        /* --- 4. 3D 擲骰遮罩層 (Overlay) --- */
        #dice-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none; /* 預設隱藏 */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #dice-stage {
            width: 80vw;
            height: 60vh;
            border: 1px solid #444;
            border-radius: 10px;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
            position: relative;
        }

        model-viewer {
            width: 100%;
            height: 100%;
        }

        #overlay-info {
            margin-top: 25px;
            text-align: center;
        }

        #overlay-status {
            font-size: 1.4rem;
            color: #ddd;
            margin-bottom: 15px;
        }

        #close-overlay-btn {
            background: transparent;
            border: 2px solid #4CAF50;
            color: #4CAF50;
            padding: 10px 30px;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.3s;
        }
        #close-overlay-btn:hover {
            background: #4CAF50;
            color: black;
        }

    </style>
</head>
<body>

    <div id="setup-panel">
        <div class="setup-box">
            <h2>世界構築 (World Setup)</h2>
            
            <label>Gemini API Key</label>
            <input type="password" id="api-key-input" placeholder="請貼上你的 Google API Key">
            
            <label>冒險世界觀設定 (可選)</label>
            <textarea id="world-setting-input" placeholder="例如：「這是一個蒸氣龐克的倫敦，魔法被視為犯罪...」&#10;如果不填，AI 將為你隨機生成一個精彩的世界。"></textarea>
            
            <button class="start-btn" onclick="startGame()">開始冒險</button>
            <p style="font-size: 0.8rem; color: #666; text-align: center; margin-top: 10px;">資料僅存於本地，重整即消失</p>
        </div>
    </div>

    <div id="dice-overlay">
        <div id="dice-stage">
            <model-viewer 
                id="dice-viewer"
                src="d20_low.glb" 
                camera-controls 
                shadow-intensity="1.5"
                environment-image="neutral" 
                interaction-prompt="none">
            </model-viewer>
        </div>
        <div id="overlay-info">
            <div id="overlay-status">骰子翻滾中...</div>
            <button id="close-overlay-btn" onclick="closeDiceOverlay()">我看好了 (輸入結果)</button>
        </div>
    </div>

    <div id="chat-container">
        </div>

    <div id="input-area">
        <div id="dice-buttons">
            <button class="dice-btn" onclick="openDice('d4')">D4</button>
            <button class="dice-btn" onclick="openDice('d6')">D6</button>
            <button class="dice-btn" onclick="openDice('d8')">D8</button>
            <button class="dice-btn" onclick="openDice('d10')">D10</button>
            <button class="dice-btn" onclick="openDice('d12')">D12</button>
            <button class="dice-btn" onclick="openDice('d20')">D20</button>
        </div>
        <div class="controls-row">
            <input type="text" id="user-input" placeholder="描述你的行動，或是輸入骰子點數..." onkeypress="handleEnter(event)">
            <button id="send-btn" onclick="sendMessage()">發送</button>
        </div>
    </div>

    <script>
        let apiKey = "";
        let chatHistory = [];
        let spinInterval;

        // --- 1. 遊戲啟動與世界生成 ---
        async function startGame() {
            const keyInput = document.getElementById('api-key-input').value.trim();
            const worldInput = document.getElementById('world-setting-input').value.trim();

            if (!keyInput) {
                alert("沒有 API Key，冒險無法開始！");
                return;
            }
            apiKey = keyInput;

            // 隱藏設定面板
            document.getElementById('setup-panel').style.display = 'none';

            // 構建初始 Prompt
            let systemInstruction = "";
            
            if (worldInput) {
                systemInstruction = `你現在是一個 TRPG 的地下城主 (DM)。我們即將進行的遊戲世界觀如下：\n「${worldInput}」\n\n請根據這個設定引導我進行冒險。開場請簡單描述環境並詢問我的行動。如果遇到需要判定的情況，請要求我擲骰子 (例如：請擲 D20 進行感知檢定)。請保持對話沉浸感。`;
            } else {
                systemInstruction = `你現在是一個 TRPG 的地下城主 (DM)。請你「隨機創造」一個充滿創意、獨特且吸引人的世界觀 (可以是科幻、奇幻、懸疑或恐怖)。\n\n開場時，請先描述這個世界的氛圍和你創造的場景，然後詢問我的行動。如果遇到需要判定的情況，請要求我擲骰子。`;
            }

            // 將系統指令加入歷史紀錄 (Gemini 雖然沒有 system role，但我們可以放在第一則 user message 前面)
            chatHistory = [
                {
                    "role": "user",
                    "parts": [{ "text": systemInstruction }]
                }
            ];

            // 觸發 AI 的第一句話
            addMessageToUI("正在構建世界...", 'ai', true);
            await callGeminiAPI();
        }

        // --- 2. 擲骰系統 (全方位旋轉) ---
        const viewer = document.getElementById('dice-viewer');
        const overlay = document.getElementById('dice-overlay');
        const statusText = document.getElementById('overlay-status');

        function openDice(diceType) {
            overlay.style.display = 'flex';
            statusText.innerText = "命運翻轉中...";
            statusText.style.color = "#ddd";
            
            // 換模型
            viewer.src = `${diceType}_low.glb`;

            // 開始亂轉
            startChaosSpin();

            // 隨機時間後停下
            const stopTime = 1000 + Math.random() * 1500;
            setTimeout(() => {
                stopChaosSpin();
                statusText.innerText = "請讀取朝向你的數字";
                statusText.style.color = "#4CAF50";
            }, stopTime);
        }

        function startChaosSpin() {
            clearInterval(spinInterval);
            spinInterval = setInterval(() => {
                // 隨機改變 Orbit 角度，模擬在空中翻滾
                const theta = Math.random() * 360; 
                const phi = Math.random() * 180;
                const radius = 2.0 + Math.random() * 1.5; 
                viewer.cameraOrbit = `${theta}deg ${phi}deg ${radius}m`;
            }, 60);
        }

        function stopChaosSpin() {
            clearInterval(spinInterval);
            // 最後停在一個隨機角度
            const finalTheta = Math.random() * 360;
            const finalPhi = Math.random() * 180;
            viewer.cameraOrbit = `${finalTheta}deg ${finalPhi}deg 2.5m`;
        }

        function closeDiceOverlay() {
            overlay.style.display = 'none';
            document.getElementById('user-input').focus();
        }

        // --- 3. 聊天與 API 處理 ---
        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            const userText = inputField.value.trim();
            if (!userText) return;

            // 1. 顯示使用者訊息
            addMessageToUI(userText, 'user');
            inputField.value = '';

            // 2. 加入歷史紀錄
            chatHistory.push({
                "role": "user",
                "parts": [{ "text": userText }]
            });

            // 3. 顯示 Loading
            addMessageToUI("DM 思考中...", 'ai', true);

            // 4. 呼叫 API
            await callGeminiAPI();
        }

        async function callGeminiAPI() {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: chatHistory })
                });

                const data = await response.json();

                // 移除 Loading
                const loadingMsg = document.querySelector('.message.ai:last-child');
                if(loadingMsg && loadingMsg.innerText === "DM 思考中...") {
                    loadingMsg.remove();
                }
                // 移除開場的 loading
                const initLoading = document.querySelector('.message.ai:last-child');
                if(initLoading && initLoading.innerText === "正在構建世界...") {
                    initLoading.remove();
                }

                if (data.candidates && data.candidates[0].content) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    addMessageToUI(aiText, 'ai');
                    
                    chatHistory.push({
                        "role": "model",
                        "parts": [{ "text": aiText }]
                    });
                } else {
                    addMessageToUI("天道連線中斷 (API Error)", 'ai');
                    console.error(data);
                }

            } catch (error) {
                console.error(error);
                // 移除 Loading
                const loadingMsg = document.querySelector('.message.ai:last-child');
                if(loadingMsg) loadingMsg.remove();
                addMessageToUI("發生錯誤：" + error.message, 'ai');
            }
        }

        function addMessageToUI(text, role, isLoading = false) {
            const container = document.getElementById('chat-container');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;
            
            if (isLoading) {
                msgDiv.innerText = text;
                msgDiv.style.fontStyle = "italic";
                msgDiv.style.opacity = "0.7";
            } else {
                msgDiv.innerHTML = marked.parse(text);
            }
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
