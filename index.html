<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>RPG Engine V48 (Strict D&D Core)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- V39.1 æ ¸å¿ƒæ¨£å¼ä¿ç•™ --- */
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #bb86fc; --success: #03dac6; --warn: #cf6679; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        .app-container { display: flex; height: 100%; }
        .sidebar { width: 420px; background: #181818; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

        .panel-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px; }
        
        /* å¡ç‰‡èˆ‡ UI */
        .card { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .card-header { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 4px; }
        
        .bar-wrap { background: #333; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 4px; }
        .bar-fill { height: 100%; transition: width 0.5s ease; }
        .stat-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 2px; }

        .header-bar { padding: 10px 20px; background: #181818; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #aaa; }
        .chat-log { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; font-size: 15px; line-height: 1.6; padding-bottom: 100px; }
        .msg { margin-bottom: 20px; max-width: 90%; padding: 12px 16px; border-radius: 8px; animation: fadeIn 0.3s; }
        .msg.gm { background: #252525; border-left: 4px solid var(--accent); color: #ddd; }
        .msg.user { background: #3d2c5e; color: #fff; margin-left: auto; text-align: right; }
        .msg.sys { background: rgba(3, 218, 198, 0.1); color: var(--success); font-size: 13px; text-align: center; max-width: 100%; border: 1px dashed var(--success); margin: 10px auto; }
        
        .options-container { padding: 10px 15px; background: #181818; display: flex; flex-wrap: wrap; gap: 8px; border-top: 1px solid #333; }
        .opt-btn { background: #2a2a2a; color: #bbb; border: 1px solid #444; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 13px; transition: 0.2s; text-align: left; }
        .opt-btn:hover { background: #333; color: var(--accent); border-color: var(--accent); }

        .input-area { padding: 15px; background: #181818; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; background: #252525; border: 1px solid #444; color: white; border-radius: 24px; outline: none; padding-left: 20px; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; color: #000; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* Modal & Attr Editor */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #252525; width: 450px; padding: 30px; border-radius: 12px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-btn { width: 100%; padding: 12px; background: var(--accent); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .tag { display: inline-block; background: #333; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin: 2px; color: #ccc; border: 1px solid #444; }
        
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .attr-main { text-align: center; background: #2a2a2a; padding: 5px; border-radius: 4px; }
        .attr-val { font-size: 18px; font-weight: bold; color: var(--accent); }
        .attr-mod { font-size: 12px; color: var(--success); font-weight: bold; }
        .attr-lbl { font-size: 12px; color: #aaa; }
        .attr-cn { font-size: 11px; color: #666; display: block; margin-top: 2px; }

        .attr-edit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .attr-edit-box { background: #2a2a2a; padding: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .attr-ctrl { display: flex; align-items: center; gap: 5px; }
        .attr-btn { width: 20px; height: 20px; border-radius: 50%; border: none; background: #444; color: #fff; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;}
        .range-input { width: 60px; background: #111; border: 1px solid #444; color: #fff; text-align: center; padding: 4px; border-radius: 4px; }

        .hidden { display: none !important; }

        /* --- 2D Dice (åµŒå…¥ç‰ˆ) --- */
        #dice-stage { 
            width: 100%; min-height: 200px; background: #e8eaed; 
            border-bottom: 1px solid #333; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #active-dice-area {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;
            width: 100%; padding: 10px;
        }
        .die {
            width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; color: white;
            cursor: pointer; user-select: none; transition: transform 0.1s;
            position: relative;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .die:hover { transform: scale(1.1); }
        .die.rolling { animation: shake 0.5s infinite; }

        /* Dice Colors & Shapes */
        .die-d4 { background: #34a853; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); padding-top: 5px; height: 45px; }
        .die-d6 { background: #2ab7ca; border-radius: 4px; }
        .die-d8 { background: #a142f4; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .die-d10 { background: #f43f5e; clip-path: polygon(50% 0%, 100% 38%, 50% 100%, 0% 38%); }
        .die-d12 { background: #ea4335; clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); }
        .die-d20 { background: #fb8c00; clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%); }

        #dice-total {
            position: absolute; bottom: 5px; right: 10px;
            font-size: 18px; color: #5f6368; font-weight: bold;
            background: rgba(255,255,255,0.8); padding: 2px 6px; border-radius: 4px;
        }

        /* éª°å­æŒ‰éˆ• */
        .dice-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 5px; }
        .d-btn { 
            height: 36px; border: none; border-radius: 6px; color: white; font-weight: bold; 
            cursor: pointer; font-size: 12px; background: #333; 
            box-shadow: 0 2px 0 rgba(0,0,0,0.3); transition: transform 0.1s; 
        }
        .d-btn:active { transform: scale(0.95); }
        .btn-d4 { border-bottom: 3px solid #34a853; } .btn-d6 { border-bottom: 3px solid #2ab7ca; }
        .btn-d8 { border-bottom: 3px solid #a142f4; } .btn-d10 { border-bottom: 3px solid #f43f5e; }
        .btn-d12 { border-bottom: 3px solid #ea4335; } .btn-d20 { border-bottom: 3px solid #fb8c00; }

        .roll-trigger-btn {
            background: var(--accent); color: #000; border: none; padding: 4px 12px;
            border-radius: 12px; font-size: 11px; font-weight: bold; cursor: pointer;
        }
        .roll-trigger-btn:hover { background: #fff; }
        
        .send-result-btn {
            background: var(--success); color: #000; border: none; padding: 4px 12px;
            border-radius: 12px; font-size: 11px; font-weight: bold; cursor: pointer;
            margin-left: 10px; display: none;
        }

        @keyframes shake {
            0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 
            50% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal">
        <div class="modal-box">
            <h2 style="color:var(--accent); margin-top:0;">ğŸš€ RPG Engine Core</h2>
            <p>è«‹è¼¸å…¥å†’éšªä¸–ç•Œè§€ï¼š</p>
            <textarea id="world-prompt" rows="3" style="width:100%; background:#111; color:#fff; border:1px solid #444; padding:10px; border-radius:4px;" placeholder="ä¾‹å¦‚ï¼šé¾èˆ‡åœ°ä¸‹åŸ D&D 5eï¼Œè²»å€«å¤§é™¸ï¼Œè¢«è©›å’’çš„è¿·éœ§å±±è°·..."></textarea>
            <button class="modal-btn" onclick="startCharacterCreation()">ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆè§’è‰²</button>
            <div style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
                <p style="font-size:12px; color:#aaa;">è®€å–å­˜æª”ï¼š</p>
                <input type="text" id="load-code" placeholder="å­˜æª”ç¢¼..." style="width:100%; padding:8px; background:#111; border:1px solid #444; color:#fff; margin-bottom:5px;">
                <button class="modal-btn" style="background:#444; color:#fff; margin-top:0;" onclick="loadFromCode()">è®€å–</button>
            </div>
        </div>
    </div>

    <div id="char-modal" class="modal hidden">
        <div class="modal-box">
            <h2 style="color:var(--success); margin-top:0;">ğŸ² å±¬æ€§ç”Ÿæˆ (D&D 5e)</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span style="color:#aaa; font-size:13px;">å±¬æ€§ç¸½å’Œç¯„åœï¼š</span>
                <div><input type="number" id="stat-min" class="range-input" value="72"> - <input type="number" id="stat-max" class="range-input" value="80"></div>
            </div>
            <div id="char-stats-editor" class="attr-edit-grid" style="margin: 20px 0;"></div>
            
            <div style="background:#111; padding:10px; border-radius:4px; font-size:13px; color:#aaa; margin-bottom:15px; text-align:center;">
                <div id="derived-stats">è¨ˆç®—ä¸­...</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="modal-btn" style="background:#444; color:#fff;" onclick="randomizeStats()">ğŸ² åˆ†é…é‡æ“²</button>
                <button class="modal-btn" onclick="confirmStart()">âœ… é–‹å§‹å†’éšª</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <div id="dice-stage">
                <div id="active-dice-area"><div style="color:#888; font-size:12px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥éª°å­</div></div>
                <div id="dice-total"></div>
            </div>
            
            <div class="panel-content">
                <div class="card">
                    <div class="card-header">
                        <span>éª°å­ç›¤</span>
                        <div>
                            <button class="roll-trigger-btn" onclick="roll2DDice()">ğŸ² æ“²éª°</button>
                            <button id="btn-send-dice" class="send-result-btn" onclick="sendDiceResult()">ğŸ“¤ ç™¼é€çµæœ</button>
                        </div>
                    </div>
                    <div class="dice-btn-grid">
                        <button class="d-btn btn-d4" onclick="add2DDie(4)">D4</button>
                        <button class="d-btn btn-d6" onclick="add2DDie(6)">D6</button>
                        <button class="d-btn btn-d8" onclick="add2DDie(8)">D8</button>
                        <button class="d-btn btn-d10" onclick="add2DDie(10)">D10</button>
                        <button class="d-btn btn-d12" onclick="add2DDie(12)">D12</button>
                        <button class="d-btn btn-d20" onclick="add2DDie(20)">D20</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ç‹€æ…‹</div>
                    <div class="stat-row"><span>HP</span> <span id="hp-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="hp-bar" class="bar-fill" style="width:100%; background:#cf6679;"></div></div>
                    <div class="stat-row"><span id="mp-label">MP</span> <span id="mp-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="mp-bar" class="bar-fill" style="width:100%; background:#03dac6;"></div></div>
                    <div class="stat-row"><span>SAN</span> <span id="san-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="san-bar" class="bar-fill" style="width:100%; background:#bb86fc;"></div></div>
                </div>
                
                <div class="card">
                    <div class="card-header">å±¬æ€§ (èª¿æ•´å€¼)</div>
                    <div class="attr-grid">
                        <div class="attr-main"><div class="attr-lbl">STR</div><div class="attr-cn">åŠ›é‡</div><div id="disp-str"></div></div>
                        <div class="attr-main"><div class="attr-lbl">DEX</div><div class="attr-cn">æ•æ·</div><div id="disp-dex"></div></div>
                        <div class="attr-main"><div class="attr-lbl">CON</div><div class="attr-cn">é«”è³ª</div><div id="disp-con"></div></div>
                        <div class="attr-main"><div class="attr-lbl">INT</div><div class="attr-cn">æ™ºåŠ›</div><div id="disp-int"></div></div>
                        <div class="attr-main"><div class="attr-lbl">WIS</div><div class="attr-cn">æ„ŸçŸ¥</div><div id="disp-wis"></div></div>
                        <div class="attr-main"><div class="attr-lbl">CHA</div><div class="attr-cn">é­…åŠ›</div><div id="disp-cha"></div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">äººç‰©é—œä¿‚</div>
                    <div id="npc-list" style="font-size:13px; color:#aaa; padding:5px;">å°šç„¡è¨˜éŒ„</div>
                </div>

                <div class="card" style="flex:1"><div class="card-header">ç‰©å“</div><div id="inv-list" style="font-size:13px; color:#aaa; padding:5px;">ç„¡</div></div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="header-bar">
                <div class="header-info">
                    <span id="location-display"><i class="fas fa-map-marker-alt"></i> è™›ç©º</span>
                    <span id="time-display" style="margin-left: 10px; color:#666;">åˆå§‹</span>
                </div>
                <div>
                    <button class="menu-btn" onclick="saveToCode()" style="background:none;border:none;cursor:pointer;color:#aaa;" title="å­˜æª”">ğŸ’¾</button>
                    <button class="menu-btn" onclick="resetGame()" style="color:#f55; margin-left:5px; background:none;border:none;cursor:pointer;" title="é‡ç½®">ğŸ—‘ï¸</button>
                </div>
            </div>
            
            <div id="chat-log" class="chat-log"><div class="msg gm">ç³»çµ±å°±ç·’ã€‚è«‹å»ºç«‹è§’è‰²ã€‚</div></div>
            <div id="options-area" class="options-container"></div>
            
            <div class="input-area">
                <input type="text" id="user-input" placeholder="è¼¸å…¥è¡Œå‹•..." autocomplete="off">
                <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script>
        // --- æ ¸å¿ƒé‚è¼¯ ---
        let confirmedModel = ""; 
        let conversationHistory = []; 
        let diceBag = []; 
        let lastDiceTotal = 0;

        // é è¨­ç‹€æ…‹
        let state = { 
            hp: 10, maxHp: 10, mp: 10, maxMp: 10, mpLabel: "MP", 
            san: 100, maxSan: 100, 
            stats: { str:10, dex:10, con:10, int:10, wis:10, cha:10 }, 
            inventory: [], npcs: [], 
            time: "ç¬¬ä¸€å¤© æ¸…æ™¨", weather: "æœªçŸ¥", location: "èµ·å§‹é»", worldPrompt: "" 
        };

        // å±¬æ€§ä¸­è‹±æ–‡å°ç…§
        const ATTR_MAP = {
            str: 'åŠ›é‡', dex: 'æ•æ·', con: 'é«”è³ª', 
            int: 'æ™ºåŠ›', wis: 'æ„ŸçŸ¥', cha: 'é­…åŠ›'
        };

        // åˆå§‹åŒ–
        window.onload = function() {
            try {
                // Enter éµç¶å®š (ä¿®å¾©)
                document.getElementById('user-input').addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') { sendMsg(); }
                });

                const cachedKey = localStorage.getItem('my_gemini_key_v1');
                if (cachedKey) window.USER_API_KEY = cachedKey;

                const saved = localStorage.getItem('rpg_autosave_v48');
                if (saved && confirm("åµæ¸¬åˆ°å­˜æª”ï¼Œè¦ç¹¼çºŒå—ï¼Ÿ")) {
                    loadGameData(JSON.parse(saved));
                }
            } catch (e) {
                console.error("Init error:", e);
                alert("åˆå§‹åŒ–ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ã€‚");
            }
        };

        // --- 1. éª°å­é‚è¼¯ (åš´æ ¼éš¨æ©Ÿ) ---
        window.add2DDie = function(sides) {
            diceBag.push({ sides: sides, val: sides });
            renderDice();
            document.getElementById('btn-send-dice').style.display = 'none'; // æ–°å¢éª°å­å¾Œéš±è—ç™¼é€éˆ•ï¼Œéœ€é‡æ–°æ“²éª°
        }

        function removeDie(index) {
            diceBag.splice(index, 1);
            renderDice();
            document.getElementById('btn-send-dice').style.display = 'none';
        }

        function renderDice() {
            const area = document.getElementById('active-dice-area');
            area.innerHTML = "";
            let total = 0;
            diceBag.forEach((d, idx) => {
                const div = document.createElement('div');
                div.className = `die die-d${d.sides}`;
                div.innerText = d.val;
                div.onclick = () => removeDie(idx);
                area.appendChild(div);
                total += d.val;
            });
            
            const totalDisplay = document.getElementById('dice-total');
            if(diceBag.length > 0) {
                totalDisplay.innerText = `ç¸½å’Œ: ${total}`;
                totalDisplay.style.display = 'block';
            } else {
                totalDisplay.style.display = 'none';
                area.innerHTML = '<div style="color:#888; font-size:12px;">é»æ“ŠæŒ‰éˆ•æ–°å¢éª°å­</div>';
            }
        }

        window.roll2DDice = function() {
            if(diceBag.length === 0) return;
            const els = document.querySelectorAll('.die');
            els.forEach(e => e.classList.add('rolling'));
            
            // æ¨¡æ“¬å‹•ç•«å»¶é²
            setTimeout(() => {
                let total = 0;
                diceBag.forEach(d => {
                    // ä½¿ç”¨ Math.random() - ç´”ç²¹éš¨æ©Ÿ
                    d.val = Math.floor(Math.random() * d.sides) + 1;
                    total += d.val;
                });
                renderDice();
                els.forEach(e => e.classList.remove('rolling'));
                lastDiceTotal = total;
                // é¡¯ç¤ºç™¼é€çµæœæŒ‰éˆ•
                document.getElementById('btn-send-dice').style.display = 'inline-block';
            }, 500);
        }

        window.sendDiceResult = function() {
            if(diceBag.length === 0) return;
            const detail = diceBag.map(d => `D${d.sides}(${d.val})`).join('+');
            const msg = `(æ“²éª°çµæœ: ${detail} = ${lastDiceTotal})`;
            addMsg("sys", `ç©å®¶æ“²å‡ºäº†: ${detail} = ${lastDiceTotal}`);
            callAI(`[ç³»çµ±è³‡è¨Š] ç©å®¶æ“²éª°çµæœç‚º: ${detail} = ç¸½å’Œ ${lastDiceTotal}ã€‚è«‹æ ¹æ“šæ­¤çµæœé€²è¡Œåˆ¤å®šä¸¦æè¿°å¾Œæœã€‚`);
            document.getElementById('btn-send-dice').style.display = 'none';
            diceBag = []; // ç™¼é€å¾Œæ¸…ç©ºéª°å­ï¼Œé¿å…é‡è¤‡ä½¿ç”¨
            renderDice();
        }

        // --- 2. è§’è‰²èˆ‡ç³»çµ± ---
        function startCharacterCreation() {
            state.worldPrompt = document.getElementById('world-prompt').value.trim() || "D&D 5e";
            
            if(!window.USER_API_KEY) {
                const inputKey = prompt("è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key:", "");
                if(inputKey) {
                    window.USER_API_KEY = inputKey;
                    localStorage.setItem('my_gemini_key_v1', inputKey);
                } else {
                    alert("éœ€è¦ API Key æ‰èƒ½é‹ä½œã€‚");
                    return;
                }
            }
            randomizeStats();
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('char-modal').classList.remove('hidden');
        }

        function randomizeStats() {
            let min = parseInt(document.getElementById('stat-min').value)||72, max = parseInt(document.getElementById('stat-max').value)||80;
            if (min>max) [min,max]=[max,min];
            const target = Math.floor(Math.random()*(max-min+1))+min;
            const keys=['str','dex','con','int','wis','cha'];
            keys.forEach(k=>state.stats[k]=8); // D&D åŸºç¤å€¼
            let pts = target - (8*6);
            
            // éš¨æ©Ÿåˆ†é…é»æ•¸
            let safeGuard = 0;
            while(pts > 0 && safeGuard < 1000){ 
                const k = keys[Math.floor(Math.random()*6)]; 
                if(state.stats[k] < 18){ state.stats[k]++; pts--; } 
                safeGuard++;
            }
            renderStatEditor(target);
        }

        function adjustStat(k, d) { state.stats[k]+=d; renderStatEditor(); }
        function getMod(v) { return Math.floor((v-10)/2); }
        function getModStr(v) { const m=getMod(v); return m>=0?`+${m}`:`${m}`; }

        function renderStatEditor(sum) {
            if(!sum) sum=Object.values(state.stats).reduce((a,b)=>a+b,0);
            let h=''; 
            
            for(let k in state.stats){
                // åœ¨é€™è£¡åŠ å…¥ä¸­æ–‡æ¨™ç±¤
                h += `<div class="attr-edit-box">
                        <div class="attr-lbl" style="width:50px;">${k.toUpperCase()}<br><span style="font-size:10px;color:#888;">${ATTR_MAP[k]}</span></div>
                        <div class="attr-ctrl">
                            <button class="attr-btn" onclick="adjustStat('${k}',-1)">-</button>
                            <div class="attr-val">${state.stats[k]}</div>
                            <button class="attr-btn" onclick="adjustStat('${k}',1)">+</button>
                        </div>
                        <div style="font-size:12px;color:var(--success);width:30px;text-align:right;">${getModStr(state.stats[k])}</div>
                      </div>`;
            }
            document.getElementById('char-stats-editor').innerHTML=h;
            
            // è¡ç”Ÿæ•¸å€¼è¨ˆç®—
            state.maxHp = 10 + getMod(state.stats.con); 
            state.hp = state.maxHp;
            state.maxMp = Math.max(1, getMod(state.stats.int) + getMod(state.stats.wis)); 
            state.mp = state.maxMp;
            
            document.getElementById('derived-stats').innerHTML=`å±¬æ€§ç¸½å’Œ: ${sum} | åˆå§‹ HP: ${state.maxHp}`;
        }

        async function confirmStart() {
            document.getElementById('char-modal').classList.add('hidden');
            updateUI();
            addMsg("sys","æ­£åœ¨æ§‹å»ºä¸–ç•Œèˆ‡å†’éšªèµ·é»...è«‹ç¨å€™");
            await detectModelAndStart();
        }

        // --- 3. AI æ ¸å¿ƒé‚è¼¯ (System Prompt) ---
        async function detectModelAndStart() {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${window.USER_API_KEY}`);
                const data = await res.json();
                // å„ªå…ˆä½¿ç”¨æ›´è°æ˜çš„æ¨¡å‹
                const m = (data.models||[]).find(x=>x.name.includes("gemini-1.5-pro") || x.name.includes("gemini-1.5-flash"));
                if(!m) throw new Error("API Key ç„¡æ•ˆæˆ–æ‰¾ä¸åˆ°é©ç”¨æ¨¡å‹");
                confirmedModel = m.name.replace("models/","");
                
                // --- é€™è£¡å°±æ˜¯æ‚¨è¦æ±‚çš„åš´è¬¹é‚è¼¯ ---
                const sysPrompt = `ä½ æ˜¯ä¸€å€‹åš´æ ¼éµå®ˆ D&D 5e è¦å‰‡çš„åœ°ä¸‹åŸä¸» (DM)ã€‚
ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘
1. **ä¸–ç•ŒçœŸå¯¦æ€§**ï¼šä¸–ç•Œå¿…é ˆç¨ç«‹é‹è½‰ã€‚NPC æœ‰è‡ªå·±çš„ç”Ÿæ´»ã€å‹•æ©Ÿå’Œè¡Œç¨‹ï¼Œä¸æœƒå› ç‚ºç©å®¶ä¸åœ¨å ´å°±éœæ­¢ã€‚å¦‚æœç©å®¶é–’ç½®ï¼Œä¸–ç•Œäº‹ä»¶ä»æœƒç™¼ç”Ÿã€‚
2. **ç¦æ­¢ä»£æ“²**ï¼šä½ **çµ•å°ä¸å¯ä»¥**å¹«ç©å®¶æ±ºå®šè¡Œå‹•çµæœæˆ–è‡ªå‹•æ“²éª°ã€‚
   - å¦‚æœç©å®¶æ”»æ“Šæˆ–é€²è¡Œæœ‰é¢¨éšªçš„è¡Œå‹•ï¼Œè«‹å›ç­”ï¼šã€Œè«‹é€²è¡Œ [æª¢å®šåç¨±] (DC XX)ã€ï¼Œä¸¦åˆ—å‡ºç›¸é—œå±¬æ€§èª¿æ•´å€¼ã€‚
   - ç„¶å¾Œ**åœæ­¢ç”Ÿæˆ**ï¼Œç­‰å¾…ç©å®¶è¼¸å…¥æ“²éª°çµæœã€‚
3. **æˆ°é¬¥èˆ‡æª¢å®š**ï¼š
   - æ˜ç¢ºé¡¯ç¤º [DC: XX] å’Œ [èª¿æ•´å€¼: +Y]ã€‚
   - è€ƒæ…®ç’°å¢ƒå› ç´  (ä¾‹å¦‚ï¼šé»‘æš—å°è‡´åŠ£å‹¢)ã€‚
4. **è§’è‰²æˆé•·**ï¼šåš´æ ¼æ§åˆ¶æˆ°åŠ›ã€‚å±¬æ€§èˆ‡æŠ€èƒ½åªèƒ½é€éé•·æ™‚é–“è¨“ç·´æˆ–å‡ç´šç²å¾—ï¼Œä¸å¾—éš¨æ„å¢åŠ ã€‚
5. **æ²‰æµ¸æ„Ÿ**ï¼šæ„å¤–äº‹ä»¶å¿…é ˆæœ‰é‚è¼¯é‹ªå¢Šï¼ˆä¾‹å¦‚ï¼šå› ç‚ºä¹‹å‰æ®ºäº†å“¥å¸ƒæ—ç‹ï¼Œå°è‡´ç¾åœ¨è¢«æ‡¸è³ï¼‰ï¼Œè€Œééš¨æ©Ÿæ‡²ç½°ã€‚

ã€ç©å®¶ç•¶å‰å±¬æ€§ã€‘
${JSON.stringify(state.stats)}

ã€è¼¸å‡ºæ ¼å¼ã€‘
è«‹ä»¥å°èªªé¢¨æ ¼æå¯«åŠ‡æƒ…ã€‚åœ¨çµå°¾é€é JSON å€å¡Šæ›´æ–°éŠæˆ²ç‹€æ…‹ã€‚
æ ¼å¼ç¯„ä¾‹ï¼š
(åŠ‡æƒ…æ–‡æœ¬...)
\`\`\`json
{
  "hp_change": 0,
  "mp_change": 0,
  "time": "ä¸­åˆ",
  "weather": "æš´é›¨",
  "location": "é…’é¤¨",
  "npcs": [{"name":"è€é—†","rel":"å‹å–„"}],
  "story_options": ["é¸é …A", "é¸é …B"]
}
\`\`\`
ç¾åœ¨ï¼Œè«‹æ ¹æ“šä¸–ç•Œè§€ã€Œ${state.worldPrompt}ã€é–‹å§‹éŠæˆ²ï¼Œè®“ç©å®¶ç½®èº«æ–¼ä¸€å€‹å‹•æ…‹çš„å ´æ™¯ä¸­ã€‚`;
                
                conversationHistory = [{role:"user", parts:[{text:sysPrompt}]}];
                await callAI(`(ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼Œè«‹é–‹å§‹å†’éšª)`);
            } catch(e) { alert("å•Ÿå‹•å¤±æ•—: " + e.message); }
        }

        async function callAI(txt) {
            const log = document.getElementById('chat-log');
            log.innerHTML += `<div id="load-anim" class="msg gm">DM æ­£åœ¨æ€è€ƒ...</div>`; log.scrollTop=log.scrollHeight;
            
            // æ¯æ¬¡å°è©±éƒ½é™„å¸¶æœ€æ–°çš„ç‹€æ…‹æª¢æŸ¥ï¼Œé˜²æ­¢ AI å¿˜è¨˜æ•¸å€¼
            const stateContext = `[ç³»çµ±éš±è—è³‡è¨Š: ç•¶å‰ HP=${state.hp}, æ™‚é–“=${state.time}, åœ°é»=${state.location}]`;
            conversationHistory.push({role:"user", parts:[{text: txt + "\n" + stateContext}]});
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${confirmedModel}:generateContent?key=${window.USER_API_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
                        contents: conversationHistory,
                        generationConfig: { temperature: 0.7 } // ç¨å¾®é™ä½éš¨æ©Ÿæ€§ä»¥ä¿æŒé‚è¼¯
                    })
                });
                const data = await res.json();
                document.getElementById('load-anim').remove();
                
                if(!data.candidates) throw new Error("ç„¡å›æ‡‰");
                const aiTxt = data.candidates[0].content.parts[0].text;
                conversationHistory.push({role:"model", parts:[{text:aiTxt}]});
                processAIResponse(aiTxt);
            } catch(e) { 
                document.getElementById('load-anim')?.remove(); 
                addMsg("sys", "é€£ç·šéŒ¯èª¤: " + e.message); 
            }
        }

        function processAIResponse(txt) {
            const jsonMatch = txt.match(/```json\s*([\s\S]*?)\s*```/);
            let displayTxt = txt;

            if(jsonMatch) {
                try {
                    const u = JSON.parse(jsonMatch[1]);
                    // ç‹€æ…‹æ›´æ–°
                    if(u.hp_change) state.hp = Math.max(0, Math.min(state.maxHp, state.hp + u.hp_change));
                    if(u.mp_change) state.mp = Math.max(0, Math.min(state.maxMp, state.mp + u.mp_change));
                    if(u.time) state.time = u.time; 
                    if(u.location) state.location = u.location;
                    if(u.npcs) state.npcs = u.npcs;
                    if(u.story_options) renderOptions(u.story_options);
                    
                    // è‡ªå‹•å­˜æª”
                    localStorage.setItem('rpg_autosave_v48', JSON.stringify({state, history:conversationHistory}));
                    
                    // ç§»é™¤ JSON é¡¯ç¤º
                    displayTxt = txt.replace(jsonMatch[0], "");
                } catch(e){ console.error("JSON Parse Error", e); }
            }
            
            addMsg("gm", marked.parse(displayTxt));
            updateUI();
        }

        function renderOptions(opts) {
            const c = document.getElementById('options-area'); c.innerHTML="";
            opts.forEach(o => {
                const b = document.createElement('button'); b.className='opt-btn'; b.innerText=o;
                b.onclick = () => { 
                    const i = document.getElementById('user-input'); 
                    i.value = o; // ç›´æ¥å¡«å…¥
                    i.focus(); 
                };
                c.appendChild(b);
            });
        }

        function updateUI() {
            document.getElementById('hp-txt').innerText = `${state.hp}/${state.maxHp}`;
            document.getElementById('hp-bar').style.width = `${(state.hp/state.maxHp)*100}%`;
            document.getElementById('mp-txt').innerText = `${state.mp}/${state.maxMp}`;
            document.getElementById('mp-bar').style.width = `${(state.mp/state.maxMp)*100}%`;
            
            document.getElementById('location-display').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${state.location}`;
            document.getElementById('time-display').innerText = state.time;

            // æ›´æ–°å±¬æ€§é¡¯ç¤º (ä¿ç•™ä¸­æ–‡)
            for(let k in state.stats){
                const el = document.getElementById(`disp-${k}`);
                if(el) el.innerHTML = `<div class="attr-val">${state.stats[k]}</div><div class="attr-mod">(${getModStr(state.stats[k])})</div>`;
            }

            const npcDiv = document.getElementById('npc-list');
            if(state.npcs && state.npcs.length > 0) {
                npcDiv.innerHTML = state.npcs.map(n => `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #333;padding:4px;"><span style="color:#bb86fc">${n.name}</span><span style="color:#888;font-size:11px;">${n.rel}</span></div>`).join('');
            } else { npcDiv.innerHTML = "ç„¡é‡è¦ NPC"; }
        }

        function addMsg(r, h) { const l=document.getElementById('chat-log'); l.innerHTML+=`<div class="msg ${r}">${h}</div>`; l.scrollTop=l.scrollHeight; }
        
        window.sendMsg = () => { 
            const i=document.getElementById('user-input'); 
            if(!i.value.trim()) return; 
            addMsg("user",i.value); 
            callAI(i.value); 
            i.value=""; 
            document.getElementById('options-area').innerHTML=""; 
        };
        
        window.saveToCode = () => prompt("è«‹è¤‡è£½æ­¤å­˜æª”ç¢¼:", btoa(encodeURIComponent(JSON.stringify({state, history:conversationHistory}))));
        window.loadFromCode = () => { try{ loadGameData(JSON.parse(decodeURIComponent(atob(document.getElementById('load-code').value)))); }catch(e){alert("ç„¡æ•ˆçš„å­˜æª”ç¢¼");} };
        window.loadGameData = (d) => { state=d.state; conversationHistory=d.history; document.getElementById('setup-modal').classList.add('hidden'); updateUI(); if(!confirmedModel) detectModelAndStart().catch(()=>{}); };
        window.resetGame = () => { if(confirm("ç¢ºå®šè¦åˆªé™¤é€²åº¦é‡ç½®å—?")) { localStorage.removeItem('rpg_autosave_v48'); location.reload(); } };
    </script>
</body>
</html>
