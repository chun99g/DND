<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>RPG Engine V45 (New Model Assembly)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #bb86fc; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100%; }
        .sidebar { width: 420px; background: #181818; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        
        #dice-stage { width: 100%; height: 380px; background: #252525; position: relative; overflow: hidden; border-bottom: 1px solid #333; }
        #debug-log { 
            position: absolute; top: 10px; left: 10px; 
            color: #81c995; background: rgba(0,0,0,0.8); 
            padding: 8px; font-size: 11px; max-width: 90%; 
            pointer-events: none; white-space: pre-wrap; z-index: 10; 
        }

        .panel-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px; }
        .dice-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .d-btn { height: 36px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; background: #333; box-shadow: 0 2px 0 rgba(0,0,0,0.3); }
        .d-btn:hover { background: #444; }
        
        .card { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .header-bar { padding: 10px 20px; background: #181818; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; color: #aaa; font-size: 13px; }
        .chat-log { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; }
        .input-area { padding: 15px; background: #181818; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; background: #252525; border: 1px solid #444; color: white; border-radius: 24px; outline: none; padding-left: 20px; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; color: #000; }
        .hidden { display: none !important; }
        
        /* Modal, Attr Grid ç­‰æ¨£å¼çœç•¥ï¼Œä¿æŒåŸæœ¬ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #252525; width: 450px; padding: 30px; border-radius: 12px; border: 1px solid #444; }
        .modal-btn { width: 100%; padding: 12px; background: var(--accent); color: #000; border: none; border-radius: 6px; cursor: pointer; margin-top: 15px; }
        .msg { margin-bottom: 20px; max-width: 90%; padding: 12px 16px; border-radius: 8px; animation: fadeIn 0.3s; }
        .msg.gm { background: #252525; border-left: 4px solid var(--accent); color: #ddd; }
        .msg.user { background: #3d2c5e; color: #fff; margin-left: auto; text-align: right; }
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .attr-main { text-align: center; background: #2a2a2a; padding: 5px; border-radius: 4px; }
        .attr-val { font-size: 18px; font-weight: bold; color: var(--accent); }
        .attr-mod { font-size: 12px; color: var(--success); font-weight: bold; }
        .attr-lbl { font-size: 12px; color: #aaa; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal">
        <div class="modal-box">
            <h2 style="color:var(--accent);">ğŸš€ RPG Engine V45</h2>
            <p>è«‹è¼¸å…¥ä¸–ç•Œè§€ï¼š</p>
            <textarea id="world-prompt" rows="3" style="width:100%; background:#111; color:#fff; border:1px solid #444; padding:10px;" placeholder="D&D 5e..."></textarea>
            <button class="modal-btn" onclick="startCharacterCreation()">ä¸‹ä¸€æ­¥</button>
            <div style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
                <button onclick="loadFromCode()" style="padding:8px; cursor:pointer;">è®€å–å­˜æª”</button>
            </div>
        </div>
    </div>

    <div id="char-modal" class="modal hidden">
        <div class="modal-box">
            <h2>ğŸ² å±¬æ€§ç”Ÿæˆ</h2>
             <div style="background:#111; padding:10px; margin-bottom:15px; text-align:center;">(å±¬æ€§ç”Ÿæˆçœç•¥é¡¯ç¤ºï¼Œç›´æ¥é–‹å§‹)</div>
            <button class="modal-btn" onclick="randomizeStats(); confirmStart();">âœ… å¿«é€Ÿé–‹å§‹</button>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <div id="dice-stage">
                <div id="debug-log">V45 è®€å–ä¸­...</div>
            </div>
            <div class="panel-content">
                <div class="card">
                    <div class="dice-btn-grid">
                        <button class="d-btn" onclick="showDice(4)">D4</button>
                        <button class="d-btn" onclick="showDice(6)">D6</button>
                        <button class="d-btn" onclick="showDice(8)">D8</button>
                        <button class="d-btn" onclick="showDice(10)">D10</button>
                        <button class="d-btn" onclick="showDice(12)">D12</button>
                        <button class="d-btn" onclick="showDice(20)">D20</button>
                    </div>
                    <div style="text-align:center; font-size:11px; color:#777;">ä½¿ç”¨æ–°æ¨¡å‹: Diceassembly.fbx</div>
                </div>
                <div class="card">
                    <div class="card-header">å±¬æ€§</div>
                    <div class="attr-grid">
                        <div class="attr-main"><div class="attr-lbl">STR</div><div id="disp-str"></div></div>
                        <div class="attr-main"><div class="attr-lbl">DEX</div><div id="disp-dex"></div></div>
                        <div class="attr-main"><div class="attr-lbl">CON</div><div id="disp-con"></div></div>
                        <div class="attr-main"><div class="attr-lbl">INT</div><div id="disp-int"></div></div>
                        <div class="attr-main"><div class="attr-lbl">WIS</div><div id="disp-wis"></div></div>
                        <div class="attr-main"><div class="attr-lbl">CHA</div><div id="disp-cha"></div></div>
                    </div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="header-bar">
                <span id="location-display">èµ·å§‹é»</span>
            </div>
            <div id="chat-log" class="chat-log"><div class="msg gm">ç³»çµ±å°±ç·’ã€‚</div></div>
            <div id="options-area" class="options-container"></div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="è¼¸å…¥è¡Œå‹•..." autocomplete="off">
                <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        window.USER_API_KEY = ""; 

        let scene, camera, renderer, currentDice;
        let diceModels = {}; 
        let isSpinning = true;
        let allMeshes = [];

        function log(msg) {
            document.getElementById('debug-log').innerText += msg + "\n";
        }

        function init3D() {
            const container = document.getElementById('dice-stage');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x252525);
            
            // ç‡ˆå…‰è¨­å®š (ç¢ºä¿å…§åµŒæè³ªçœ‹å¾—åˆ°)
            const amb = new THREE.AmbientLight(0xffffff, 1.2); 
            scene.add(amb);
            const dir = new THREE.DirectionalLight(0xffffff, 2.0);
            dir.position.set(5, 10, 5);
            scene.add(dir);
            const front = new THREE.DirectionalLight(0xffffff, 1.5);
            front.position.set(0, 0, 10);
            scene.add(front);

            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(0, 3, 6);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // è¼‰å…¥æ–°çš„ FBX
            const fbxLoader = new FBXLoader();
            log("æ­£åœ¨è¼‰å…¥ Diceassembly.fbx...");
            
            // â˜…â˜…â˜… V45 æ›´æ”¹ï¼šè¼‰å…¥æ–°çš„æª”æ¡ˆåç¨± â˜…â˜…â˜…
            fbxLoader.load('./Diceassembly.fbx', (object) => {
                log("âœ… è¼‰å…¥æˆåŠŸï¼");
                
                object.traverse(child => {
                    if(child.isMesh) {
                        child.visible = false;
                        // ç´€éŒ„æè³ª (å¦‚æœ Blender åŒ¯å‡ºæœ‰å‹¾ Embed Texturesï¼Œé€™è£¡å°±æœƒæœ‰)
                        child.material.side = THREE.DoubleSide; // é˜²æ­¢ç ´é¢
                        allMeshes.push(child);
                        
                        // å¼·åˆ¶æ­¸é›¶èˆ‡ç¸®æ”¾
                        child.geometry.computeBoundingBox();
                        const center = new THREE.Vector3();
                        child.geometry.boundingBox.getCenter(center);
                        child.geometry.translate(-center.x, -center.y, -center.z);
                        child.scale.set(0.2, 0.2, 0.2);
                        
                        log(`ç™¼ç¾ç‰©ä»¶: ${child.name}`);
                    }
                });

                // è‡ªå‹•åˆ†é… (Blind Mapping)
                // å°‡æ‰¾åˆ°çš„å‰ 6 å€‹ç‰©ä»¶ä¾åºåˆ†é…çµ¦ D4, D6, D8...
                const order = [4, 6, 8, 10, 12, 20];
                allMeshes.forEach((mesh, index) => {
                    if (index < order.length) {
                        diceModels[order[index]] = mesh;
                    }
                });
                
                if(allMeshes.length === 0) log("âš ï¸ è­¦å‘Šï¼šæª”æ¡ˆè£¡æ²’æœ‰ Mesh ç‰©ä»¶");
                else log(`å…±æ‰¾åˆ° ${allMeshes.length} å€‹ç‰©ä»¶ï¼Œåˆ†é…å®Œæˆã€‚`);

            }, undefined, (e) => log("âŒ å¤±æ•—ï¼šæ‰¾ä¸åˆ° Diceassembly.fbx"));

            animate();
        }

        window.showDice = function(sides) {
            if(currentDice) scene.remove(currentDice);
            
            let mesh = diceModels[sides];
            
            // Fallback: å¦‚æœæ²’å°æ‡‰åˆ°ï¼Œç”¨ç¬¬1å€‹é ‚æ›¿
            if (!mesh && allMeshes.length > 0) mesh = allMeshes[0];

            if(mesh) {
                mesh = mesh.clone();
                mesh.visible = true;
                
                // é€™è£¡æˆ‘å€‘ä¿¡ä»» Blender åŒ¯å‡ºçš„æè³ªï¼Œä¸å¼·è¡Œè¦†è“‹
                // é™¤éæè³ªæ˜¯å…¨é»‘çš„ï¼Œæˆ‘å€‘æ‰è£œå…‰
                if (!mesh.material.map && !mesh.material.emissiveMap) {
                     mesh.material = new THREE.MeshStandardMaterial({
                        color: 0xeeeeee, roughness: 0.3, metalness: 0.1
                    });
                }

                scene.add(mesh);
                currentDice = mesh;
                mesh.rotation.x = Math.random() * Math.PI;
                mesh.rotation.y = Math.random() * Math.PI;
                isSpinning = true;
            }
        };

        function animate() {
            requestAnimationFrame(animate);
            if(currentDice && isSpinning) {
                currentDice.rotation.y += 0.015;
                currentDice.rotation.x += 0.005;
            }
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', () => {
            const c = document.getElementById('dice-stage');
            camera.aspect = c.clientWidth / c.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(c.clientWidth, c.clientHeight);
        });

        init3D();
    </script>

    <script>
        let confirmedModel = ""; 
        let conversationHistory = []; 
        let state = { hp: 10, maxHp: 10, mp: 10, maxMp: 10, mpLabel: "MP", san: 100, maxSan: 100, stats: { str:10, dex:10, con:10, int:10, wis:10, cha:10 }, inventory: [], npcs: [], time: "åˆå§‹", weather: "æœªçŸ¥", location: "èµ·å§‹é»", worldPrompt: "" };

        window.onload = function() {
            const cachedKey = localStorage.getItem('my_gemini_key_v1');
            if (cachedKey) window.USER_API_KEY = cachedKey;
        };

        function startCharacterCreation() {
            state.worldPrompt = document.getElementById('world-prompt').value.trim() || "D&D 5e";
            if(!window.USER_API_KEY) {
                const inputKey = prompt("API Key:", "");
                if(inputKey) {
                    window.USER_API_KEY = inputKey;
                    localStorage.setItem('my_gemini_key_v1', inputKey);
                } else return;
            }
            randomizeStats();
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('char-modal').classList.remove('hidden');
        }

        function randomizeStats() {
            const keys=['str','dex','con','int','wis','cha'];
            keys.forEach(k=>state.stats[k]=10); 
            // ç°¡åŒ–é‚è¼¯ï¼Œç›´æ¥çµ¦é è¨­å€¼ä»¥åŠ é€Ÿæ¸¬è©¦
            renderStatEditor();
        }

        function renderStatEditor() {
            let h=''; const map={str:'åŠ›é‡',dex:'æ•æ·',con:'é«”è³ª',int:'æ™ºåŠ›',wis:'æ„ŸçŸ¥',cha:'é­…åŠ›'};
            for(let k in state.stats){
                h+=`<div class="attr-edit-box"><div class="attr-lbl">${map[k]}</div><div class="attr-val">${state.stats[k]}</div></div>`;
            }
            // é€™è£¡ç°¡åŒ–äº† UI ä»¥é…åˆä¸Šæ–¹ HTML
            updateUI();
        }
        
        function confirmStart() {
            document.getElementById('char-modal').classList.add('hidden');
            updateUI();
            addMsg("sys","ä¸–ç•Œæ§‹å»ºä¸­...");
            detectModelAndStart();
        }

        async function detectModelAndStart() {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${window.USER_API_KEY}`);
                const data = await res.json();
                const m = (data.models||[]).find(x=>x.name.includes("gemini-1.5-flash")||x.name.includes("gemini-pro"));
                if(!m) throw new Error("Key error");
                confirmedModel = m.name.replace("models/","");
                
                const sysPrompt = `ä½ æ˜¯ä¸€ä½ D&D 5e DMã€‚ç°¡çŸ­é–‹å ´ã€‚`;
                conversationHistory = [{role:"user", parts:[{text:sysPrompt}]}, {role:"model", parts:[{text:"..."}]}];
                await callAI(`ä¸–ç•Œè§€ï¼š${state.worldPrompt}ã€‚é–‹å§‹ã€‚`);
            } catch(e) { alert("Error: " + e.message); }
        }

        async function callAI(txt) {
            const log = document.getElementById('chat-log');
            log.innerHTML += `<div id="load-anim" class="msg gm">...</div>`; log.scrollTop=log.scrollHeight;
            conversationHistory.push({role:"user", parts:[{text:txt}]});
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${confirmedModel}:generateContent?key=${window.USER_API_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:conversationHistory})
                });
                const data = await res.json();
                document.getElementById('load-anim').remove();
                const aiTxt = data.candidates[0].content.parts[0].text;
                conversationHistory.push({role:"model", parts:[{text:aiTxt}]});
                processAIResponse(aiTxt);
            } catch(e) { document.getElementById('load-anim')?.remove(); }
        }

        function processAIResponse(txt) {
            addMsg("gm", marked.parse(txt));
        }

        function updateUI() {
            const map = {str:'disp-str', dex:'disp-dex', con:'disp-con', int:'disp-int', wis:'disp-wis', cha:'disp-cha'};
            for(let k in map) {
                const el = document.getElementById(map[k]);
                if(el) el.innerHTML = `<div class="attr-val">${state.stats[k]}</div>`;
            }
        }

        function addMsg(r, h) { const l=document.getElementById('chat-log'); l.innerHTML+=`<div class="msg ${r}">${h}</div>`; l.scrollTop=l.scrollHeight; }
        window.sendMsg = () => { const i=document.getElementById('user-input'); if(!i.value.trim())return; addMsg("user",i.value); callAI(i.value); i.value=""; document.getElementById('options-area').innerHTML=""; };
    </script>
</body>
</html>
