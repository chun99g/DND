<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>RPG Engine V46 (Final Polish)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. V39 æ ¸å¿ƒæ¨£å¼ --- */
        :root { 
            --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; 
            --accent: #bb86fc; --success: #03dac6; --warn: #cf6679; 
            /* Google éª°å­é¡è‰² */
            --d4: #34a853; --d6: #2ab7ca; --d8: #a142f4;
            --d10: #f43f5e; --d12: #ea4335; --d20: #fb8c00;
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        .app-container { display: flex; height: 100%; }
        .sidebar { width: 400px; background: #181818; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

        /* --- 2. Google Style 2D éª°å­å€ (é«˜åº¦ç¸®æ¸›) --- */
        #dice-stage { 
            width: 100%; 
            height: 200px; /* ç¸®å°åˆ° 200pxï¼Œæ›´çœç©ºé–“ */
            background: #e8eaed; 
            position: relative; overflow: hidden; border-bottom: 1px solid #333; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        #active-dice-area {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;
            width: 100%; padding: 10px; box-sizing: border-box;
            max-height: 180px; overflow-y: auto;
        }

        /* 2D éª°å­ */
        .die {
            width: 45px; height: 45px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold; color: white;
            cursor: pointer; user-select: none; transition: transform 0.1s;
            position: relative;
        }
        .die:hover { transform: scale(1.1); }
        .die.rolling { animation: shake 0.5s infinite; }

        .die-d4 { background: var(--d4); clip-path: polygon(50% 0%, 0% 100%, 100% 100%); padding-top: 5px; height: 40px; }
        .die-d6 { background: var(--d6); border-radius: 4px; }
        .die-d8 { background: var(--d8); clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .die-d10 { background: var(--d10); clip-path: polygon(50% 0%, 100% 38%, 50% 100%, 0% 38%); }
        .die-d12 { background: var(--d12); clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); }
        .die-d20 { background: var(--d20); clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%); }

        #dice-total {
            position: absolute; bottom: 5px; right: 10px;
            font-size: 18px; color: #5f6368; font-weight: bold;
            background: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 4px;
            pointer-events: none;
        }

        /* --- 3. é¢æ¿å…§å®¹ --- */
        .panel-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px; }
        
        .dice-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 5px; }
        .d-btn { 
            height: 32px; border: none; border-radius: 4px; color: white; font-weight: bold; 
            cursor: pointer; font-size: 12px; background: #333; 
            box-shadow: 0 2px 0 rgba(0,0,0,0.3); transition: transform 0.1s; 
        }
        .d-btn:active { transform: scale(0.95); }
        .btn-d4 { border-bottom: 3px solid var(--d4); } .btn-d6 { border-bottom: 3px solid var(--d6); }
        .btn-d8 { border-bottom: 3px solid var(--d8); } .btn-d10 { border-bottom: 3px solid var(--d10); }
        .btn-d12 { border-bottom: 3px solid var(--d12); } .btn-d20 { border-bottom: 3px solid var(--d20); }

        #roll-btn {
            width: 100%; padding: 8px; margin-top: 5px;
            background: var(--accent); color: #000; font-weight: bold; border: none;
            border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        #roll-btn:hover { background: #fff; }

        .card { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .card-header { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 4px; }
        
        /* ç‹€æ…‹æ¢ï¼šMP/SAN é è¨­éš±è— */
        .stat-row-container { margin-bottom: 8px; }
        .stat-row-container.hidden { display: none; }
        .bar-wrap { background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 2px; }
        .bar-fill { height: 100%; transition: width 0.5s ease; }
        .stat-row { display: flex; justify-content: space-between; font-size: 12px; color: #ccc; }

        /* å±¬æ€§ï¼šå¢åŠ ä¸­æ–‡å */
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .attr-main { text-align: center; background: #2a2a2a; padding: 6px; border-radius: 4px; }
        .attr-val { font-size: 16px; font-weight: bold; color: var(--accent); display: block; line-height: 1.2; }
        .attr-mod { font-size: 11px; color: var(--success); font-weight: bold; margin-left: 2px; }
        .attr-lbl { font-size: 10px; color: #888; display: block; margin-top: 2px; }
        .attr-cn { font-size: 10px; color: #666; display: block; } /* ä¸­æ–‡å */

        /* --- 4. èŠå¤©å€ --- */
        .header-bar { padding: 10px 20px; background: #181818; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #aaa; }
        .chat-log { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; font-size: 15px; line-height: 1.6; padding-bottom: 100px; }
        .msg { margin-bottom: 20px; max-width: 90%; padding: 12px 16px; border-radius: 8px; animation: fadeIn 0.3s; }
        .msg.gm { background: #252525; border-left: 4px solid var(--accent); color: #ddd; }
        .msg.user { background: #3d2c5e; color: #fff; margin-left: auto; text-align: right; }
        
        .options-container { padding: 10px 15px; background: #181818; display: flex; flex-wrap: wrap; gap: 8px; border-top: 1px solid #333; }
        .opt-btn { background: #2a2a2a; color: #bbb; border: 1px solid #444; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 13px; transition: 0.2s; text-align: left; }
        .opt-btn:hover { background: #333; color: var(--accent); border-color: var(--accent); }

        .input-area { padding: 15px; background: #181818; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; background: #252525; border: 1px solid #444; color: white; border-radius: 24px; outline: none; padding-left: 20px; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; color: #000; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #252525; width: 450px; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-btn { width: 100%; padding: 12px; background: var(--accent); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .hidden { display: none !important; }
        
        .attr-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #333; }
        .attr-val-box { display: flex; align-items: center; gap: 10px; color: white; }
        .circle-btn { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #555; background: #333; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }

        @keyframes shake {
            0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 
            50% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); }
        }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal">
        <div class="modal-box">
            <h2 style="color:var(--accent); margin-top:0;">ğŸš€ RPG Engine V46</h2>
            <p style="color:#aaa; font-size:12px;">Final Polish Edition</p>
            <p>ä¸–ç•Œè§€è¨­å®šï¼š</p>
            <textarea id="world-prompt" rows="3" style="width:100%; background:#111; color:#fff; border:1px solid #444; padding:10px; border-radius:4px;" placeholder="ä¾‹å¦‚ï¼šé¾èˆ‡åœ°ä¸‹åŸ D&D 5e..."></textarea>
            <button class="modal-btn" onclick="startCharacterCreation()">ä¸‹ä¸€æ­¥ï¼šç”Ÿæˆè§’è‰²</button>
            <div style="margin-top:20px; text-align:right;">
                <input type="password" id="api-key-input" placeholder="API Key (é¸å¡«)" style="background:#111; border:1px solid #444; color:#fff; padding:5px; width:150px; display:none;">
                <button style="background:none; border:none; color:#888; font-size:12px; cursor:pointer;" onclick="toggleKeyInput()">è¨­å®š Key</button> | 
                <button style="background:none; border:none; color:#888; font-size:12px; cursor:pointer;" onclick="loadGameFromPrompt()">è®€å–èˆŠæª”</button>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal hidden">
        <div class="modal-box">
            <h2 style="color:var(--success);">ğŸ“Š å±¬æ€§åˆ†é…</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button class="modal-btn" style="width:48%; background:#444; color:white;" onclick="randomStats()">ğŸ² éš¨æ©Ÿ (72-80)</button>
                <div style="color:#aaa; display:flex; align-items:center;">ç¸½å’Œ: <span id="points-total" style="color:white; font-weight:bold; margin-left:5px;">0</span></div>
            </div>
            <div id="stats-editor"></div>
            <button class="modal-btn" onclick="startGame()">âœ… é–‹å§‹å†’éšª</button>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            
            <div class="card" style="border-radius:0; border:none;">
                <div id="dice-stage">
                    <div id="active-dice-area"></div>
                    <div id="dice-total"></div>
                </div>
                <div class="card" style="border-radius:0; border-top:none; background:#222;">
                    <div class="dice-btn-grid">
                        <button class="d-btn btn-d4" onclick="addDie(4)">D4</button>
                        <button class="d-btn btn-d6" onclick="addDie(6)">D6</button>
                        <button class="d-btn btn-d8" onclick="addDie(8)">D8</button>
                        <button class="d-btn btn-d10" onclick="addDie(10)">D10</button>
                        <button class="d-btn btn-d12" onclick="addDie(12)">D12</button>
                        <button class="d-btn btn-d20" onclick="addDie(20)">D20</button>
                    </div>
                    <button id="roll-btn" onclick="rollDice()">ğŸ² æ“²å‡ºéª°å­</button>
                </div>
            </div>

            <div class="panel-content">
                <div class="card">
                    <div class="card-header">ç‹€æ…‹</div>
                    
                    <div class="stat-row-container">
                        <div class="stat-row"><span>HP</span> <span id="hp-txt">--/--</span></div>
                        <div class="bar-wrap"><div id="hp-bar" class="bar-fill" style="width:100%; background:var(--warn);"></div></div>
                    </div>

                    <div class="stat-row-container hidden" id="mp-row">
                        <div class="stat-row"><span id="mp-label">MP</span> <span id="mp-txt">--/--</span></div>
                        <div class="bar-wrap"><div id="mp-bar" class="bar-fill" style="width:100%; background:var(--success);"></div></div>
                    </div>

                    <div class="stat-row-container hidden" id="san-row">
                        <div class="stat-row"><span>SAN</span> <span id="san-txt">--/--</span></div>
                        <div class="bar-wrap"><div id="san-bar" class="bar-fill" style="width:100%; background:var(--accent);"></div></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">å±¬æ€§</div>
                    <div class="attr-grid" id="disp-stats"></div>
                </div>

                <div class="card">
                    <div class="card-header">äººç‰©é—œä¿‚</div>
                    <div id="npc-list" style="font-size:13px; color:#aaa; padding:5px;">å°šç„¡è¨˜éŒ„</div>
                </div>

                <div class="card" style="flex:1">
                    <div class="card-header">ç‰©å“</div>
                    <div id="inv-list" style="font-size:13px; color:#aaa; padding:5px;">ç„¡</div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="header-bar">
                <div style="flex:1;">
                    <span id="loc-disp"><i class="fas fa-map-marker-alt"></i> è™›ç©º</span> | 
                    <span id="time-disp">åˆå§‹</span>
                </div>
                <div>
                    <button style="background:none; border:none; color:#aaa; cursor:pointer;" onclick="saveGame()">ğŸ’¾ å­˜æª”</button>
                    <button style="background:none; border:none; color:#f55; margin-left:10px; cursor:pointer;" onclick="resetGame()">ğŸ—‘ï¸ é‡ç½®</button>
                </div>
            </div>

            <div id="chat-log">
                <div class="msg gm">ç³»çµ±å°±ç·’ã€‚è«‹å®Œæˆè¨­å®šã€‚</div>
            </div>

            <div class="options-container" id="options-area"></div>

            <div class="input-area">
                <input type="text" id="user-input" placeholder="è¼¸å…¥è¡Œå‹•..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script>
        let apiKey = "";
        let conversationHistory = [];
        let diceBag = [];
        let state = {
            stats: { STR:10, DEX:10, CON:10, INT:10, WIS:10, CHA:10 },
            hp: 10, maxHp: 10, mp: 0, maxMp: 0, san: 0, maxSan: 0,
            mpLabel: null, // æœ‰å€¼æ‰æœƒé¡¯ç¤º MP æ¢
            npcs: [], inventory: [],
            location: "æœªçŸ¥", time: "æœªçŸ¥"
        };

        const ATTR_MAP = {
            STR: "åŠ›é‡", DEX: "æ•æ·", CON: "é«”è³ª", INT: "æ™ºåŠ›", WIS: "æ„ŸçŸ¥", CHA: "é­…åŠ›"
        };

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            const savedKey = localStorage.getItem('gemini_key');
            if(savedKey) { apiKey = savedKey; }
        };

        function toggleKeyInput() {
            const el = document.getElementById('api-key-input');
            el.style.display = el.style.display === 'none' ? 'inline-block' : 'none';
        }

        function startCharacterCreation() {
            const inputKey = document.getElementById('api-key-input').value.trim();
            if(inputKey) { apiKey = inputKey; localStorage.setItem('gemini_key', inputKey); }
            
            if(!apiKey) {
                const k = prompt("è«‹è¼¸å…¥ API Key (å¿…å¡«):");
                if(k) { apiKey = k; localStorage.setItem('gemini_key', k); }
                else return;
            }

            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('stats-modal').classList.remove('hidden');
            randomStats(); // é è¨­éš¨æ©Ÿä¸€æ¬¡
        }

        // --- å±¬æ€§é…é» ---
        function renderStatsEditor() {
            const container = document.getElementById('stats-editor');
            container.innerHTML = "";
            let total = 0;
            for(let key in state.stats) {
                total += state.stats[key];
                container.innerHTML += `
                    <div class="attr-row">
                        <span style="color:#aaa; width:60px;">${key}</span>
                        <div class="attr-val-box">
                            <div class="circle-btn" onclick="modStat('${key}', -1)">-</div>
                            <span id="edit-${key}" style="width:25px; text-align:center;">${state.stats[key]}</span>
                            <div class="circle-btn" onclick="modStat('${key}', 1)">+</div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('points-total').innerText = total;
        }

        function modStat(key, val) {
            state.stats[key] += val;
            renderStatsEditor();
        }

        function randomStats() {
            for(let key in state.stats) {
                state.stats[key] = Math.floor(Math.random() * 7) + 9; // 9~15
            }
            renderStatsEditor();
        }

        // --- éª°å­é‚è¼¯ ---
        function addDie(sides) {
            diceBag.push({ sides: sides, val: sides });
            renderDice();
        }

        function renderDice() {
            const area = document.getElementById('active-dice-area');
            area.innerHTML = "";
            let total = 0;
            diceBag.forEach((d, idx) => {
                const div = document.createElement('div');
                div.className = `die die-d${d.sides}`;
                div.innerText = d.val;
                div.onclick = () => { diceBag.splice(idx, 1); renderDice(); };
                area.appendChild(div);
                total += d.val;
            });
            document.getElementById('dice-total').innerText = diceBag.length ? `Total: ${total}` : "";
        }

        function rollDice() {
            if(diceBag.length === 0) return;
            const els = document.querySelectorAll('.die');
            els.forEach(e => e.classList.add('rolling'));
            
            setTimeout(() => {
                diceBag.forEach(d => d.val = Math.floor(Math.random() * d.sides) + 1);
                renderDice();
                els.forEach(e => e.classList.remove('rolling'));
                // ä¸è‡ªå‹•å¡«å…¥ï¼Œè®“ç©å®¶è‡ªå·±çœ‹
            }, 600);
        }

        // --- éŠæˆ²é‚è¼¯ ---
        async function startGame() {
            document.getElementById('stats-modal').classList.add('hidden');
            updateHUD();
            
            const world = document.getElementById('world-prompt').value || "D&D 5e";
            const sysPrompt = `ä½ æ˜¯ä¸€å€‹ TRPG DMã€‚ä¸–ç•Œè§€ï¼š${world}ã€‚
            è¦å‰‡ï¼š
            1. æ¯æ¬¡å›å¾©æ¨å‹•åŠ‡æƒ…ï¼Œçµå°¾çµ¦é¸é …ã€‚
            2. ç©å®¶è¡Œå‹•éœ€è¦æª¢å®šæ™‚ï¼Œè«‹å‘ŠçŸ¥ç›®æ¨™å€¼ã€‚
            3. å›æ‡‰çµå°¾å¿…é™„ JSON (ä¸è¦é¡¯ç¤ºçµ¦ç©å®¶)ï¼š
            \`\`\`json
            {
                "hp_change": 0,
                "mp_change": 0, "mp_label": null, // å¦‚æœæœ‰é­”æ³•ç³»çµ±æ‰çµ¦ label
                "san_change": 0,
                "location": "åœ°é»",
                "time": "æ™‚é–“",
                "npcs": [{"name":"åå­—", "rel":"é—œä¿‚"}],
                "inventory": ["ç‰©å“"],
                "options": ["é¸é …1", "é¸é …2"]
            }
            \`\`\`
            `;
            
            conversationHistory = [{ role: "user", parts: [{ text: sysPrompt }] }];
            addMsg("gm", "æ­£åœ¨æ§‹å»ºä¸–ç•Œ...", true);
            await callGemini("è«‹é–‹å§‹éŠæˆ²ï¼Œæè¿°é–‹å ´ï¼Œä¸¦å‘Šè¨´æˆ‘ç¾åœ¨çš„ç‹€æ…‹ã€‚");
        }

        async function sendMsg() {
            const input = document.getElementById('user-input');
            const txt = input.value.trim();
            if(!txt) return;
            
            addMsg("user", txt);
            input.value = "";
            document.getElementById('options-area').innerHTML = ""; // æ¸…ç©ºé¸é …
            addMsg("gm", "...", true);
            
            await callGemini(txt);
        }

        async function callGemini(text) {
            conversationHistory.push({ role: "user", parts: [{ text: text }] });
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: conversationHistory })
                });
                const data = await res.json();
                document.querySelectorAll('.loading').forEach(e => e.remove());
                
                if(data.candidates) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    processResponse(aiText);
                    conversationHistory.push({ role: "model", parts: [{ text: aiText }] });
                } else {
                    addMsg("gm", "API Error: " + JSON.stringify(data));
                }
            } catch(e) {
                addMsg("gm", "é€£ç·šéŒ¯èª¤");
            }
        }

        function processResponse(text) {
            const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
            let displayText = text;
            
            if(jsonMatch) {
                try {
                    const data = JSON.parse(jsonMatch[1]);
                    // æ›´æ–°ç‹€æ…‹
                    if(data.location) state.location = data.location;
                    if(data.time) state.time = data.time;
                    if(data.npcs) state.npcs = data.npcs;
                    if(data.inventory) state.inventory = data.inventory;
                    
                    // æ•¸å€¼è®Šæ›´
                    if(data.hp_change) state.hp = Math.max(0, Math.min(state.maxHp, state.hp + data.hp_change));
                    if(data.mp_label) state.mpLabel = data.mp_label; // é–‹å•Ÿ MP æ¢
                    if(data.san_change) {
                        state.san += data.san_change; 
                        if(!state.maxSan) state.maxSan = 100; // ç¬¬ä¸€æ¬¡è®Šå‹•æ™‚åˆå§‹åŒ–
                    }

                    if(data.options) renderOptions(data.options);
                    
                    updateHUD();
                    displayText = text.replace(jsonMatch[0], "");
                } catch(e) {}
            }
            addMsg("gm", marked.parse(displayText));
        }

        function renderOptions(opts) {
            const area = document.getElementById('options-area');
            area.innerHTML = "";
            opts.forEach(o => {
                const b = document.createElement('button');
                b.className = 'opt-btn';
                b.innerText = o;
                b.onclick = () => { document.getElementById('user-input').value = o; sendMsg(); };
                area.appendChild(b);
            });
        }

        function updateHUD() {
            // å±¬æ€§
            const attrBox = document.getElementById('disp-stats');
            attrBox.innerHTML = "";
            for(let k in state.stats) {
                const val = state.stats[k];
                const mod = Math.floor((val-10)/2);
                const sign = mod>=0?"+":"";
                attrBox.innerHTML += `
                    <div class="attr-main">
                        <span class="attr-lbl">${k}</span>
                        <span class="attr-cn">${ATTR_MAP[k]}</span>
                        <span class="attr-val">${val}<span class="attr-mod">(${sign}${mod})</span></span>
                    </div>
                `;
            }

            // ç‹€æ…‹æ¢
            document.getElementById('hp-txt').innerText = `${state.hp}/${state.maxHp}`;
            document.getElementById('hp-bar').style.width = `${(state.hp/state.maxHp)*100}%`;

            // MP & SAN å‹•æ…‹é¡¯ç¤º
            const mpRow = document.getElementById('mp-row');
            if(state.mpLabel) {
                mpRow.classList.remove('hidden');
                document.getElementById('mp-label').innerText = state.mpLabel;
                // MP é‚è¼¯å¯å†æ“´å……
            } else { mpRow.classList.add('hidden'); }

            const sanRow = document.getElementById('san-row');
            if(state.maxSan > 0) {
                sanRow.classList.remove('hidden');
                document.getElementById('san-txt').innerText = `${state.san}/${state.maxSan}`;
                document.getElementById('san-bar').style.width = `${(state.san/state.maxSan)*100}%`;
            } else { sanRow.classList.add('hidden'); }

            // NPC & ç‰©å“
            document.getElementById('npc-list').innerHTML = state.npcs.length 
                ? state.npcs.map(n=>`<div><b style="color:#bb86fc">${n.name}</b>: ${n.rel}</div>`).join('') 
                : "å°šç„¡è¨˜éŒ„";
            document.getElementById('inv-list').innerText = state.inventory.join(", ") || "ç„¡";

            // Header
            document.getElementById('loc-disp').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${state.location}`;
            document.getElementById('time-disp').innerText = state.time;
        }

        function addMsg(role, html, loading=false) {
            const box = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = `msg ${role} ${loading?'loading':''}`;
            div.innerHTML = html;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function saveGame() {
            const data = btoa(encodeURIComponent(JSON.stringify({state, history:conversationHistory})));
            prompt("è¤‡è£½å­˜æª”ç¢¼:", data);
        }
        
        function loadGameFromPrompt() {
            const code = prompt("è«‹è²¼ä¸Šå­˜æª”ç¢¼:");
            if(code) {
                try {
                    const data = JSON.parse(decodeURIComponent(atob(code)));
                    state = data.state;
                    conversationHistory = data.history;
                    document.getElementById('setup-modal').classList.add('hidden');
                    updateHUD();
                    // æ¢å¾©å°è©±ç´€éŒ„
                    const log = document.getElementById('chat-log');
                    log.innerHTML = "";
                    conversationHistory.forEach(m => {
                        if(m.role==='user' && m.parts[0].text.includes('JSON')) return;
                        let t = m.parts[0].text.replace(/```json[\s\S]*```/, "");
                        addMsg(m.role==='model'?'gm':'user', marked.parse(t));
                    });
                } catch(e) { alert("è®€å–å¤±æ•—"); }
            }
        }
        
        function resetGame() { if(confirm("é‡ç½®?")) location.reload(); }
    </script>
</body>
</html>
