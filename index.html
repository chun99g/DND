<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>RPG Engine V48 (Hardcore DND)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ (V39.1/V47 åŸºåº•) --- */
        :root { 
            --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; 
            --accent: #bb86fc; --success: #03dac6; --warn: #cf6679; 
            --d4: #34a853; --d6: #2ab7ca; --d8: #a142f4;
            --d10: #f43f5e; --d12: #ea4335; --d20: #fb8c00;
        }
        body { margin: 0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        .app-container { display: flex; height: 100%; }
        .sidebar { width: 420px; background: #181818; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

        /* --- 2D éª°å­å€ --- */
        #dice-stage { 
            width: 100%; height: 200px; background: #e8eaed; 
            position: relative; overflow: hidden; border-bottom: 1px solid #333; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #active-dice-area {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;
            width: 100%; padding: 10px; max-height: 180px; overflow-y: auto;
        }
        .die {
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: bold; color: white; cursor: pointer; user-select: none;
            transition: transform 0.1s; position: relative;
        }
        .die:hover { transform: scale(1.1); }
        .die.rolling { animation: shake 0.3s infinite linear; } /* åŠ å¿«éœ‡å‹•é »ç‡æ¨¡æ“¬çœŸå¯¦æ„Ÿ */

        .die-d4 { background: var(--d4); clip-path: polygon(50% 0%, 0% 100%, 100% 100%); padding-top: 5px; height: 40px; }
        .die-d6 { background: var(--d6); border-radius: 4px; }
        .die-d8 { background: var(--d8); clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .die-d10 { background: var(--d10); clip-path: polygon(50% 0%, 100% 38%, 50% 100%, 0% 38%); }
        .die-d12 { background: var(--d12); clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); }
        .die-d20 { background: var(--d20); clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%); }

        #dice-total {
            position: absolute; bottom: 5px; right: 10px; font-size: 18px; color: #5f6368; 
            font-weight: bold; background: rgba(255,255,255,0.9); padding: 2px 6px; border-radius: 4px; pointer-events: none;
        }

        /* --- å·¦å´é¢æ¿ --- */
        .panel-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px; }
        .card { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .card-header { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 8px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 4px; }
        
        .dice-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 5px; }
        .d-btn { height: 32px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; background: #333; box-shadow: 0 2px 0 rgba(0,0,0,0.3); }
        .d-btn:active { transform: scale(0.95); }
        .btn-d4 { border-bottom: 3px solid var(--d4); } .btn-d6 { border-bottom: 3px solid var(--d6); }
        .btn-d8 { border-bottom: 3px solid var(--d8); } .btn-d10 { border-bottom: 3px solid var(--d10); }
        .btn-d12 { border-bottom: 3px solid var(--d12); } .btn-d20 { border-bottom: 3px solid var(--d20); }

        #roll-btn { width: 100%; padding: 8px; margin-top: 5px; background: var(--accent); color: #000; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; }
        #roll-btn:hover { background: #fff; }

        /* ç‹€æ…‹ & å±¬æ€§ */
        .stat-row-container { margin-bottom: 8px; }
        .stat-row-container.hidden { display: none; }
        .bar-wrap { background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 2px; }
        .bar-fill { height: 100%; transition: width 0.5s ease; }
        .stat-row { display: flex; justify-content: space-between; font-size: 12px; color: #ccc; }

        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .attr-main { text-align: center; background: #2a2a2a; padding: 6px; border-radius: 4px; }
        .attr-val { font-size: 16px; font-weight: bold; color: var(--accent); display: block; line-height: 1.2; }
        .attr-mod { font-size: 11px; color: var(--success); font-weight: bold; margin-left: 2px; }
        .attr-lbl { font-size: 10px; color: #888; display: block; margin-top: 2px; }
        .attr-cn { font-size: 10px; color: #666; display: block; }

        /* --- èŠå¤©å€ --- */
        .header-bar { padding: 10px 20px; background: #181818; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #aaa; }
        .chat-log { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; font-size: 15px; line-height: 1.6; padding-bottom: 100px; }
        .msg { margin-bottom: 20px; max-width: 90%; padding: 12px 16px; border-radius: 8px; animation: fadeIn 0.3s; }
        .msg.gm { background: #252525; border-left: 4px solid var(--accent); color: #ddd; }
        .msg.user { background: #3d2c5e; color: #fff; margin-left: auto; text-align: right; }
        
        .options-container { padding: 10px 15px; background: #181818; display: flex; flex-wrap: wrap; gap: 8px; border-top: 1px solid #333; }
        .opt-btn { background: #2a2a2a; color: #bbb; border: 1px solid #444; padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 13px; transition: 0.2s; text-align: left; }
        .opt-btn:hover { background: #333; color: var(--accent); border-color: var(--accent); }

        .input-area { padding: 15px; background: #181818; display: flex; gap: 10px; border-top: 1px solid #333; }
        input[type="text"] { flex: 1; padding: 12px; background: #252525; border: 1px solid #444; color: white; border-radius: 24px; outline: none; padding-left: 20px; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; color: #000; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #252525; width: 500px; padding: 30px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-btn { width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .hidden { display: none !important; }
        
        .attr-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #333; }
        .attr-val-box { display: flex; align-items: center; gap: 10px; color: white; }
        .circle-btn { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #555; background: #333; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }

        @keyframes shake {
            0% { transform: rotate(0deg) translate(1px, 1px); }
            25% { transform: rotate(5deg) translate(-1px, -2px); }
            50% { transform: rotate(-5deg) translate(-3px, 0px); }
            75% { transform: rotate(5deg) translate(3px, 2px); }
            100% { transform: rotate(0deg) translate(1px, -1px); }
        }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal">
        <div class="modal-box">
            <h2 style="color:var(--accent); margin-top:0;">ğŸ² RPG å•Ÿå‹•å™¨ V48</h2>
            
            <label style="display:block; margin-bottom:5px; color:#aaa;">Gemini API Key</label>
            <input type="password" id="api-key-input" style="width:100%; padding:10px; margin-bottom:15px; background:#202124; border:1px solid #555; color:white;">

            <label style="display:block; margin-bottom:5px; color:#aaa;">ä¸–ç•Œè§€è¨­å®š</label>
            <textarea id="world-prompt" rows="3" style="width:100%; padding:10px; background:#202124; border:1px solid #555; color:white;" placeholder="ä¾‹å¦‚ï¼šè¢«éºå¿˜çš„åœ‹åº¦ã€å…‹è˜‡é­¯çš„å‘¼å–š..."></textarea>
            
            <div style="margin-top:20px; border-top:1px solid #555; padding-top:15px;">
                <label style="color:#aaa;">è®€å–å­˜æª” (Base64)</label>
                <input type="text" id="load-code" placeholder="è²¼ä¸Šå­˜æª”ç¢¼..." style="width:100%; padding:10px; background:#202124; border:1px solid #555; color:white; margin-bottom:10px;">
                <button class="modal-btn" style="background:#555; color:white;" onclick="loadGame()">ğŸ“‚ è®€å–</button>
            </div>

            <button class="modal-btn" onclick="goToStats()">â¡ï¸ å‰µè§’ (åˆ†é…å±¬æ€§)</button>
        </div>
    </div>

    <div id="stats-modal" class="modal hidden">
        <div class="modal-box">
            <h2 style="color:var(--success);">ğŸ“Š å‰µå»ºè§’è‰²å±¬æ€§</h2>
            <p style="font-size:13px; color:#aaa; margin-bottom:10px;">è«‹åˆ†é…æ‚¨çš„æ ¸å¿ƒå±¬æ€§ (ç¯„åœ 72-80 æˆ–æ‰‹å‹•)</p>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <button class="modal-btn" style="width:48%; background:#555; color:white;" onclick="randomStats()">ğŸ² éš¨æ©Ÿæ“²éª°</button>
                <div style="color:#aaa; display:flex; align-items:center;">ç¸½é»æ•¸: <span id="points-total" style="color:white; font-weight:bold; margin-left:5px;">0</span></div>
            </div>
            
            <div id="stats-editor"></div>

            <button class="modal-btn" onclick="startGame()">âœ… å®Œæˆå‰µè§’ï¼Œé€²å…¥ä¸–ç•Œ</button>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <div class="card" style="border-radius:0; border:none;">
                <div id="dice-stage">
                    <div id="active-dice-area">
                        <div style="color:#888; font-size:12px; margin-top:20px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥éª°å­</div>
                    </div>
                    <div id="dice-total"></div>
                </div>
                <div class="card" style="border-radius:0; border-top:none; background:#222;">
                    <div class="dice-btn-grid">
                        <button class="d-btn btn-d4" onclick="addDie(4)">D4</button>
                        <button class="d-btn btn-d6" onclick="addDie(6)">D6</button>
                        <button class="d-btn btn-d8" onclick="addDie(8)">D8</button>
                        <button class="d-btn btn-d10" onclick="addDie(10)">D10</button>
                        <button class="d-btn btn-d12" onclick="addDie(12)">D12</button>
                        <button class="d-btn btn-d20" onclick="addDie(20)">D20</button>
                    </div>
                    <button id="roll-btn" onclick="rollDice()">ğŸ² æ“²å‡ºéª°å­</button>
                </div>
            </div>

            <div class="panel-content">
                <div class="card">
                    <div class="card-header">ç‹€æ…‹</div>
                    <div class="stat-row-container">
                        <div class="stat-row"><span>HP</span> <span id="hp-txt">--/--</span></div>
                        <div class="bar-wrap"><div id="hp-bar" class="bar-fill" style="width:100%; background:var(--warn);"></div></div>
                    </div>
                    <div class="stat-row-container hidden" id="mp-row">
                        <div class="stat-row"><span id="mp-label">MP</span> <span id="mp-txt">--/--</span></div>
                        <div class="bar-wrap"><div id="mp-bar" class="bar-fill" style="width:100%; background:var(--success);"></div></div>
                    </div>
                    <div class="stat-row-container hidden" id="san-row">
                        <div class="stat-row"><span>SAN</span> <span id="san-txt">--/--</span></div>
                        <div class="bar-wrap"><div id="san-bar" class="bar-fill" style="width:100%; background:var(--accent);"></div></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">å±¬æ€§ (èª¿æ•´å€¼)</div>
                    <div class="attr-grid" id="disp-stats"></div>
                </div>

                <div class="card">
                    <div class="card-header">äººç‰©é—œä¿‚</div>
                    <div id="npc-list" style="font-size:13px; color:#aaa; padding:5px;">å°šç„¡è¨˜éŒ„</div>
                </div>

                <div class="card" style="flex:1">
                    <div class="card-header">ç‰©å“æ¬„</div>
                    <div id="inv-list" style="font-size:13px; color:#aaa; padding:5px;">ç„¡</div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="header-bar">
                <div style="flex:1;">
                    <span id="loc-disp"><i class="fas fa-map-marker-alt"></i> è™›ç©º</span> | 
                    <span id="time-disp">åˆå§‹</span>
                </div>
                <div>
                    <button style="background:none; border:none; color:#aaa; cursor:pointer;" onclick="saveGame()">ğŸ’¾ å­˜æª”</button>
                    <button style="background:none; border:none; color:#f55; margin-left:10px; cursor:pointer;" onclick="resetGame()">ğŸ—‘ï¸ é‡ç½®</button>
                </div>
            </div>

            <div id="chat-log">
                <div class="msg gm">è«‹è¨­å®š API Key èˆ‡ä¸–ç•Œè§€ä»¥é–‹å§‹éŠæˆ²ã€‚</div>
            </div>

            <div class="options-container" id="options-area"></div>

            <div class="input-area">
                <input type="text" id="user-input" placeholder="è¼¸å…¥è¡Œå‹•..." autocomplete="off">
                <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script>
        // --- å…¨å±€è®Šæ•¸ ---
        let apiKey = "";
        let conversationHistory = [];
        let diceBag = [];
        let state = {
            stats: { STR:10, DEX:10, CON:10, INT:10, WIS:10, CHA:10 },
            hp: 10, maxHp: 10, mp: 0, maxMp: 0, san: 0, maxSan: 0, mpLabel: null,
            npcs: [], inventory: [],
            location: "æœªçŸ¥", time: "æœªçŸ¥"
        };
        const ATTR_MAP = { STR: "åŠ›é‡", DEX: "æ•æ·", CON: "é«”è³ª", INT: "æ™ºåŠ›", WIS: "æ„ŸçŸ¥", CHA: "é­…åŠ›" };

        // --- åˆå§‹åŒ– & Enter éµç¶å®š ---
        window.onload = function() {
            const savedKey = localStorage.getItem('gemini_key');
            if(savedKey) document.getElementById('api-key-input').value = savedKey;

            // ç¶å®š Enter éµç™¼é€
            document.getElementById('user-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    sendMsg();
                }
            });
        };

        // --- Crypto RNG (çœŸéš¨æ©Ÿæ•¸ç”Ÿæˆå™¨) ---
        function getSecureRandom(min, max) {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            // æ­£è¦åŒ–ç‚º 0.0 åˆ° 1.0 ä¹‹é–“çš„æµ®é»æ•¸
            const randomFloat = array[0] / (0xFFFFFFFF + 1);
            return Math.floor(randomFloat * (max - min + 1)) + min;
        }

        // --- ä»‹é¢å°èˆª ---
        function goToStats() {
            const k = document.getElementById('api-key-input').value.trim();
            if(!k) return alert("è«‹è¼¸å…¥ API Keyï¼");
            apiKey = k;
            localStorage.setItem('gemini_key', k);
            
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('stats-modal').classList.remove('hidden');
            randomStats();
        }

        // --- å±¬æ€§é…é»ç³»çµ± ---
        function renderStatsEditor() {
            const container = document.getElementById('stats-editor');
            container.innerHTML = "";
            let total = 0;
            for(let key in state.stats) {
                total += state.stats[key];
                container.innerHTML += `
                    <div class="attr-row">
                        <span style="color:#aaa; width:60px;">${key}</span>
                        <div class="attr-val-box">
                            <div class="circle-btn" onclick="modStat('${key}', -1)">-</div>
                            <span id="edit-${key}" style="width:25px; text-align:center;">${state.stats[key]}</span>
                            <div class="circle-btn" onclick="modStat('${key}', 1)">+</div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('points-total').innerText = total;
        }

        function modStat(key, val) {
            state.stats[key] += val;
            renderStatsEditor();
        }

        function randomStats() {
            // ä½¿ç”¨ Crypto RNG é€²è¡Œ 3d6 æˆ–ç¯„åœéš¨æ©Ÿ
            for(let key in state.stats) {
                // æ¨¡æ“¬ 72-80 ç¸½å’Œçš„å¹³å‡åˆ†é…ï¼Œé€™è£¡ç”¨ç°¡å–®ç¯„åœ 9-16
                state.stats[key] = getSecureRandom(9, 16); 
            }
            renderStatsEditor();
        }

        // --- 2D éª°å­é‚è¼¯ (ä½¿ç”¨ Crypto RNG) ---
        function addDie(sides) {
            diceBag.push({ sides: sides, val: sides });
            renderDice();
        }

        function renderDice() {
            const area = document.getElementById('active-dice-area');
            area.innerHTML = "";
            if(diceBag.length === 0) {
                area.innerHTML = `<div style="color:#888; font-size:12px; margin-top:20px;">é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥éª°å­</div>`;
                document.getElementById('dice-total').innerText = "";
                return;
            }
            
            let total = 0;
            diceBag.forEach((d, idx) => {
                const div = document.createElement('div');
                div.className = `die die-d${d.sides}`;
                div.innerText = d.val;
                div.onclick = () => { diceBag.splice(idx, 1); renderDice(); };
                area.appendChild(div);
                total += d.val;
            });
            document.getElementById('dice-total').innerText = `Total: ${total}`;
        }

        function rollDice() {
            if(diceBag.length === 0) return;
            const els = document.querySelectorAll('.die');
            els.forEach(e => e.classList.add('rolling'));
            
            setTimeout(() => {
                diceBag.forEach(d => {
                    // â˜…â˜…â˜… é€™è£¡ä½¿ç”¨çœŸéš¨æ©Ÿæ•¸ â˜…â˜…â˜…
                    d.val = getSecureRandom(1, d.sides);
                });
                renderDice();
                els.forEach(e => e.classList.remove('rolling'));
                // ä¸è‡ªå‹•å¡«å…¥å°è©±æ¡†ï¼Œä¿ç•™è®“ç©å®¶è‡ªå·±æ“ä½œ
            }, 500); // 0.5ç§’å‹•ç•«
        }

        // --- æ ¸å¿ƒéŠæˆ²æµç¨‹ (Start & Chat) ---
        async function startGame() {
            document.getElementById('stats-modal').classList.add('hidden');
            updateHUD();
            
            const world = document.getElementById('world-prompt').value || "D&D 5e";
            
            // â˜…â˜…â˜… æ ¸å¿ƒ System Prompt (Hardcore DM) â˜…â˜…â˜…
            const sysPrompt = `
            ä½ æ˜¯ä¸€ä½æ¥µåº¦åš´è¬¹ã€ç„¡æƒ…çš„ D&D 5e åœ°ä¸‹åŸä¸» (DM)ã€‚
            ä¸–ç•Œè§€ï¼š${world}ã€‚
            ç©å®¶å±¬æ€§ï¼š${JSON.stringify(state.stats)}ã€‚

            ã€æ ¸å¿ƒæŒ‡ä»¤ã€‘
            1. **ç¦æ­¢ä»£å‹**ï¼šçµ•å°ä¸è¦å¹«ç©å®¶æ±ºå®šè¡Œå‹•æˆ–æ“²éª°ã€‚
            2. **æª¢å®šæ©Ÿåˆ¶**ï¼šç•¶ç©å®¶å˜—è©¦æœ‰é¢¨éšªçš„è¡Œå‹•æ™‚ï¼Œè«‹æ ¹æ“š D&D 5e è¦å‰‡ï¼Œå‘ŠçŸ¥ã€Œè«‹é€²è¡Œ[å±¬æ€§/æŠ€èƒ½]æª¢å®šï¼ŒDC ç‚º [æ•¸å€¼]ã€ã€‚
               - è‹¥æœ‰å„ªå‹¢/åŠ£å‹¢è«‹èªªæ˜ã€‚
               - é¡¯ç¤ºä¿®æ­£å€¼è¨ˆç®— (ä¾‹å¦‚ï¼šåŠ›é‡+3, ç†Ÿç·´+2)ã€‚
            3. **ä¸–ç•Œæ¨¡æ“¬**ï¼šå³ä½¿ç©å®¶åœ¨å°è©±ï¼Œä¸–ç•Œå…¶ä»–åœ°æ–¹çš„æ™‚é–“ä¹Ÿåœ¨æµå‹•ã€‚NPC æœ‰è‡ªå·±çš„å‹•æ©Ÿï¼Œä¸æœƒå‘†ç«™è‘—ã€‚è«‹åœ¨æè¿°ä¸­é«”ç¾é€™ä¸€é»ã€‚
            4. **å‰µè§’å¼•å°**ï¼šéŠæˆ²é–‹å§‹ç¬¬ä¸€æ­¥ï¼Œè«‹å¼•å°ç©å®¶å®Œæˆè§’è‰²ç´°ç¯€ï¼ˆç¨®æ—ã€è·æ¥­ã€å¤–è§€ï¼‰ï¼Œä¸è¦ç›´æ¥è·³é€²æˆ°é¬¥ã€‚
            5. **æˆ°åŠ›æ§åˆ¶**ï¼šåš´æ ¼æ§åˆ¶å±¬æ€§èˆ‡ç‰©å“ï¼Œä¸è¦éš¨æ„çµ¦äºˆå¼·å¤§ç¥å™¨æˆ–æ•¸å€¼æå‡ã€‚
            
            ã€è¼¸å‡ºæ ¼å¼ã€‘
            æ¯æ¬¡å›å¾©çš„**æœ€å¾Œé¢**ï¼Œå¿…é ˆé™„ä¸Šé€™æ®µ JSON ç¢¼ (ç”¨ \`\`\`json åŒ…æœ)ï¼Œç”¨ä¾†æ›´æ–°ä»‹é¢ï¼š
            \`\`\`json
            {
                "hp_change": 0,
                "mp_change": 0, "mp_label": null,
                "san_change": 0,
                "location": "ç›®å‰åœ°é»",
                "time": "ç›®å‰æ™‚é–“",
                "npcs": [{"name":"NPCå", "rel":"é—œä¿‚æè¿°"}],
                "inventory": ["ç‰©å“1"],
                "options": ["å»ºè­°é¸é …1", "å»ºè­°é¸é …2"]
            }
            \`\`\`
            `;
            
            conversationHistory = [{ role: "user", parts: [{ text: sysPrompt }] }];
            addMsg("gm", "<i>æ­£åœ¨åˆå§‹åŒ–ä¸–ç•Œèˆ‡è¦å‰‡æ¨¡çµ„...</i>", true);
            await callGemini("è«‹é–‹å§‹éŠæˆ²ï¼Œå…ˆå”åŠ©æˆ‘å®Œæˆè§’è‰²èƒŒæ™¯è¨­å®šï¼Œå†é€²å…¥å†’éšªã€‚");
        }

        async function sendMsg() {
            const input = document.getElementById('user-input');
            const txt = input.value.trim();
            if(!txt) return;
            
            addMsg("user", txt);
            input.value = "";
            document.getElementById('options-area').innerHTML = ""; 
            addMsg("gm", "...", true);
            
            await callGemini(txt);
        }

        async function callGemini(text) {
            conversationHistory.push({ role: "user", parts: [{ text: text }] });
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: conversationHistory })
                });
                const data = await res.json();
                document.querySelectorAll('.loading').forEach(e => e.remove());
                
                if(data.candidates) {
                    const aiText = data.candidates[0].content.parts[0].text;
                    processResponse(aiText);
                    conversationHistory.push({ role: "model", parts: [{ text: aiText }] });
                } else {
                    addMsg("gm", "API Error: è«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢ºã€‚");
                }
            } catch(e) {
                addMsg("gm", "é€£ç·šéŒ¯èª¤ã€‚");
            }
        }

        function processResponse(text) {
            // æå–ä¸¦ç§»é™¤ JSON
            const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
            let displayText = text;
            
            if(jsonMatch) {
                try {
                    const data = JSON.parse(jsonMatch[1]);
                    // æ›´æ–°ç‹€æ…‹
                    if(data.location) state.location = data.location;
                    if(data.time) state.time = data.time;
                    if(data.npcs) state.npcs = data.npcs;
                    if(data.inventory) state.inventory = data.inventory;
                    
                    // æ•¸å€¼è®Šå‹•
                    if(data.hp_change) state.hp = Math.max(0, Math.min(state.maxHp, state.hp + data.hp_change));
                    if(data.mp_label) state.mpLabel = data.mp_label;
                    if(data.san_change) {
                        state.san += data.san_change; 
                        if(!state.maxSan) state.maxSan = 100;
                    }

                    if(data.options) renderOptions(data.options);
                    
                    updateHUD();
                    displayText = text.replace(jsonMatch[0], "");
                } catch(e) { console.warn("JSON Parse Error"); }
            }
            addMsg("gm", marked.parse(displayText));
        }

        function renderOptions(opts) {
            const area = document.getElementById('options-area');
            area.innerHTML = "";
            opts.forEach(o => {
                const b = document.createElement('button');
                b.className = 'opt-btn';
                b.innerText = o;
                b.onclick = () => { document.getElementById('user-input').value = o; sendMsg(); };
                area.appendChild(b);
            });
        }

        // --- UI æ›´æ–°é‚è¼¯ ---
        function updateHUD() {
            // å±¬æ€§é¡¯ç¤º
            const attrBox = document.getElementById('disp-stats');
            attrBox.innerHTML = "";
            for(let k in state.stats) {
                const val = state.stats[k];
                const mod = Math.floor((val-10)/2);
                const sign = mod>=0?"+":"";
                attrBox.innerHTML += `
                    <div class="attr-main">
                        <span class="attr-lbl">${k}</span>
                        <span class="attr-cn">${ATTR_MAP[k]}</span>
                        <span class="attr-val">${val}<span class="attr-mod">(${sign}${mod})</span></span>
                    </div>
                `;
            }

            // ç‹€æ…‹æ¢
            document.getElementById('hp-txt').innerText = `${state.hp}/${state.maxHp}`;
            document.getElementById('hp-bar').style.width = `${(state.hp/state.maxHp)*100}%`;

            const mpRow = document.getElementById('mp-row');
            if(state.mpLabel) {
                mpRow.classList.remove('hidden');
                document.getElementById('mp-label').innerText = state.mpLabel;
                // MP æ¢é‚è¼¯å¯ä¾éœ€æ±‚æ“´å……
            } else { mpRow.classList.add('hidden'); }

            const sanRow = document.getElementById('san-row');
            if(state.maxSan > 0) {
                sanRow.classList.remove('hidden');
                document.getElementById('san-txt').innerText = `${state.san}/${state.maxSan}`;
                document.getElementById('san-bar').style.width = `${(state.san/state.maxSan)*100}%`;
            } else { sanRow.classList.add('hidden'); }

            // NPC & ç‰©å“
            const npcBox = document.getElementById('npc-list');
            if(state.npcs.length) {
                npcBox.innerHTML = state.npcs.map(n=>`<div><b style="color:#bb86fc">${n.name}</b>: ${n.rel}</div>`).join('');
            } else { npcBox.innerHTML = "å°šç„¡è¨˜éŒ„"; }
            
            document.getElementById('inv-list').innerText = state.inventory.join(", ") || "ç„¡";
            document.getElementById('loc-disp').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${state.location}`;
            document.getElementById('time-disp').innerText = state.time;
        }

        function addMsg(role, html, loading=false) {
            const box = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = `msg ${role} ${loading?'loading':''}`;
            div.innerHTML = html;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- å­˜è®€æª” ---
        function saveGame() {
            const data = btoa(encodeURIComponent(JSON.stringify({state, history:conversationHistory})));
            prompt("è«‹è¤‡è£½å­˜æª”ç¢¼:", data);
        }
        
        function loadGame() {
            try {
                const code = document.getElementById('load-code').value.trim();
                const json = decodeURIComponent(atob(code));
                const data = JSON.parse(json);
                state = data.state;
                conversationHistory = data.history;
                
                document.getElementById('setup-modal').classList.add('hidden');
                updateHUD();
                
                // æ¢å¾©å°è©±
                const box = document.getElementById('chat-log');
                box.innerHTML = "";
                conversationHistory.forEach(m => {
                    if(m.role==='user' && m.parts[0].text.includes('JSON')) return;
                    let t = m.parts[0].text.replace(/```json[\s\S]*```/, "");
                    addMsg(m.role==='model'?'gm':'user', marked.parse(t));
                });
                
                // æª¢æŸ¥ Key
                if(!localStorage.getItem('gemini_key')) {
                    const k = prompt("è®€æª”æˆåŠŸï¼Œè«‹è¼¸å…¥ API Key ç¹¼çºŒ:");
                    if(k) { apiKey = k; localStorage.setItem('gemini_key', k); }
                } else { apiKey = localStorage.getItem('gemini_key'); }

            } catch(e) { alert("è®€å–å¤±æ•—ï¼Œå­˜æª”ç¢¼éŒ¯èª¤ã€‚"); }
        }
        
        function resetGame() { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) location.reload(); }
    </script>
</body>
</html>
