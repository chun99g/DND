<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>RPG Engine V40 (Exact Name Match)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        /* (樣式保持不變，為了節省空間省略，請保留原本 V39 的樣式) */
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #bb86fc; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100%; }
        .sidebar { width: 420px; background: #181818; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        #dice-stage { width: 100%; height: 380px; background: #252525; position: relative; overflow: hidden; border-bottom: 1px solid #333; }
        #debug-log { position: absolute; top: 10px; left: 10px; color: #81c995; background: rgba(0,0,0,0.8); padding: 8px; font-size: 11px; max-width: 90%; pointer-events: none; white-space: pre-wrap; z-index: 10; border-radius: 4px; }
        .panel-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px; }
        .dice-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .d-btn { height: 36px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; font-size: 12px; background: #333; box-shadow: 0 2px 0 rgba(0,0,0,0.3); }
        .card { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .header-bar { padding: 10px 20px; background: #181818; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; color: #aaa; font-size: 13px; }
        .chat-log { flex: 1; padding: 20px; }
        .input-area { padding: 15px; background: #181818; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; background: #252525; border: 1px solid #444; color: white; border-radius: 24px; outline: none; padding-left: 20px; }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; color: #000; }
        .hidden { display: none !important; }
        /* 為了完整性，這裡需要加上 V39 的所有 CSS，請直接使用 V39 的 CSS 區塊 */
    </style>
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <div id="dice-stage">
                <div id="debug-log">V40 系統檢測中...</div>
            </div>
            
            <div class="panel-content">
                <div class="card">
                    <div class="dice-btn-grid">
                        <button class="d-btn" onclick="showDice(4)">D4</button>
                        <button class="d-btn" onclick="showDice(6)">D6</button>
                        <button class="d-btn" onclick="showDice(8)">D8</button>
                        <button class="d-btn" onclick="showDice(10)">D10</button>
                        <button class="d-btn" onclick="showDice(12)">D12</button>
                        <button class="d-btn" style="border-bottom: 3px solid #F4B400;" onclick="showDice(20)">D20</button>
                    </div>
                    <div style="text-align:center; font-size:11px; color:#777;">若無法顯示，請檢查左上角紅字</div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="header-bar">RPG Engine V40 Debug Mode</div>
            <div id="chat-log" class="chat-log" style="color:#777; text-align:center; padding-top:50px;">
                (請先解決模型顯示問題，再進行遊戲)
            </div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="對話框...">
                <button class="send-btn">send</button>
            </div>
        </main>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

        // ==========================================
        // ★★★ V40 修正區：檔名與路徑 ★★★
        // ==========================================
        
        // 1. 如果您的檔案在資料夾裡 (例如 assets/)，請改成 "./assets/4Sliver.png"
        // 2. 請注意 "Sliver" (裂片) vs "Silver" (銀色) 的拼字！
        const TEXTURE_PATH_PREFIX = "./"; // 如果在根目錄，就維持 "./"。如果在資料夾，改成 "./資料夾名/"
        
        const TEXTURE_FILES = {
            4:  "4Sliver.png", 
            6:  "6Sliver.png",
            8:  "8Sliver.png",
            10: "10Sliver.png",
            12: "12Sliver.png",
            20: "20Sliver.png"
        };

        // 3. 這是您在 Blender 裡看到的精準名稱
        // 程式碼會用 "完全符合" 的方式去抓，不會抓錯
        const DICE_EXACT_NAMES = {
            4:  "4Sliver",
            6:  "6Sliver",
            8:  "8Sliver",
            10: "10Sliver",
            12: "12Sliver",
            20: "20Sliver"
        };

        let scene, camera, renderer, currentDice;
        let diceModels = {}; 
        let loadedTextures = {};
        let isSpinning = true;
        let allMeshes = [];

        function init3D() {
            const container = document.getElementById('dice-stage');
            const debugLog = document.getElementById('debug-log');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x252525);
            
            const amb = new THREE.AmbientLight(0xffffff, 1.5); // 燈光加強
            scene.add(amb);
            const dir = new THREE.DirectionalLight(0xffffff, 2.0);
            dir.position.set(5, 10, 5);
            scene.add(dir);
            const front = new THREE.DirectionalLight(0xffffff, 1.0);
            front.position.set(0, 2, 10);
            scene.add(front);

            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(0, 3, 7);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // 1. 載入貼圖
            const texLoader = new THREE.TextureLoader();
            debugLog.innerText = "1. 載入貼圖...\n";
            
            for (let sides in TEXTURE_FILES) {
                const fullPath = TEXTURE_PATH_PREFIX + TEXTURE_FILES[sides];
                texLoader.load(fullPath, (tex) => {
                    tex.colorSpace = THREE.SRGBColorSpace;
                    loadedTextures[sides] = tex;
                    debugLog.innerText += `✅ D${sides} OK (${fullPath})\n`;
                }, undefined, (err) => {
                    debugLog.innerText += `❌ D${sides} 貼圖失敗: 找不到 ${fullPath}\n`;
                });
            }

            // 2. 載入模型
            const fbxLoader = new FBXLoader();
            const fbxPath = TEXTURE_PATH_PREFIX + "DiceSet.fbx"; // 假設 FBX 跟圖片在同一個地方
            
            fbxLoader.load(fbxPath, (object) => {
                debugLog.innerText += `2. FBX 載入成功 (${fbxPath})\n`;
                debugLog.innerText += "內容物清單:\n";
                
                object.traverse(child => {
                    if(child.isMesh) {
                        child.visible = false;
                        allMeshes.push(child);
                        
                        // 列印所有找到的名稱，方便除錯
                        debugLog.innerText += `[${child.name}] `; 

                        // 幾何歸零 (必備)
                        child.geometry.computeBoundingBox();
                        const center = new THREE.Vector3();
                        child.geometry.boundingBox.getCenter(center);
                        child.geometry.translate(-center.x, -center.y, -center.z);
                        child.scale.set(0.2, 0.2, 0.2);

                        // 精準匹配
                        for(let sides in DICE_EXACT_NAMES) {
                            // 注意：這裡使用 include 是怕 blender 自動加 .001 後綴
                            // 但主要還是依賴您提供的名字
                            if(child.name.includes(DICE_EXACT_NAMES[sides])) {
                                diceModels[sides] = child;
                            }
                        }
                    }
                });
                
                // 檢查是否所有骰子都找到了
                let missing = [];
                for(let s of [4,6,8,10,12,20]) { if(!diceModels[s]) missing.push("D"+s); }
                
                if(missing.length > 0) {
                    debugLog.innerText += `\n⚠️ 警告：找不到模型 ${missing.join(',')}`;
                    debugLog.innerText += "\n請比對上方 [括號內] 的名稱是否與程式碼一致";
                } else {
                    debugLog.innerText += "\n✅ 所有模型匹配成功！";
                }

            }, undefined, (e) => {
                debugLog.innerText = `❌ FBX 載入失敗: 找不到 ${fbxPath}`;
            });

            animate();
        }

        window.showDice = function(sides) {
            if(currentDice) scene.remove(currentDice);
            
            let mesh = diceModels[sides];
            
            // 如果真的找不到，用盲抓 (Fallback)
            if (!mesh && allMeshes.length > 0) {
                // 嘗試依照順序猜測
                const fallbackMap = {4:0, 6:1, 8:2, 10:3, 12:4, 20:5};
                mesh = allMeshes[fallbackMap[sides] % allMeshes.length];
                console.log("Using fallback mesh for D" + sides);
            }

            if(mesh) {
                mesh = mesh.clone();
                mesh.visible = true;
                
                // 應用貼圖
                if (loadedTextures[sides]) {
                    mesh.material = new THREE.MeshStandardMaterial({
                        map: loadedTextures[sides],
                        roughness: 0.3,
                        metalness: 0.1,
                        color: 0xffffff // 確保白色底，不然貼圖會變暗
                    });
                } else {
                    // 如果貼圖沒載入，給個鮮豔顏色提醒
                    mesh.material = new THREE.MeshStandardMaterial({color: 0xff00ff}); 
                }

                scene.add(mesh);
                currentDice = mesh;
                mesh.rotation.x = Math.random() * Math.PI;
                mesh.rotation.y = Math.random() * Math.PI;
            }
        };

        function animate() {
            requestAnimationFrame(animate);
            if(currentDice) {
                currentDice.rotation.y += 0.01;
                currentDice.rotation.x += 0.005;
            }
            renderer.render(scene, camera);
        }

        // 視窗縮放修正
        window.addEventListener('resize', () => {
            const c = document.getElementById('dice-stage');
            camera.aspect = c.clientWidth / c.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(c.clientWidth, c.clientHeight);
        });

        init3D();
    </script>
</body>
</html>
