<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>RPG Engine V40 (Google Style)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        :root { --bg: #202124; --panel: #303134; --text: #e8eaed; --accent: #8ab4f8; --danger: #f28b82; }
        body { margin: 0; font-family: 'Roboto', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        .app-container { display: flex; height: 100%; }
        /* 側邊欄：緊湊設計 */
        .sidebar { width: 380px; background: #292a2d; border-right: 1px solid #3c4043; display: flex; flex-direction: column; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); }

        /* 3D 舞台：高度適中，背景為 Google 深灰 */
        #dice-stage { 
            width: 100%; height: 280px; background: #202124; 
            position: relative; overflow: hidden; border-bottom: 1px solid #3c4043; 
        }
        
        #instruction-overlay { 
            position: absolute; bottom: 8px; width: 100%; text-align: center; 
            color: #9aa0a6; font-size: 11px; pointer-events: none; user-select: none;
        }

        .panel-content { padding: 12px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 12px; }
        
        /* 卡片設計 */
        .card { background: var(--panel); padding: 12px; border-radius: 8px; border: 1px solid #3c4043; }
        
        /* 標題欄 + 擲骰按鈕 */
        .card-header { 
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; color: #9aa0a6; margin-bottom: 10px; font-weight: bold;
        }

        /* 小巧的擲骰按鈕 */
        .roll-btn {
            background: var(--accent); color: #202124; border: none; 
            padding: 6px 16px; border-radius: 16px; font-size: 13px; font-weight: bold; 
            cursor: pointer; transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .roll-btn:hover { background: #a6c8ff; }
        .roll-btn:active { transform: translateY(1px); }
        .roll-btn:disabled { background: #5f6368; color: #80868b; cursor: wait; }

        /* 骰子選擇按鈕網格 */
        .dice-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .d-btn { 
            height: 40px; border: 1px solid #5f6368; border-radius: 4px; color: #e8eaed; 
            font-weight: 500; cursor: pointer; font-size: 13px; background: #303134; 
            display: flex; align-items: center; justify-content: center; gap: 5px;
            transition: 0.1s;
        }
        .d-btn:hover { background: #3c4043; border-color: #8ab4f8; }
        .d-btn:active { background: #8ab4f8; color: #202124; }
        
        /* 狀態與屬性 */
        .stat-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        .bar-wrap { background: #3c4043; height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .bar-fill { height: 100%; transition: width 0.5s ease; }
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .attr-main { text-align: center; background: #3c4043; padding: 6px; border-radius: 4px; }
        .attr-val { font-size: 16px; font-weight: bold; color: var(--accent); }
        .attr-lbl { font-size: 11px; color: #9aa0a6; }

        /* 聊天區 */
        .header-bar { padding: 10px 20px; background: #292a2d; border-bottom: 1px solid #3c4043; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #9aa0a6; }
        .chat-log { flex: 1; padding: 20px; overflow-y: auto; font-size: 14px; line-height: 1.6; }
        .msg { margin-bottom: 16px; max-width: 85%; padding: 10px 14px; border-radius: 8px; }
        .msg.gm { background: #3c4043; border-left: 3px solid var(--accent); }
        .msg.user { background: #1e8e3e; color: #fff; margin-left: auto; }
        
        .input-area { padding: 15px; background: #292a2d; display: flex; gap: 10px; border-top: 1px solid #3c4043; }
        input[type="text"] { flex: 1; padding: 10px 15px; background: #3c4043; border: 1px solid #5f6368; color: white; border-radius: 20px; outline: none; }
        .send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; color: #202124; display: flex; align-items: center; justify-content: center; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: #303134; width: 400px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .modal-btn { width: 100%; padding: 12px; background: var(--accent); color: #202124; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .hidden { display: none !important; }
        
        /* Debug Log (右上角) */
        #debug-log { position: absolute; top: 10px; right: 10px; color: #81c995; background: rgba(0,0,0,0.6); padding: 4px 8px; font-size: 10px; pointer-events: none; border-radius: 4px; opacity: 0; }
        #debug-log.show { opacity: 1; }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal">
        <div class="modal-box">
            <h2 style="color:var(--accent); margin-top:0;">RPG Engine V40</h2>
            <p style="color:#9aa0a6; font-size:13px;">Google Style Dice (Grid & Auto-Align)</p>
            <p>世界觀設定：</p>
            <textarea id="world-prompt" rows="3" style="width:100%; background:#202124; color:#fff; border:1px solid #5f6368; padding:10px; border-radius:4px; resize:none;" placeholder="例如：龍與地下城 D&D 5e..."></textarea>
            <button class="modal-btn" onclick="startCharacterCreation()">開始冒險</button>
            <div style="margin-top:15px; text-align:right;">
                <button style="background:none; border:none; color:#9aa0a6; font-size:12px; cursor:pointer;" onclick="loadFromCode()">讀取進度</button>
            </div>
        </div>
    </div>

    <div id="char-modal" class="modal hidden">
        <div class="modal-box">
            <h2 style="color:var(--success); margin-top:0;">屬性生成</h2>
            <div style="text-align:center; padding:20px; background:#202124; border-radius:8px; margin-bottom:15px;">
                <div id="derived-stats" style="color:#fff; font-weight:bold;">計算中...</div>
            </div>
            <button class="modal-btn" onclick="confirmStart()">確認並開始</button>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <div id="dice-stage">
                <div id="debug-log">Ready</div>
                <div id="instruction-overlay">點擊畫面骰子可移除 (Click to Remove)</div>
            </div>
            
            <div class="panel-content">
                <div class="card">
                    <div class="card-header">
                        <span>骰子盤</span>
                        <button class="roll-btn" id="roll-btn" onclick="rollAll()">擲出骰子</button>
                    </div>
                    <div class="dice-btn-grid">
                        <button class="d-btn" onclick="addDice(4)">D4</button>
                        <button class="d-btn" onclick="addDice(6)">D6</button>
                        <button class="d-btn" onclick="addDice(8)">D8</button>
                        <button class="d-btn" onclick="addDice(10)">D10</button>
                        <button class="d-btn" onclick="addDice(12)">D12</button>
                        <button class="d-btn" onclick="addDice(20)">D20</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">角色狀態</div>
                    <div class="stat-row"><span>HP</span> <span id="hp-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="hp-bar" class="bar-fill" style="width:100%; background:#f28b82;"></div></div>
                    <div class="stat-row"><span id="mp-label">MP</span> <span id="mp-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="mp-bar" class="bar-fill" style="width:100%; background:#81c995;"></div></div>
                </div>
                
                <div class="card">
                    <div class="card-header">基礎屬性</div>
                    <div class="attr-grid">
                        <div class="attr-main"><div class="attr-lbl">STR</div><div id="disp-str" class="attr-val">--</div></div>
                        <div class="attr-main"><div class="attr-lbl">DEX</div><div id="disp-dex" class="attr-val">--</div></div>
                        <div class="attr-main"><div class="attr-lbl">CON</div><div id="disp-con" class="attr-val">--</div></div>
                        <div class="attr-main"><div class="attr-lbl">INT</div><div id="disp-int" class="attr-val">--</div></div>
                        <div class="attr-main"><div class="attr-lbl">WIS</div><div id="disp-wis" class="attr-val">--</div></div>
                        <div class="attr-main"><div class="attr-lbl">CHA</div><div id="disp-cha" class="attr-val">--</div></div>
                    </div>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="header-bar">
                <span id="location-display"><i class="fas fa-map-marker-alt"></i> 虛空</span>
                <span id="time-display">初始</span>
                <button style="background:none; border:none; color:#f28b82; cursor:pointer;" onclick="resetGame()"><i class="fas fa-trash"></i></button>
            </div>
            <div id="chat-log" class="chat-log"><div class="msg gm">歡迎來到 RPG Engine V40。</div></div>
            <div id="options-area" style="padding:10px; background:#292a2d; display:flex; gap:5px; flex-wrap:wrap;"></div>
            <div class="input-area"><input type="text" id="user-input" placeholder="輸入行動..." autocomplete="off"><button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button></div>
        </main>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        window.USER_API_KEY = ""; 
        
        const GLB_FILES = {
            4:  "./d4_low.glb",
            6:  "./d6_low.glb",
            8:  "./d8_low.glb",
            10: "./d10_low.glb",
            12: "./d12_low.glb",
            20: "./d20_low.glb"
        };

        // --- 3D 核心變數 ---
        let scene, camera, renderer;
        let loadedModels = {}; 
        let diceList = []; 
        let raycaster, mouse;
        let isRolling = false;
        let hoveredDice = null;

        // 格子設定 (Google Style Grid)
        const GRID_START_X = -4; 
        const GRID_GAP = 3.5;
        const MAX_PER_ROW = 4; // 一排最多 4 顆，像 Google

        function init3D() {
            const container = document.getElementById('dice-stage');
            const debugLog = document.getElementById('debug-log');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x202124); // Google Dark Gray
            
            // 燈光：高對比，強調平面
            const amb = new THREE.AmbientLight(0xffffff, 1.2);
            scene.add(amb);
            const dir = new THREE.DirectionalLight(0xffffff, 1.5);
            dir.position.set(5, 20, 5);
            dir.castShadow = true;
            scene.add(dir);
            const fill = new THREE.DirectionalLight(0xaaccff, 0.5);
            fill.position.set(-5, 10, -5);
            scene.add(fill);

            // 攝影機：正上方俯視，視野範圍剛好涵蓋兩排
            camera = new THREE.PerspectiveCamera(30, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(0, 30, 0); 
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            
            // 使用 pointerdown 確保點擊靈敏度 (解決點擊無反應問題)
            container.addEventListener('pointerdown', onDiceClick);
            container.addEventListener('pointermove', onDiceHover);

            // 載入模型
            const loader = new GLTFLoader();
            debugLog.innerText = "Loading Models...";
            debugLog.classList.add('show');

            let loadCount = 0;
            const total = Object.keys(GLB_FILES).length;

            for (let sides in GLB_FILES) {
                loader.load(GLB_FILES[sides], (gltf) => {
                    const model = gltf.scene;
                    
                    // 標準化：歸零與縮放
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    model.position.sub(center); 

                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    
                    // 放大係數：讓它們在畫面中夠大且清晰
                    let scaleFactor = 3.5 / maxDim; 
                    if (sides == 4) scaleFactor *= 1.2; // D4 特別放大
                    if (sides == 20) scaleFactor *= 0.9; // D20 稍微縮小

                    model.scale.set(scaleFactor, scaleFactor, scaleFactor);

                    // 材質優化
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            if(child.material) {
                                child.material.roughness = 0.3; // 稍微光亮
                                child.material.metalness = 0.0;
                                if (child.geometry && !child.geometry.attributes.normal) {
                                    child.geometry.computeVertexNormals();
                                }
                            }
                        }
                    });

                    loadedModels[sides] = model;
                    loadCount++;
                    if(loadCount === total) {
                        debugLog.innerText = "";
                        debugLog.classList.remove('show');
                    }
                });
            }

            animate();
        }

        // --- 互動邏輯 ---
        function updateRaycaster(event) {
            const container = document.getElementById('dice-stage');
            const rect = container.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / container.clientWidth) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / container.clientHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
        }

        function onDiceHover(event) {
            if (isRolling) return;
            updateRaycaster(event);
            
            // 檢測所有骰子
            let intersects = [];
            for(let d of diceList) {
                const hits = raycaster.intersectObjects(d.mesh.children, true);
                if(hits.length > 0) intersects.push({ dist: hits[0].distance, dice: d });
            }

            // 還原上一個高亮的骰子
            if (hoveredDice) {
                hoveredDice.mesh.position.y = 0; // 還原高度
                hoveredDice = null;
                document.getElementById('dice-stage').style.cursor = 'default';
            }

            if (intersects.length > 0) {
                intersects.sort((a,b) => a.dist - b.dist);
                const target = intersects[0].dice;
                
                // 高亮效果：稍微浮起
                target.mesh.position.y = 0.5; 
                hoveredDice = target;
                document.getElementById('dice-stage').style.cursor = 'pointer';
            }
        }

        function onDiceClick(event) {
            if (isRolling) return;
            updateRaycaster(event);

            let intersects = [];
            for(let d of diceList) {
                const hits = raycaster.intersectObjects(d.mesh.children, true);
                if(hits.length > 0) intersects.push({ dist: hits[0].distance, dice: d });
            }

            if (intersects.length > 0) {
                intersects.sort((a,b) => a.dist - b.dist);
                // 刪除骰子
                removeDice(intersects[0].dice);
            }
        }

        // --- 核心功能：新增與排列 ---
        window.addDice = function(sides) {
            if (!loadedModels[sides]) return;
            if (isRolling) return;

            const template = loadedModels[sides];
            const newDice = template.clone();
            
            // 預設平躺 (D4 特殊處理)
            if(sides == 4) {
                newDice.rotation.set(0, 0, 0); 
                // 強制一次貼地對齊
                snapToFloor(newDice, 4);
            } else {
                // 其他骰子隨機轉個面，然後貼地
                newDice.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
                snapToFloor(newDice, sides);
            }

            scene.add(newDice);
            diceList.push({ mesh: newDice, sides: sides });
            repositionDice();
        };

        function removeDice(diceObj) {
            scene.remove(diceObj.mesh);
            diceList = diceList.filter(d => d !== diceObj);
            hoveredDice = null;
            repositionDice();
        }

        function repositionDice() {
            // Google Style Grid: 置中排列
            const count = diceList.length;
            if (count === 0) return;

            diceList.forEach((dice, index) => {
                const row = Math.floor(index / MAX_PER_ROW);
                const col = index % MAX_PER_ROW;
                
                // 計算每一行的實際數量，用來做行內置中
                // 暫時簡化：直接左對齊或固定格線
                // 固定格線比較穩
                
                // 總寬度計算
                const itemsInThisRow = Math.min(MAX_PER_ROW, count - row * MAX_PER_ROW);
                const rowWidth = (itemsInThisRow - 1) * GRID_GAP;
                const startX = -rowWidth / 2;

                const tx = startX + col * GRID_GAP;
                const tz = (row * GRID_GAP) - 2; // 稍微往上提一點

                dice.mesh.position.set(tx, 0, tz);
            });
        }

        // --- 擲骰功能 (Shake & Snap) ---
        window.rollAll = function() {
            if (diceList.length === 0 || isRolling) return;

            isRolling = true;
            const btn = document.getElementById('roll-btn');
            btn.disabled = true;
            btn.innerText = "ROLLING...";

            const duration = 600; // 快速滾動
            const startTime = Date.now();

            // 紀錄每個骰子的原始位置
            const origins = diceList.map(d => d.mesh.position.clone());

            function rollLoop() {
                const now = Date.now();
                const elapsed = now - startTime;
                
                if (elapsed < duration) {
                    diceList.forEach((d, i) => {
                        // 原地抖動 (Jitter)
                        d.mesh.position.x = origins[i].x + (Math.random()-0.5) * 0.5;
                        d.mesh.position.z = origins[i].z + (Math.random()-0.5) * 0.5;
                        
                        // 瘋狂旋轉
                        d.mesh.rotation.x += 0.5;
                        d.mesh.rotation.y += 0.5;
                        d.mesh.rotation.z += 0.5;
                    });
                    requestAnimationFrame(rollLoop);
                } else {
                    // 停止並鎖定
                    diceList.forEach((d, i) => {
                        d.mesh.position.copy(origins[i]); // 回到格子點
                        snapToFloor(d.mesh, d.sides);     // 完美貼地
                    });
                    
                    isRolling = false;
                    btn.disabled = false;
                    btn.innerText = "擲出骰子";
                }
            }
            rollLoop();
        };

        // --- 演算法：完美貼地 (Perfect Snap) ---
        function snapToFloor(object, sides) {
            // 取得幾何資料
            let mesh = null;
            object.traverse(c => { if(c.isMesh) mesh = c; });
            if(!mesh) return;

            const geometry = mesh.geometry;
            if (!geometry.attributes.normal) geometry.computeVertexNormals();
            
            const normalMatrix = new THREE.Matrix3().getNormalMatrix(mesh.matrixWorld);
            const posAttr = geometry.attributes.position;
            const count = posAttr.count;

            // 目標：D4 找底面 (法線朝下)，其他找頂面 (法線朝上)
            const targetDir = (sides == 4) ? new THREE.Vector3(0, -1, 0) : new THREE.Vector3(0, 1, 0);
            
            let bestFaceNormal = new THREE.Vector3();
            let maxDot = -Infinity;

            // 簡易遍歷：每三個點算一個面
            for (let i = 0; i < count; i += 3) {
                const vA = new THREE.Vector3().fromBufferAttribute(posAttr, i);
                const vB = new THREE.Vector3().fromBufferAttribute(posAttr, i+1);
                const vC = new THREE.Vector3().fromBufferAttribute(posAttr, i+2);
                
                const cb = new THREE.Vector3().subVectors(vC, vB);
                const ab = new THREE.Vector3().subVectors(vA, vB);
                const faceNormal = new THREE.Vector3().crossVectors(cb, ab).normalize();
                
                // 轉到世界空間
                faceNormal.applyMatrix3(normalMatrix).normalize();

                const dot = faceNormal.dot(targetDir);
                if (dot > maxDot) {
                    maxDot = dot;
                    bestFaceNormal.copy(faceNormal);
                }
            }

            // 計算旋轉差，修正它
            const quaternion = new THREE.Quaternion().setFromUnitVectors(bestFaceNormal, targetDir);
            object.applyQuaternion(quaternion);

            // --- D4 特殊調整：尖端朝向使用者 ---
            // 上一步保證了底面貼地。現在 D4 是趴著的。
            // 我們希望它的一個平面（有數字的面）或者尖端對著鏡頭。
            // 簡單做法：隨機轉 Y 軸 0, 120, 240 度
            if (sides == 4) {
                const randomAngle = Math.floor(Math.random() * 3) * (Math.PI * 2 / 3);
                object.rotateY(randomAngle);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        init3D();
    </script>

    <script>
        // --- 基礎 RPG 邏輯 (保持不變) ---
        let confirmedModel = ""; 
        let conversationHistory = []; 
        let state = { hp: 10, maxHp: 10, mp: 10, maxMp: 10, mpLabel: "MP", san: 100, maxSan: 100, stats: { str:10, dex:10, con:10, int:10, wis:10, cha:10 }, inventory: [], npcs: [], time: "初始", weather: "未知", location: "起始點", worldPrompt: "" };

        window.onload = function() {
            const cachedKey = localStorage.getItem('my_gemini_key_v1');
            if (cachedKey) window.USER_API_KEY = cachedKey;
            const saved = localStorage.getItem('rpg_autosave_v39_1');
            if (saved && confirm("偵測到存檔，要繼續嗎？")) loadGameData(JSON.parse(saved));
        };

        function startCharacterCreation() {
            state.worldPrompt = document.getElementById('world-prompt').value.trim() || "D&D 5e";
            if(!window.USER_API_KEY) {
                const inputKey = prompt("請輸入您的 Gemini API Key:", "");
                if(inputKey) {
                    window.USER_API_KEY = inputKey;
                    localStorage.setItem('my_gemini_key_v1', inputKey);
                } else {
                    alert("需要 API Key 才能運作喔！");
                    return;
                }
            }
            randomizeStats();
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('char-modal').classList.remove('hidden');
        }

        function randomizeStats() {
            let min = 72, max = 80;
            const target = Math.floor(Math.random()*(max-min+1))+min;
            const keys=['str','dex','con','int','wis','cha'];
            keys.forEach(k=>state.stats[k]=3);
            let pts = target - 18;
            while(pts>0){ const k=keys[Math.floor(Math.random()*6)]; if(state.stats[k]<18){state.stats[k]++; pts--;} }
            renderStatEditor(target);
        }

        function adjustStat(k, d) { state.stats[k]+=d; renderStatEditor(); }
        function getMod(v) { return Math.floor((v-10)/2); }
        function getModStr(v) { const m=getMod(v); return m>=0?`+${m}`:`${m}`; }

        function renderStatEditor(sum) {
            if(!sum) sum=Object.values(state.stats).reduce((a,b)=>a+b,0);
            let h=''; const map={str:'力量',dex:'敏捷',con:'體質',int:'智力',wis:'感知',cha:'魅力'};
            for(let k in state.stats){
                h+=`<div class="attr-main" style="display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:5px;"><span class="attr-lbl">${map[k]}</span><div style="display:flex;align-items:center;gap:5px;"><button onclick="adjustStat('${k}',-1)" style="width:20px;">-</button><span class="attr-val" style="font-size:14px;">${state.stats[k]}</span><button onclick="adjustStat('${k}',1)" style="width:20px;">+</button></div></div>`;
            }
            document.getElementById('derived-stats').innerHTML = h + `<div style="margin-top:10px;border-top:1px solid #555;padding-top:5px;">總和: ${sum}</div>`;
        }

        async function confirmStart() {
            document.getElementById('char-modal').classList.add('hidden');
            updateUI();
            addMsg("sys","世界構建中...");
            await detectModelAndStart();
        }

        async function detectModelAndStart() {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${window.USER_API_KEY}`);
                const data = await res.json();
                const m = (data.models||[]).find(x=>x.name.includes("gemini-1.5-flash")||x.name.includes("gemini-pro"));
                if(!m) throw new Error("API Key 無效或額度不足");
                confirmedModel = m.name.replace("models/","");
                
                const sysPrompt = `你是一位 D&D 5e DM。世界觀：${state.worldPrompt}。
                【規則】
                1. 簡潔開場。
                2. 檢定時請要求玩家手動擲骰 (請擲 D20...)。
                3. 結尾提供選項。
                【狀態】${JSON.stringify(state.stats)}
                【JSON】回應結尾附帶: \`\`\`json {"hp_change":0, "mp_change":0, "san_change":0, "mp_label":"法術位", "time":"...", "weather":"...", "location":"...", "add_item":"", "remove_item":"", "add_npc":"", "story_options":["A...","B..."]} \`\`\``;
                
                conversationHistory = [{role:"user", parts:[{text:sysPrompt}]}];
                await callAI(`請開始遊戲。`);
            } catch(e) { alert("啟動失敗: " + e.message); }
        }

        async function callAI(txt) {
            const log = document.getElementById('chat-log');
            log.innerHTML += `<div id="load-anim" class="msg gm">...</div>`; log.scrollTop=log.scrollHeight;
            conversationHistory.push({role:"user", parts:[{text:txt}]});
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${confirmedModel}:generateContent?key=${window.USER_API_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:conversationHistory})
                });
                const data = await res.json();
                document.getElementById('load-anim').remove();
                const aiTxt = data.candidates[0].content.parts[0].text;
                conversationHistory.push({role:"model", parts:[{text:aiTxt}]});
                processAIResponse(aiTxt);
            } catch(e) { document.getElementById('load-anim')?.remove(); addMsg("sys","Error: 請檢查網路或 Key"); }
        }

        function processAIResponse(txt) {
            const json = txt.match(/```json\s*([\s\S]*?)\s*```/);
            if(json) {
                try {
                    const u = JSON.parse(json[1]);
                    if(u.hp_change) state.hp=Math.max(0,Math.min(state.maxHp,state.hp+u.hp_change));
                    if(u.time) state.time=u.time; if(u.location) state.location=u.location;
                    if(u.story_options) renderOptions(u.story_options);
                    localStorage.setItem('rpg_autosave_v39_1', JSON.stringify({state, history:conversationHistory}));
                    txt = txt.replace(json[0],"");
                } catch(e){}
            }
            addMsg("gm", marked.parse(txt));
            updateUI();
        }

        function renderOptions(opts) {
            const c = document.getElementById('options-area'); c.innerHTML="";
            opts.forEach(o => {
                const b = document.createElement('button'); 
                b.style.cssText = "background:#3c4043;color:#e8eaed;border:1px solid #5f6368;padding:6px 12px;border-radius:16px;cursor:pointer;";
                b.innerText=o;
                b.onclick = () => { 
                    const i = document.getElementById('user-input'); 
                    i.value = o;
                    sendMsg();
                };
                c.appendChild(b);
            });
        }

        function updateUI() {
            document.getElementById('hp-txt').innerText = `${state.hp}/${state.maxHp}`;
            document.getElementById('hp-bar').style.width = `${(state.hp/state.maxHp)*100}%`;
            document.getElementById('location-display').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${state.location}`;
            document.getElementById('time-display').innerText = state.time;

            const map = {str:'disp-str', dex:'disp-dex', con:'disp-con', int:'disp-int', wis:'disp-wis', cha:'disp-cha'};
            for(let k in map) document.getElementById(map[k]).innerHTML = `<div class="attr-val">${state.stats[k]}</div><div class="attr-lbl">(${getModStr(state.stats[k])})</div>`;
        }

        function addMsg(r, h) { const l=document.getElementById('chat-log'); l.innerHTML+=`<div class="msg ${r}">${h}</div>`; l.scrollTop=l.scrollHeight; }
        window.sendMsg = () => { const i=document.getElementById('user-input'); if(!i.value.trim())return; addMsg("user",i.value); callAI(i.value); i.value=""; document.getElementById('options-area').innerHTML=""; };
        window.saveToCode = () => prompt("代碼:", btoa(encodeURIComponent(JSON.stringify({state, history:conversationHistory}))));
        window.loadFromCode = () => { try{ loadGameData(JSON.parse(decodeURIComponent(atob(document.getElementById('load-code').value)))); }catch(e){alert("無效");} };
        window.loadGameData = (d) => { state=d.state; conversationHistory=d.history; document.getElementById('setup-modal').classList.add('hidden'); updateUI(); if(!confirmedModel) detectModelAndStart().catch(()=>{}); };
        window.resetGame = () => { if(confirm("重置?")) { localStorage.removeItem('rpg_autosave_v39_1'); location.reload(); } };
    </script>
</body>
</html>
