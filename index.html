<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RPG Engine V71 (Mobile Optimized)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- V71: Mobile Drawer Design --- */
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #bb86fc; --success: #03dac6; --warn: #cf6679; --drawer-bg: #1a1a1a; }
        
        body { margin: 0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; font-size: 18px; }

        .app-container { display: flex; height: 100%; position: relative; }
        
        /* Sidebar: Desktop Default */
        .sidebar { width: 480px; background: #181818; border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; z-index: 20; transition: transform 0.3s ease; }
        
        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; z-index: 10; }

        /* Mobile Header (New) */
        .mobile-header { display: none; padding: 10px 15px; background: #1e1e1e; border-bottom: 1px solid #333; align-items: center; justify-content: space-between; }
        .hamburger-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 5px; }

        /* Overlay for Mobile Sidebar */
        .sidebar-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 15; }

        .panel-content { padding: 15px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--panel); padding: 16px; border-radius: 10px; border: 1px solid #333; }
        .card-header { display: flex; justify-content: space-between; font-size: 16px; font-weight: bold; color: #aaa; margin-bottom: 12px; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 8px; }
        
        .bar-wrap { background: #333; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 8px; }
        .bar-fill { height: 100%; transition: width 0.5s ease; }
        .stat-row { display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 5px; }

        .header-bar { padding: 15px 24px; background: #181818; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-size: 16px; color: #aaa; }
        
        .chat-log { flex: 1; padding: 20px; overflow-y: auto; scroll-behavior: smooth; font-size: 20px; line-height: 1.8; padding-bottom: 120px; }
        .msg { margin-bottom: 24px; max-width: 90%; padding: 20px 25px; border-radius: 12px; animation: fadeIn 0.3s; }
        .msg.gm { background: #252525; border-left: 6px solid var(--accent); color: #e5e5e5; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .msg.user { background: #3d2c5e; color: #fff; margin-left: auto; text-align: right; }
        .msg.sys { background: rgba(3, 218, 198, 0.1); color: var(--success); font-size: 16px; text-align: center; max-width: 95%; border: 1px dashed var(--success); margin: 15px auto; }
        
        .options-container { padding: 15px; background: #181818; display: flex; flex-wrap: wrap; gap: 12px; border-top: 1px solid #333; min-height: 70px; }
        .opt-btn { background: #2a2a2a; color: #ccc; border: 1px solid #444; padding: 12px 20px; border-radius: 25px; cursor: pointer; font-size: 16px; transition: 0.2s; text-align: left; }
        .opt-btn:hover { background: #333; color: var(--accent); border-color: var(--accent); transform: translateY(-2px); }

        .input-area { padding: 20px; background: #181818; display: flex; gap: 12px; }
        input[type="text"] { flex: 1; padding: 16px; background: #252525; border: 1px solid #444; color: white; border-radius: 30px; outline: none; padding-left: 24px; font-size: 18px; }
        .send-btn { width: 56px; height: 56px; border-radius: 50%; background: var(--accent); border: none; cursor: pointer; color: #000; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .ai-btn { width: 56px; height: 56px; border-radius: 50%; background: #333; border: 1px solid #555; cursor: pointer; color: #ffe082; display: flex; align-items: center; justify-content: center; font-size: 22px; transition: 0.2s; }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #1e1e1e; width: 90%; max-width: 550px; padding: 30px; border-radius: 12px; border: 1px solid #444; box-shadow: 0 10px 40px rgba(0,0,0,0.8); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-btn { width: 100%; padding: 16px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 18px; transition: 0.2s; }
        .modal-btn.secondary { background: #444; color: #fff; }
        .login-input { width: 100%; padding: 14px; background: #111; border: 1px solid #444; color: #fff; border-radius: 6px; margin-bottom: 12px; font-size: 16px; box-sizing: border-box; }

        /* Attribute Editor */
        .attr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .attr-main { text-align: center; background: #2a2a2a; padding: 8px; border-radius: 6px; }
        .attr-val { font-size: 24px; font-weight: bold; color: var(--accent); }
        .attr-mod { font-size: 16px; color: var(--success); font-weight: bold; }
        .attr-lbl { font-size: 14px; color: #aaa; }
        .attr-cn { font-size: 12px; color: #777; display: block; margin-top: 2px; }

        .attr-edit-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .attr-edit-box { background: #2a2a2a; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #333; }
        .attr-ctrl { display: flex; align-items: center; gap: 8px; }
        .attr-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: #444; color: #fff; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .attr-btn:hover { background: var(--accent); color: #000; }
        .range-input { width: 70px; background: #111; border: 1px solid #444; color: #fff; text-align: center; padding: 6px; border-radius: 4px; font-size: 16px; }

        .hidden { display: none !important; }
        .code-display { width: 100%; height: 200px; background: #111; color: #0f0; border: 1px solid #333; padding: 10px; font-family: monospace; font-size: 14px; resize: none; word-break: break-all; box-sizing: border-box; margin-bottom: 10px; }
        #log-content { background: #111; padding: 15px; border-radius: 8px; border: 1px solid #333; color: #ccc; line-height: 1.6; font-size: 16px; min-height: 200px; max-height: 400px; overflow-y: auto; }

        /* Dice Canvas */
        #dice-stage { width: 100%; min-height: 240px; background: #e8eaed; border-bottom: 1px solid #333; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #active-dice-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; width: 100%; padding: 15px; }
        .die { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; color: white; cursor: pointer; user-select: none; transition: transform 0.1s; position: relative; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .die:hover { transform: scale(1.1); }
        .die.rolling { animation: shake 0.5s infinite; }
        .die-d4 { background: #34a853; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); padding-top: 5px; height: 55px; }
        .die-d6 { background: #2ab7ca; border-radius: 4px; }
        .die-d8 { background: #a142f4; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .die-d10 { background: #f43f5e; clip-path: polygon(50% 0%, 100% 38%, 50% 100%, 0% 38%); }
        .die-d12 { background: #ea4335; clip-path: polygon(50% 0%, 95% 25%, 95% 75%, 50% 100%, 5% 75%, 5% 25%); }
        .die-d20 { background: #fb8c00; clip-path: polygon(30% 0%, 70% 0%, 100% 50%, 70% 100%, 30% 100%, 0% 50%); }
        .die-d100 { background: #607d8b; border-radius: 50%; padding-top: 0; display:flex; align-items:center; justify-content:center; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        #dice-total { position: absolute; bottom: 8px; right: 12px; font-size: 24px; color: #5f6368; font-weight: bold; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; }

        .dice-btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 8px; } 
        .d-btn { height: 44px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; font-size: 14px; background: #333; box-shadow: 0 3px 0 rgba(0,0,0,0.3); transition: transform 0.1s; }
        .d-btn:active { transform: scale(0.95); }
        .btn-d4 { border-bottom: 3px solid #34a853; } .btn-d6 { border-bottom: 3px solid #2ab7ca; } 
        .btn-d8 { border-bottom: 3px solid #a142f4; } .btn-d10 { border-bottom: 3px solid #f43f5e; } 
        .btn-d12 { border-bottom: 3px solid #ea4335; } .btn-d20 { border-bottom: 3px solid #fb8c00; }
        .btn-d100 { border-bottom: 3px solid #607d8b; background: #455a64; }

        .roll-trigger-btn { background: var(--accent); color: #000; border: none; padding: 8px 20px; border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .send-result-btn { background: var(--success); color: #000; border: none; padding: 8px 20px; border-radius: 14px; font-size: 16px; font-weight: bold; cursor: pointer; margin-left: 10px; display: none; }

        .list-item-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding: 12px 4px; }
        .list-btn { background: none; border: 1px solid #444; color: #aaa; border-radius: 4px; padding: 4px 10px; font-size: 16px; cursor: pointer; margin-left: 8px; }

        /* --- V71: Mobile Drawer & Fullscreen Chat --- */
        @media (max-width: 768px) {
            /* å´é‚Šæ¬„æ”¹ç‚ºæŠ½å±œ */
            .sidebar { 
                position: fixed; 
                top: 0; 
                left: -100%; /* é è¨­éš±è—åœ¨å·¦å´ */
                width: 85%; 
                height: 100%; 
                background: var(--drawer-bg); 
                border-right: 1px solid #333; 
                z-index: 100; /* é«˜æ–¼å…§å®¹ */
                transition: left 0.3s ease;
                box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            }
            .sidebar.active { left: 0; }

            /* é®ç½© */
            .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 90; }
            .sidebar-overlay.active { display: block; }

            /* æ‰‹æ©Ÿç‰ˆé ‚éƒ¨ Header */
            .mobile-header { display: flex; background: #181818; padding: 15px; border-bottom: 1px solid #333; align-items: center; justify-content: space-between; position: relative; z-index: 10; }
            
            /* Main Content: å…¨è¢å¹• */
            .main-content { width: 100%; height: 100%; flex: 1; }
            .header-bar { display: none; } /* éš±è—åŸæœ¬çš„ Header */
            
            /* Chat Area */
            .chat-log { padding-bottom: 140px; font-size: 22px; } /* åº•éƒ¨ç•™ç™½çµ¦å¤§è¼¸å…¥æ¡† */
            
            /* Input Area */
            .input-area { padding: 15px; background: #111; border-top: 1px solid #333; }
            input[type="text"] { font-size: 20px; padding: 18px; }
            .send-btn, .ai-btn { width: 55px; height: 55px; font-size: 24px; }

            /* Dice Grid in Drawer */
            .dice-btn-grid { grid-template-columns: repeat(4, 1fr); gap: 12px; }
            .attr-edit-grid { grid-template-columns: 1fr; } /* å–®æ¬„å±¬æ€§ */
        }
        
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 50% { transform: rotate(-10deg); } 75% { transform: rotate(5deg); } 100% { transform: rotate(0deg); } }
    </style>
</head>
<body>

    <div id="login-modal" class="modal">
        <div class="modal-box" style="width: 400px;">
            <h2 style="color:var(--accent); margin-top:0; text-align:center;">RPG Engine V71</h2>
            <div class="login-tabs" style="display:flex; margin-bottom:20px; border-bottom:1px solid #444;">
                <button id="tab-login" style="flex:1; background:none; border:none; color:#ccc; padding:10px; font-size:18px;" onclick="switchTab('login')">ç™»å…¥</button>
                <button id="tab-register" style="flex:1; background:none; border:none; color:#888; padding:10px; font-size:18px;" onclick="switchTab('register')">è¨»å†Š</button>
            </div>
            <input type="text" id="username" class="login-input" placeholder="å¸³è™Ÿ">
            <input type="password" id="password" class="login-input" placeholder="å¯†ç¢¼">
            <input type="password" id="confirm-password" class="login-input hidden" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼">
            <button id="btn-login-action" class="modal-btn" onclick="handleLoginAction()">ç™»å…¥</button>
        </div>
    </div>

    <div id="setup-modal" class="modal hidden">
        <div class="modal-box">
            <h2 style="color:var(--accent); margin-top:0;">ğŸ“– å»ºç«‹æ–°å†’éšª</h2>
            <textarea id="world-prompt" rows="3" style="width:100%; background:#111; color:#fff; border:1px solid #444; padding:12px; border-radius:6px; font-size:18px;" placeholder="ä¾‹å¦‚ï¼šå…‹è˜‡é­¯ç¥è©±ï¼Œæ·±æµ·ææ‡¼..."></textarea>
            <button class="modal-btn" onclick="startCharacterCreation()">ä¸‹ä¸€æ­¥</button>
        </div>
    </div>

    <div id="char-modal" class="modal hidden">
        <div class="modal-box">
            <h2 style="color:var(--success); margin-top:0;">ğŸ² å±¬æ€§åˆ†é…</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span style="color:#aaa; font-size:16px;">å±¬æ€§ç¸½å’Œï¼š</span>
                <div><input type="number" id="stat-min" class="range-input" value="72"> - <input type="number" id="stat-max" class="range-input" value="80"></div>
            </div>
            <div id="char-stats-editor" class="attr-edit-grid" style="margin: 20px 0;"></div>
            <div style="background:#111; padding:12px; border-radius:6px; font-size:16px; color:#aaa; margin-bottom:15px; text-align:center;">
                <div id="derived-stats">è¨ˆç®—ä¸­...</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="modal-btn" style="background:#444; color:#fff;" onclick="randomizeStats()">ğŸ² é‡æ“²</button>
                <button class="modal-btn" onclick="confirmStart()">âœ… é–‹å§‹</button>
            </div>
        </div>
    </div>

    <div id="sync-modal" class="modal hidden">
        <div class="modal-box">
            <h2 id="sync-title" style="color:var(--accent); margin-top:0;">ğŸ“¤ åŒ¯å‡º</h2>
            <textarea id="sync-code-area" class="code-display"></textarea>
            <div style="display:flex; gap:10px;">
                <button id="sync-action-btn" class="modal-btn" onclick="copySyncCode()">ğŸ“‹ è¤‡è£½</button>
                <button class="modal-btn" style="background:#444;" onclick="closeSyncModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="log-modal" class="modal hidden">
        <div class="modal-box">
            <h2 id="log-title" style="color:var(--accent); margin-top:0;">âœ¨ è³‡è¨Š</h2>
            <div id="log-content">è®€å–ä¸­...</div>
            <button class="modal-btn" style="background:#444;" onclick="document.getElementById('log-modal').classList.add('hidden')">é—œé–‰</button>
        </div>
    </div>

    <!-- Main UI Container -->
    <div class="app-container">
        
        <!-- V71: Mobile Header -->
        <div class="mobile-header">
            <button class="hamburger-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div style="font-size:18px; color:#ddd; font-weight:bold;">RPG Engine</div>
            <button class="hamburger-btn" onclick="generateLog()">
                <i class="fas fa-book"></i> <!-- Shortcut for Log -->
            </button>
        </div>

        <!-- Sidebar (Drawer on Mobile) -->
        <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <aside id="sidebar" class="sidebar">
            <!-- Mobile Sidebar Header -->
            <div class="mobile-header" style="display: flex; border-bottom: 1px solid #333; background: #222;">
                <span style="color:#aaa;">è§’è‰²é¢æ¿</span>
                <button class="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
            </div>

            <div id="dice-stage">
                <div id="active-dice-area"><div style="color:#888; font-size:16px;">é»æ“ŠæŒ‰éˆ•åŠ å…¥éª°å­</div></div>
                <div id="dice-total"></div>
            </div>
            
            <div class="panel-content">
                <!-- Menu Actions (Moved here for mobile access) -->
                <div class="card" style="padding:10px; display:flex; gap:10px; overflow-x:auto;">
                    <button class="menu-btn" onclick="openSyncModal('export')" style="background:none;border:none;color:#ccc;font-size:24px;">ğŸ“¤</button>
                    <button class="menu-btn" onclick="openSyncModal('import')" style="background:none;border:none;color:#ccc;font-size:24px;">ğŸ“¥</button>
                    <button class="menu-btn" onclick="saveToAccount()" style="background:none;border:none;color:#aaa;font-size:24px;">ğŸ’¾</button>
                    <button class="menu-btn" onclick="logout()" style="background:none;border:none;color:#f55;font-size:24px;margin-left:auto;">ğŸšª</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span>éª°å­ç›¤</span>
                        <div>
                            <button class="roll-trigger-btn" onclick="roll2DDice()">ğŸ² æ“²éª°</button>
                            <button id="btn-send-dice" class="send-result-btn" onclick="sendDiceResult()">ğŸ“¤ ç™¼é€</button>
                        </div>
                    </div>
                    <div class="dice-btn-grid">
                        <button class="d-btn btn-d4" onclick="add2DDie(4)">D4</button>
                        <button class="d-btn btn-d6" onclick="add2DDie(6)">D6</button>
                        <button class="d-btn btn-d8" onclick="add2DDie(8)">D8</button>
                        <button class="d-btn btn-d10" onclick="add2DDie(10)">D10</button>
                        <button class="d-btn btn-d12" onclick="add2DDie(12)">D12</button>
                        <button class="d-btn btn-d20" onclick="add2DDie(20)">D20</button>
                        <button class="d-btn btn-d100" onclick="add2DDie(100)" style="grid-column: span 2;">D100</button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">ç‹€æ…‹</div>
                    <div class="stat-row"><span>HP</span> <span id="hp-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="hp-bar" class="bar-fill" style="width:100%; background:#cf6679;"></div></div>
                    <div class="stat-row"><span id="mp-label">MP</span> <span id="mp-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="mp-bar" class="bar-fill" style="width:100%; background:#03dac6;"></div></div>
                    <div class="stat-row"><span style="color:#bb86fc;">SAN (%)</span> <span id="san-txt">--/--</span></div>
                    <div class="bar-wrap"><div id="san-bar" class="bar-fill" style="width:100%; background:#bb86fc;"></div></div>
                </div>
                
                <div class="card">
                    <div class="card-header">å±¬æ€§ (èª¿æ•´å€¼)</div>
                    <div class="attr-grid">
                        <div class="attr-main"><div class="attr-lbl">STR</div><div class="attr-cn">åŠ›é‡</div><div id="disp-str"></div></div>
                        <div class="attr-main"><div class="attr-lbl">DEX</div><div class="attr-cn">æ•æ·</div><div id="disp-dex"></div></div>
                        <div class="attr-main"><div class="attr-lbl">CON</div><div class="attr-cn">é«”è³ª</div><div id="disp-con"></div></div>
                        <div class="attr-main"><div class="attr-lbl">INT</div><div class="attr-cn">æ™ºåŠ›</div><div id="disp-int"></div></div>
                        <div class="attr-main"><div class="attr-lbl">WIS</div><div class="attr-cn">æ„ŸçŸ¥</div><div id="disp-wis"></div></div>
                        <div class="attr-main"><div class="attr-lbl">CHA</div><div class="attr-cn">é­…åŠ›</div><div id="disp-cha"></div></div>
                    </div>
                </div>
                <div class="card"><div class="card-header">äººç‰©é—œä¿‚</div><div id="npc-list" style="font-size:16px; color:#aaa; padding:5px;">ç„¡</div></div>
                <div class="card" style="flex:1"><div class="card-header">ç‰©å“ (Inventory)</div><div id="inv-list" style="font-size:16px; color:#aaa; padding:5px;">ç„¡</div></div>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Desktop Header (Hidden on Mobile) -->
            <div class="header-bar" style="display: flex; @media(max-width:768px){display:none;}">
                <div class="header-info">
                    <span id="time-display" style="color:#aaa;">åˆå§‹</span>
                </div>
                <div>
                    <button class="menu-btn" onclick="generateLog()" style="background:none;border:none;color:#ffe082;font-size:20px;margin-right:10px;" title="æ—¥èªŒ">âœ¨</button>
                    <button class="menu-btn" onclick="openSyncModal('export')" style="background:none;border:none;color:#ccc;font-size:20px;margin-right:10px;">ğŸ“¤</button>
                    <button class="menu-btn" onclick="openSyncModal('import')" style="background:none;border:none;color:#ccc;font-size:20px;margin-right:10px;">ğŸ“¥</button>
                    <button class="menu-btn" onclick="saveToAccount()" style="background:none;border:none;color:#aaa;font-size:20px;margin-right:10px;">â˜ï¸</button>
                    <button class="menu-btn" onclick="logout()" style="background:none;border:none;color:#f55;font-size:20px;">ğŸšª</button>
                </div>
            </div>
            
            <div id="chat-log" class="chat-log"><div class="msg gm">ç³»çµ±å°±ç·’ã€‚</div></div>
            <div id="options-area" class="options-container"></div>
            
            <div class="input-area">
                <button class="ai-btn" onclick="generateSuggestions()" title="AI è¡Œå‹•å»ºè­°">âœ¨</button>
                <input type="text" id="user-input" placeholder="è¼¸å…¥è¡Œå‹•..." autocomplete="off">
                <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script>
        // --- V71: Mobile Responsive Drawer + V70 Logic ---
        let confirmedModel = ""; 
        let conversationHistory = []; 
        let diceBag = []; 
        let lastDiceTotal = 0;
        let currentUser = null; 

        const initialState = { 
            hp: 10, maxHp: 10, mp: 10, maxMp: 10, mpLabel: "MP", 
            san: 90, maxSan: 100, 
            stats: { str:10, dex:10, con:10, int:10, wis:10, cha:10 }, 
            inventory: [], npcs: [], story_options: [], 
            time: "èµ·å§‹", location: "æœªçŸ¥", worldPrompt: "" 
        };
        let state = JSON.parse(JSON.stringify(initialState));
        const ATTR_MAP = { str:'åŠ›é‡', dex:'æ•æ·', con:'é«”è³ª', int:'æ™ºåŠ›', wis:'æ„ŸçŸ¥', cha:'é­…åŠ›' };
        const ACCOUNTS_KEY = 'rpg_local_accounts_v71'; 

        function safeEncode(str) { return window.btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1))); }
        function safeDecode(str) { return decodeURIComponent(Array.prototype.map.call(window.atob(str), c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }

        window.onload = function() {
            document.getElementById('user-input').addEventListener('keypress', function (e) { if (e.key === 'Enter') sendMsg(); });
            const cachedKey = localStorage.getItem('my_gemini_key_v1');
            if (cachedKey) window.USER_API_KEY = cachedKey;
        };

        // --- V71: Mobile Toggle Logic ---
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            // Check if we are on mobile
            if (window.innerWidth <= 768) {
                if (sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                } else {
                    sidebar.classList.add('active');
                    overlay.classList.add('active');
                }
            }
        };

        // --- Account Logic ---
        let currentTab = 'login';
        window.switchTab = function(tab) {
            currentTab = tab;
            document.getElementById('tab-login').style.color = tab === 'login' ? '#bb86fc' : '#888';
            document.getElementById('tab-register').style.color = tab === 'register' ? '#bb86fc' : '#888';
            document.getElementById('btn-login-action').innerText = tab === 'login' ? 'ç™»å…¥' : 'è¨»å†Š';
            if(tab === 'register') {
                document.getElementById('confirm-password').classList.remove('hidden');
                document.getElementById('username').value = ''; document.getElementById('password').value = '';
            } else { document.getElementById('confirm-password').classList.add('hidden'); }
        };

        window.handleLoginAction = function() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if(!u || !p) return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
            const db = JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '{}');

            if (currentTab === 'register') {
                const p2 = document.getElementById('confirm-password').value.trim();
                if(p !== p2) return alert("å¯†ç¢¼ä¸ä¸€è‡´");
                if(db[u]) return alert("å¸³è™Ÿå·²å­˜åœ¨");
                currentUser = u;
                sessionStorage.setItem('temp_pass', p);
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('setup-modal').classList.remove('hidden');
            } else {
                if(!db[u] || db[u].password !== p) return alert("ç™»å…¥å¤±æ•—");
                currentUser = u;
                loadGameData(db[u].data);
                document.getElementById('login-modal').classList.add('hidden');
            }
        };

        window.saveToAccount = function() {
            if(!currentUser) return alert("æœªç™»å…¥");
            const db = JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '{}');
            const pass = sessionStorage.getItem('temp_pass') || (db[currentUser] ? db[currentUser].password : null);
            if(!pass) return alert("é©—è­‰å¤±æ•—");
            db[currentUser] = { password: pass, data: { state, history: conversationHistory }, updated: new Date().toLocaleString() };
            localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(db));
            alert(`å·²å„²å­˜ï¼(${currentUser})`);
        };

        // --- Sync ---
        window.openSyncModal = function(mode) {
            if(mode === 'export') {
                if(!currentUser) return alert("è«‹å…ˆç™»å…¥");
                const db = JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '{}');
                if(!db[currentUser]) return alert("ç„¡å­˜æª”");
                const exportData = { user: currentUser, pass: db[currentUser].password, data: db[currentUser].data };
                document.getElementById('sync-title').innerText = "ğŸ“¤ åŒ¯å‡ºä»£ç¢¼";
                document.getElementById('sync-code-area').value = safeEncode(JSON.stringify(exportData));
                document.getElementById('sync-code-area').readOnly = true;
                document.getElementById('sync-action-btn').innerText = "ğŸ“‹ è¤‡è£½";
                document.getElementById('sync-action-btn').onclick = copySyncCode;
            } else {
                document.getElementById('sync-title').innerText = "ğŸ“¥ åŒ¯å…¥ä»£ç¢¼";
                document.getElementById('sync-code-area').value = "";
                document.getElementById('sync-code-area').readOnly = false;
                document.getElementById('sync-action-btn').innerText = "ğŸ“¥ åŒ¯å…¥";
                document.getElementById('sync-action-btn').onclick = runImport;
            }
            document.getElementById('sync-modal').classList.remove('hidden');
        };
        window.closeSyncModal = function() { document.getElementById('sync-modal').classList.add('hidden'); };
        window.copySyncCode = function() {
            const el = document.getElementById('sync-code-area'); el.select();
            document.execCommand('copy'); try{navigator.clipboard.writeText(el.value);}catch(e){}
            alert("å·²è¤‡è£½");
        };
        window.runImport = function() {
            const code = document.getElementById('sync-code-area').value.trim();
            if(!code) return;
            try {
                const json = safeDecode(code);
                const importData = JSON.parse(json);
                if(!importData.user) throw new Error("æ ¼å¼éŒ¯");
                if(confirm(`åŒ¯å…¥ [${importData.user}]?`)) {
                    const db = JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '{}');
                    db[importData.user] = { password: importData.pass, data: importData.data, updated: new Date().toLocaleString() + " (Import)" };
                    localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(db));
                    currentUser = importData.user;
                    loadGameData(importData.data);
                    document.getElementById('login-modal').classList.add('hidden');
                    closeSyncModal();
                    alert("åŒ¯å…¥æˆåŠŸ");
                }
            } catch(e) { alert("åŒ¯å…¥å¤±æ•—:" + e.message); }
        };
        window.logout = function() { if(confirm("ç™»å‡º?")) location.reload(); };

        // --- Attribute Setup ---
        window.startCharacterCreation = function() {
            state.worldPrompt = document.getElementById('world-prompt').value.trim() || "D&D 5e";
            if(!window.USER_API_KEY) {
                const inputKey = prompt("API Key:");
                if(inputKey) { window.USER_API_KEY = inputKey; localStorage.setItem('my_gemini_key_v1', inputKey); }
                else return alert("éœ€è¦Key");
            }
            randomizeStats();
            document.getElementById('setup-modal').classList.add('hidden');
            document.getElementById('char-modal').classList.remove('hidden');
        }

        window.randomizeStats = function() {
            let min = parseInt(document.getElementById('stat-min').value)||72;
            let max = parseInt(document.getElementById('stat-max').value)||80;
            if (min>max) [min,max]=[max,min];
            
            const target = Math.floor(Math.random()*(max-min+1))+min;
            const keys=['str','dex','con','int','wis','cha'];
            let base = target < 48 ? 1 : 8;
            keys.forEach(k => state.stats[k] = base);
            let pts = target - (base * 6);
            let safe = 0;
            while(pts > 0 && safe < 2000){ 
                const k = keys[Math.floor(Math.random()*6)]; 
                if(state.stats[k] < 18){ state.stats[k]++; pts--; } 
                safe++;
            }
            renderStatEditor();
        }

        window.adjustStat = function(k, d) { 
            state.stats[k] += d; 
            if(state.stats[k] < 1) state.stats[k] = 1; 
            renderStatEditor(); 
        }
        
        function getMod(v) { return Math.floor((v-10)/2); }
        function getModStr(v) { const m=getMod(v); return m>=0?`+${m}`:`${m}`; }

        function renderStatEditor() {
            const currentSum = Object.values(state.stats).reduce((a,b)=>a+b, 0);
            let h=''; 
            for(let k in state.stats){
                h += `<div class="attr-edit-box">
                        <div class="attr-lbl" style="width:50px;">${k.toUpperCase()}<br><span style="font-size:12px;color:#888;">${ATTR_MAP[k]}</span></div>
                        <div class="attr-ctrl">
                            <button class="attr-btn" onclick="adjustStat('${k}',-1)">-</button>
                            <div class="attr-val">${state.stats[k]}</div>
                            <button class="attr-btn" onclick="adjustStat('${k}',1)">+</button>
                        </div>
                        <div style="font-size:16px;color:var(--success);width:35px;text-align:right;">${getModStr(state.stats[k])}</div>
                      </div>`;
            }
            document.getElementById('char-stats-editor').innerHTML=h;
            state.maxHp = 10 + getMod(state.stats.con); state.hp = state.maxHp;
            
            state.maxMp = Math.max(1, getMod(state.stats.int) + getMod(state.stats.wis));
            state.mp = state.maxMp;
            state.maxSan = 100; state.san = 90;
            document.getElementById('derived-stats').innerHTML=`ç¸½å’Œ: ${currentSum} | HP: ${state.maxHp}`;
        }

        window.confirmStart = async function() {
            document.getElementById('char-modal').classList.add('hidden');
            updateUI();
            addMsg("sys","æ­£åœ¨åˆå§‹åŒ–ä¸–ç•Œ (V71 Mobile)...");
            await detectModelAndStart();
        }

        // --- Core API ---
        async function detectModelAndStart() {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${window.USER_API_KEY}`);
                const data = await res.json();
                const m = (data.models||[]).find(x=>x.name.includes("gemini-1.5-flash")||x.name.includes("gemini-pro"));
                if(!m) throw new Error("API Key ç„¡æ•ˆ");
                confirmedModel = m.name.replace("models/","");
                
                const sysPrompt = `ä½ æ˜¯ä¸€å€‹ã€æ¦®ç²æ–‡å­¸ççš„é»‘æš—å¥‡å¹»å°èªªå®¶ã€‘ï¼ŒåŒæ™‚ä¹Ÿæ˜¯ã€åš´æ ¼éµå®ˆè¦å‰‡çš„ D&D 5e DMã€‘ã€‚
ã€æ–‡å­¸æ€§ã€‘
1. **æ‹’çµ•è€å¥—**ï¼šç¦æ­¢ç”¨ã€Œé ­ç—›é†’ä¾†ã€ã€ã€Œå››å‘¨æ¼†é»‘ã€é–‹å ´ã€‚
2. **æ²‰æµ¸æ„Ÿ**ï¼šå¤§é‡æå¯«æ°£å‘³ã€è§¸æ„Ÿã€å…‰å½±ã€‚
3. **Show, Don't Tell**ã€‚

ã€è¦å‰‡ã€‘
1. **ç¦æ­¢ä»£æ“²**ï¼šDM çµ•ä¸çµ¦å‡ºå‚·å®³/æ²»ç™‚æ•¸å€¼æˆ–åˆ¤å®šçµæœã€‚
   - éŒ¯èª¤ï¼šã€Œä½ é€ æˆ 5 é»å‚·å®³ã€‚ã€
   - æ­£ç¢ºï¼šã€Œæ”»æ“Šå‘½ä¸­ï¼è«‹æŠ•æ“² **1d8+2** è¨ˆç®—å‚·å®³ã€‚ã€
2. **æª¢å®šæ ¼å¼ (å¿…å‚™)**ï¼š
   - 1é¡† D20
   - æª¢å®šåç¨± (æ„ŸçŸ¥(å¯Ÿè¦º))
   - ä¿®æ­£å€¼ (+X)
   - DC (15)
   - ç¯„ä¾‹ï¼šã€Œè«‹æŠ•æ“² **D20** é€²è¡Œ **[æ•æ· (éš±åŒ¿)]** æª¢å®š (ä¿®æ­£å€¼ +3, DC 14)ã€‚ã€

ã€å¤šæ¨£éª°å­ã€‘
ç©æ¥µä½¿ç”¨ D4-D12 æ±ºå®šç¨‹åº¦ã€æ•¸é‡ã€‚
SAN ç³»çµ±ï¼šD100 æª¢å®šã€‚

ã€ç•¶å‰ç‹€æ…‹ã€‘${JSON.stringify(state.stats)}

ã€è¼¸å‡ºæ ¼å¼ã€‘
JSONåœ¨çµå°¾ï¼š
\`\`\`json
{
  "hp_change": 0,
  "mp_change": 0,
  "mp_label": "MP",
  "san_change": 0,
  "add_item": "",
  "remove_item": "",
  "time": "...",
  "location": "...",
  "npcs": [],
  "story_options": ["é¸é …1", "é¸é …2", "é¸é …3"]
}
\`\`\`
ä¸–ç•Œè§€ï¼šã€Œ${state.worldPrompt}ã€ã€‚è«‹ä»¥å‰µæ„æ–¹å¼é–‹å ´ã€‚`;
                
                conversationHistory = [{role:"user", parts:[{text:sysPrompt}]}, {role:"model", parts:[{text:"éµå‘½ï¼Œæˆ‘å°‡ç·¨ç¹”é€™æ®µå†’éšªã€‚"}]}];
                await callAI(`(å†’éšªé–‹å§‹)`);
                saveToAccount();
            } catch(e) { alert("å•Ÿå‹•å¤±æ•—: " + e.message); }
        }

        async function callAI(txt) {
            const log = document.getElementById('chat-log');
            log.innerHTML += `<div id="load-anim" class="msg gm">DM æ­£åœ¨æ§‹æ€...</div>`; log.scrollTop=log.scrollHeight;
            
            const modInfo = Object.keys(state.stats).map(k => `${k.toUpperCase()}: ${getModStr(state.stats[k])}`).join(', ');
            let sanStatus = "æ­£å¸¸";
            if (state.san < 20) sanStatus = "ç˜‹ç‹‚"; else if (state.san < 50) sanStatus = "ä¸ç©©";
            const items = state.inventory.length > 0 ? state.inventory.join(', ') : "ç„¡";

            const context = `[éš±è—è³‡è¨Š: HP=${state.hp}, MP=${state.mp}, SAN=${state.san}/100, ç‰©å“=[${items}], ä¿®æ­£å€¼={${modInfo}}, æ™‚é–“=${state.time}, åœ°é»=${state.location}]`;
            
            conversationHistory.push({role:"user", parts:[{text: txt + "\n" + context}]});

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${confirmedModel}:generateContent?key=${window.USER_API_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({ contents: conversationHistory, generationConfig: { temperature: 0.9 } })
                });
                const data = await res.json();
                document.getElementById('load-anim').remove();
                if (data.error) throw new Error(data.error.message);
                const aiTxt = data.candidates[0].content.parts[0].text;
                conversationHistory.push({role:"model", parts:[{text:aiTxt}]});
                processAIResponse(aiTxt);
            } catch(e) {
                document.getElementById('load-anim')?.remove();
                addMsg("sys", `API éŒ¯èª¤: ${e.message}`);
            }
        }

        function processAIResponse(txt) {
            const jsonMatch = txt.match(/```json\s*([\s\S]*?)\s*```/);
            let displayTxt = txt;
            if(jsonMatch) {
                try {
                    const u = JSON.parse(jsonMatch[1]);
                    if(u.hp_change) state.hp = Math.max(0, Math.min(state.maxHp, state.hp + u.hp_change));
                    if(u.mp_change) state.mp = Math.max(0, Math.min(state.maxMp, state.mp + u.mp_change));
                    if(u.mp_label) state.mpLabel = u.mp_label;
                    if(u.san_change) state.san = Math.max(0, Math.min(100, state.san + u.san_change));
                    
                    if(u.add_item && u.add_item.trim() !== "") state.inventory.push(u.add_item);
                    if(u.remove_item && u.remove_item.trim() !== "") {
                        const idx = state.inventory.indexOf(u.remove_item);
                        if(idx > -1) state.inventory.splice(idx, 1);
                    }

                    if(u.time) state.time = u.time; 
                    if(u.location) state.location = u.location;
                    if(u.npcs) state.npcs = u.npcs;
                    
                    if(u.story_options) {
                        state.story_options = u.story_options;
                        renderOptions(u.story_options);
                    }
                    displayTxt = txt.replace(jsonMatch[0], "");
                } catch(e){}
            }
            addMsg("gm", marked.parse(displayTxt));
            updateUI();
        }

        window.renderOptions = function(opts) {
            const c = document.getElementById('options-area'); c.innerHTML="";
            if(!opts) return;
            opts.forEach(o => {
                const b = document.createElement('button'); b.className='opt-btn'; b.innerText=o;
                b.onclick = () => { 
                    const i = document.getElementById('user-input'); 
                    if (i.value.trim().length > 0) {
                        i.value = i.value + " " + o;
                    } else {
                        i.value = o;
                    }
                    i.focus();
                };
                c.appendChild(b);
            });
        }

        window.loadGameData = function(d) {
            state = d.state; conversationHistory = d.history;
            const log = document.getElementById('chat-log'); log.innerHTML = '';
            conversationHistory.forEach(msg => {
                if(msg.role === 'user' && msg.parts) {
                    let txt = msg.parts[0].text.split('\n[éš±è—è³‡è¨Š')[0];
                    if(!txt.includes("System Prompt")) addMsg('user', txt);
                }
                if(msg.role === 'model' && msg.parts) {
                     let txt = msg.parts[0].text;
                     if(!txt.includes("éµå‘½")) { txt = txt.replace(/```json[\s\S]*?```/g, ''); addMsg('gm', marked.parse(txt)); }
                }
            });
            if(state.story_options) renderOptions(state.story_options);
            updateUI();
            addMsg("sys", `æ­¡è¿å›ä¾†ï¼Œ${currentUser}ã€‚`);
            fetchModelOnly();
        };

        async function fetchModelOnly() {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${window.USER_API_KEY}`);
                const data = await res.json();
                const m = (data.models||[]).find(x=>x.name.includes("gemini-1.5-flash")||x.name.includes("gemini-pro"));
                if(m) confirmedModel = m.name.replace("models/","");
            } catch(e) {}
        }

        window.updateUI = function() {
            document.getElementById('hp-txt').innerText = `${state.hp}/${state.maxHp}`;
            document.getElementById('hp-bar').style.width = `${(state.hp/state.maxHp)*100}%`;
            document.getElementById('mp-label').innerText = state.mpLabel || "MP";
            document.getElementById('mp-txt').innerText = `${state.mp}/${state.maxMp}`;
            document.getElementById('mp-bar').style.width = `${(state.mp/state.maxMp)*100}%`;
            
            document.getElementById('san-txt').innerText = `${state.san}/100`;
            document.getElementById('san-bar').style.width = `${state.san}%`;
            
            const invDiv = document.getElementById('inv-list');
            if(state.inventory && state.inventory.length > 0) {
                invDiv.innerHTML = state.inventory.map(i => `
                    <div class="list-item-row">
                        <span>${i}</span>
                        <button class="list-btn" onclick="inspectItem('${i}')">âœ¨</button>
                    </div>`).join('');
            } else invDiv.innerHTML = "èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ";

            const npcDiv = document.getElementById('npc-list');
            if(state.npcs && state.npcs.length > 0) {
                npcDiv.innerHTML = state.npcs.map(n => {
                    const name = typeof n === 'string' ? n : (n.name || 'æœªçŸ¥');
                    const rel = typeof n === 'string' ? '' : (n.rel || '');
                    return `
                    <div class="list-item-row">
                        <div>
                            <span style="color:#bb86fc">${name}</span>
                            <span style="color:#888;font-size:14px;margin-left:5px;">${rel}</span>
                        </div>
                        <button class="list-btn" onclick="inspectNPC('${name}')">ğŸ”</button>
                    </div>`;
                }).join('');
            } else { npcDiv.innerHTML = "ç„¡é‡è¦ NPC"; }

            for(let k in state.stats){ const el = document.getElementById(`disp-${k}`); if(el) el.innerHTML = `<div class="attr-val">${state.stats[k]}</div><div class="attr-mod">(${getModStr(state.stats[k])})</div>`; }
        }

        window.addMsg = function(r, h) { const l=document.getElementById('chat-log'); l.innerHTML+=`<div class="msg ${r}">${h}</div>`; l.scrollTop=l.scrollHeight; }
        window.sendMsg = function() { const i=document.getElementById('user-input'); if(!i.value.trim()) return; addMsg("user",i.value); callAI(i.value); i.value=""; document.getElementById('options-area').innerHTML=""; };

        // Dice
        window.add2DDie = function(sides) { diceBag.push({ sides: sides, val: sides }); renderDice(); document.getElementById('btn-send-dice').style.display = 'none'; }
        window.removeDie = function(index) { diceBag.splice(index, 1); renderDice(); document.getElementById('btn-send-dice').style.display = 'none'; }
        window.renderDice = function() {
            const area = document.getElementById('active-dice-area'); area.innerHTML = ""; let total = 0;
            diceBag.forEach((d, idx) => { const div = document.createElement('div'); div.className = d.sides===100 ? `die die-d100` : `die die-d${d.sides}`; div.innerText = d.val; div.onclick = () => removeDie(idx); area.appendChild(div); total += d.val; });
            if(diceBag.length > 0) { document.getElementById('dice-total').innerText = `ç¸½å’Œ: ${total}`; document.getElementById('dice-total').style.display = 'block'; }
            else { document.getElementById('dice-total').style.display = 'none'; area.innerHTML = '<div style="color:#888; font-size:16px;">é»æ“ŠæŒ‰éˆ•åŠ å…¥éª°å­</div>'; }
        }
        window.roll2DDice = function() {
            if(diceBag.length === 0) return;
            const els = document.querySelectorAll('.die'); els.forEach(e => e.classList.add('rolling'));
            setTimeout(() => {
                let total = 0; diceBag.forEach(d => { d.val = Math.floor(Math.random() * d.sides) + 1; total += d.val; });
                renderDice(); els.forEach(e => e.classList.remove('rolling')); lastDiceTotal = total; document.getElementById('btn-send-dice').style.display = 'inline-block';
            }, 500);
        }
        window.sendDiceResult = function() {
            if(diceBag.length === 0) return;
            const detail = diceBag.map(d => `D${d.sides}(${d.val})`).join('+');
            addMsg("sys", `æ“²éª°çµæœ: ${detail} = ${lastDiceTotal}`);
            callAI(`[ç³»çµ±è³‡è¨Š] ç©å®¶æ“²éª°çµæœ: ${detail} = ç¸½å’Œ ${lastDiceTotal}ã€‚è«‹æ ¹æ“šæ­¤çµæœèˆ‡ç•¶å‰æƒ…å¢ƒé€²è¡Œåˆ¤å®šã€‚`);
            document.getElementById('btn-send-dice').style.display = 'none'; diceBag = []; renderDice();
        }

        // --- AI Features ---
        async function callGeminiAux(prompt, title) {
            if(!confirmedModel) return alert("å°šæœªé–‹å§‹éŠæˆ²");
            document.getElementById('log-modal').classList.remove('hidden');
            document.getElementById('log-title').innerText = title;
            document.getElementById('log-content').innerText = "Gemini æ­£åœ¨åˆ†æä¸­...";
            
            try {
                const tempHistory = [...conversationHistory, {role:"user", parts:[{text: prompt}]}];
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${confirmedModel}:generateContent?key=${window.USER_API_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({ contents: tempHistory })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                document.getElementById('log-content').innerHTML = marked.parse(text);
            } catch(e) {
                document.getElementById('log-content').innerText = "åˆ†æå¤±æ•—: " + e.message;
            }
        }

        window.generateLog = function() {
            const prompt = "è«‹æ ¹æ“šä¸Šè¿°å°è©±ç´€éŒ„ï¼Œç‚ºç©å®¶æ’°å¯«ä¸€ä»½ã€Œå†’éšªæ—¥èªŒæ‘˜è¦ã€ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œä»¥æ¢åˆ—å¼é‡é»å›é¡§ç›®å‰çš„é—œéµåŠ‡æƒ…ã€é‡åˆ°çš„ NPC èˆ‡å¾…è¾¦äº‹é …ã€‚";
            callGeminiAux(prompt, "âœ¨ å†’éšªæ—¥èªŒæ‘˜è¦");
        };

        window.inspectItem = function(name) {
            const prompt = `è«‹è©³ç´°é‘‘å®šç‰©å“ã€Œ${name}ã€ã€‚æè¿°å®ƒçš„å¤–è§€ç´°ç¯€ã€æè³ªã€æ­·å²æ·µæºä»¥åŠå¯èƒ½éš±è—çš„é­”æ³•å¾®å…‰æˆ–è©›å’’ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œå¸¶æœ‰ç¥ç¥•æ„Ÿã€‚`;
            callGeminiAux(prompt, `âœ¨ ç‰©å“é‘‘å®š: ${name}`);
        };

        window.inspectNPC = function(name) {
            const prompt = `è«‹æ ¹æ“šåŠ‡æƒ…æ·±åº¦å´å¯« NPCã€Œ${name}ã€ã€‚æè¿°å…¶å¤–è²Œç‰¹å¾µã€æ€§æ ¼é—œéµå­—ã€èªªè©±æ–¹å¼çš„ç‰¹é»ï¼Œä¸¦æ¨æ¸¬ä¸€å€‹ä¸ç‚ºäººçŸ¥çš„ç§˜å¯†æˆ–å‹•æ©Ÿã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ã€‚`;
            callGeminiAux(prompt, `ğŸ” äººç‰©å´å¯«: ${name}`);
        };

        window.generateSuggestions = async function() {
            if(!confirmedModel) return alert("å°šæœªé–‹å§‹éŠæˆ²");
            const btn = document.querySelector('.ai-btn');
            const originalText = btn.innerText;
            btn.innerText = "â³";
            
            try {
                const prompt = "è«‹æ ¹æ“šç›®å‰åŠ‡æƒ…ï¼Œæä¾› 3 å€‹ç°¡çŸ­ã€æœ‰å‰µæ„çš„è¡Œå‹•å»ºè­°çµ¦ç©å®¶ã€‚æ ¼å¼ï¼šåƒ…åˆ—å‡º 3 å€‹é¸é …ï¼Œæ¯å€‹é¸é …ä¸€è¡Œï¼Œä¸è¦æœ‰ç·¨è™Ÿæˆ–é¡å¤–æ–‡å­—ã€‚";
                const tempHistory = [...conversationHistory, {role:"user", parts:[{text: prompt}]}];
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${confirmedModel}:generateContent?key=${window.USER_API_KEY}`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({ contents: tempHistory })
                });
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                const suggestions = text.split('\n').filter(l => l.trim() !== '').slice(0, 3);
                renderOptions(suggestions);
            } catch(e) {
                alert("ç”Ÿæˆå»ºè­°å¤±æ•—");
            } finally {
                btn.innerText = originalText;
            }
        };
    </script>
</body>
</html>
